<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport"
	content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<meta name="format-detection" content="telephone=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<title>API</title>
<script type="text/javascript"> 
	(function(){"use strict";var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F=[].slice,G={}.hasOwnProperty,H=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};for(y=this,a=function(b){return b instanceof a?b:this instanceof a?void(this._wrapped=b):new a(b)},a.now=function(){return(Date.now||function(){return(new Date).getTime()})()},a.script_time=a.now(),C=0,a.CRLF="\r\n",B=a,r={log:1,info:2,warn:3,error:4,none:5},f={c:!1},t={ctxPath:"",basePath:"",logger:r.log,toStringEvent:!1,toStringShowType:!0,logPrefix:function(b){return">> "+b+" ["+a.when.log()+"]"},dateMask:{"default":"yyyy-mm-dd HH:MM:ss",log:"yyyy-mm-dd HH:MM:ss l",day:"yyyy-mm-dd",time:"HH:MM:ss",week:"dddd"},dateI18n:{day:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],month:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","January","February","March","April","May","June","July","August","September","October","November","December"]}},c=Array.prototype.forEach,b=Array.prototype.filter,e=!1,m=encodeURIComponent,a.each=function(b,d,f){var g,h,i,j,k,l;if(null===b)return b;if(c&&b.forEach===c)b.forEach(d,f);else if(b.length===+b.length)for(g=0,k=b.length;;){if(k>g||d.call(f,b[g],g,b)===e)break;g++}else for(j=a.keys(b),h=0,l=j.length;l>h;h++)if(i=j[h],d.call(f,b[i],i,b)===e)return;return b},a.filter=function(c,d,e){var f;return f=[],null===c?f:b&&c.filter===b?c.filter(d,e):(a.each(c,function(a,b,c){d.call(e,a,b,c)&&f.push({index:a})}),f)},a.extend=function(b){return a.each(a.slice(arguments,1),function(a){var c;if(a)for(c in a)b[c]=a[c]}),b},a.capitalize=function(a){return a.charAt(0).toUpperCase()+a.slice(1)},l=function(b,c,d,e){return function(c){return b[e?e+a.capitalize(c):c]=d}(c)},a.type=function(a,b){var c;return null==b&&(b=!1),c=Object.prototype.toString.call(a),b?c:c.slice(8,-1)},i=["Arguments","Array","Boolean","Date","Error","Function","Null","Number","Object","RegExp","String","Undefined","global"],d=function(b){return l(B,b,function(c){return b===a.type(c)},"is")},o=0,q=i.length;q>o;o++)D=i[o],d(D);a.isFunc=a.isFunction,a.isWin=a.isGlobal,a.isJson=function(b){return"object"==typeof b&&a.isObject(b)&&!b.length},a.isEvent=function(b){return!(a.isNull(b)||a.isUndefined(b)||a.isUndefined(b.altKey)&&a.isUndefined(b.preventDefault))},a.isBlank=function(){var b,c,d,e,f;if(c=arguments[0],f=2<=arguments.length?F.call(arguments,1):[],c=a.isString(c)?a.trim(c):c,null!=f)for(d=0,b=f.length;b>d;d++)if(e=f[d],e===c)return!0;return a.isNull(c)||a.isUndefined(c)||a.isString(c)&&c.length<1||a.isJson(c)&&a.keys(c).length<1?!0:!1},a.isPlainObject=function(b){return a.isObject(b)&&!a.isWin(b)&&Object.getPrototypeOf(b)===Object.prototype},n=function(b,c,d){var e;e=d||B,l(e,b,function(){return a.isFunc(t[b])?t[b].apply(this,arguments):t[b]},"get"),l(e,b,function(a){return t[b]=a},"set"),t[b]=c},a.getset=function(b,c){var d,e,f,g,h,i;if(g={},a.isString(b))g[b]=null;else if(a.isArray(b))for(d=h=0,f=b.length;f>h;d=++h)i=b[d],g[i]=null;else{if(!a.isJson(b))throw new Error(a.type(arguments)+" is unsupported, must string|string array|JSON");g=b}for(e in g)i=g[e],n(e,i,c)},a.getset(t),a.getset(f,f),a.settings=function(){return t},a.clone=function(b){return a.isObject(b)?a.isArray(b)?b.slice():a.extend({},b):b},z=function(b,c,d,e){var f,g;f=a.isArray(c),g=a.isPlainObject(c),a.each(c,function(c,h){var j;j=a.type(c),e&&(h=d?e:e+"["+(g||j===i[8]||j===i[1]?h:"")+"]"),!e&&f?b.add(c.name,c.value):j===i[1]||!d&&j===i[8]?z(b,c,d,h):b.add(h,c)})},a.param=function(a,b){var c;return c=[],c.add=function(a,b){return this.push(m(a)+"="+m(b))},z(c,a,b),c.join("&").replace(/%20/g,"+")},a.getUrl=function(b,c){var d;return d=a.isBlank(c)?"":"?"+(a.isJson(c)?a.param(c):String(c)),/^http/.test(b)?b+d:a.getBasePath()+a.aroundIf(a.getCtxPath(),"/")+b+d},a.getUrlVars=function(){var a,b,c,d,e,f,g,h;if(h={},b=y.location.href,c=b.indexOf("?"),-1===c)return h;for(f=b.slice(c+1).split("&"),e=0,d=f.length;d>e;e++)g=f[e],a=g.split("="),h[a[0]]=a[1];return h},a.href=function(b,c){y.location.href=a.getUrl(b,c)},a.slice=function(b,c){return a.isArguments(b)?Array.prototype.slice.call(b,c):(b||[]).slice(c||0)},a.startWith=function(b,c){return new RegExp("^"+(a.isArray(c)?"["+c.join("|")+"]":c)).test(b)},a.endWith=function(b,c){return new RegExp((a.isArray(c)?"["+c.join("|")+"]":c)+"$").test(b)},a.startIf=function(b,c){return a.startWith(b,c)?b:c+b},a.endIf=function(b,c){return a.endWith(b,c)?b:b+c},a.aroundWith=function(b,c){return a.startWith(b,c)&&a.endWith(b,c)},a.aroundIf=function(b,c){return a.endIf(a.startIf(b,c),c)},a.prefix=function(a,b,c){return(Array(b).join(c||"0")+a).slice(-b)},a.suffix=function(a,b,c){return a+Array(b+1).join(c||"0").slice(a.length)},a.trim=function(b,c){return a.isString(b)?a.isUndefined(c)?b.replace(/(^\s*)|(\s*$)/g,""):b.replace(new RegExp("(^("+c+")*)|(("+c+")*$)","gi"),""):b},a.repeat=function(a,b){return new Array(1+b).join(a)},a.ltrim=function(b,c){return a.isString(b)?b.replace(new RegExp("(^"+(a.isBlank(c)?"\\s":c)+"*)"),""):b},a.rtrim=function(b,c){return a.isString(b)?b.replace(new RegExp("("+(a.isBlank(c)?"\\s":c)+"*$)"),""):b},a.randomStr=function(a){var b;for(b="";;)if(b+=Math.random().toString(36).substr(2),b.length>=a)break;return b.substr(0,a)},a.uniqueId=function(a){var b;return b=++C+"",a?a+b:b},a.times=function(a,b,c){var d,e;for(d=Array(Math.max(0,a)),e=0;;)if(d[e]=b.call(c,e),++e,e>=a)break;return d},a.delay=function(b,c){var d;return d=a.slice(arguments,2),setTimeout(function(){return b.apply(null,d)},c)},a.once=function(a){var b,c;return c=!1,b=null,function(){return c?b:(c=!0,b=a.apply(this,arguments),a=null,b)}},a.wrap=function(a,b){return function(){var c;return c=[a],Array.prototype.push.apply(c,arguments),b.apply(this,c)}},a.prop=function(a){return function(b){return b[a]}},a.format=function(b,c){return a.isArray(c)||(c=a.slice(arguments,1)),b.replace(/\{(\d+)\}/gm,function(b,d){var e;return e=a.isUndefined(c[d])?b:c[d],a.isObject(e)?g(e):e})},v=function(b,c){var d,e,f;if(a.isArray(b))d=b.indexOf(c),d>-1&&b.splice(d,1);else if(a.isJson(b))for(e in b)f=b[e],f===c&&delete b[e]},a.rmByVal=function(){var a,b,c,d,e;for(d=arguments[0],a=2<=arguments.length?F.call(arguments,1):[],c=0,b=a.length;b>c;c++)e=a[c],v(d,e);return d},a.getKey=function(a,b){var c,d;for(c in a)if(G.call(a,c)&&(d=a[c],d===b))return c;return null},a.has=function(b,c){return a.isBlank(b)?!1:a.isArray(b)?H.call(b,c)>=0:a.isObject(b)?c in b:Object.prototype.hasOwnProperty.call(b,c)},a.sleep=function(b){var c,d;for(d=a.now(),c=-1;;)if(c++,a.now()-d>=b)break},a.betn=function(b,c,d,e){var f,g,h,i,j,k,l,m,n,o;if(a.isBlank(c)||a.isBlank(d))return b;if(m=new Array,j=new RegExp("(?:\\"+c+")([\\s\\S]*?)(?:"+d+")","gim"),g=b.match(j),e){for(o=h=0,k=g.length-1;k>=0?k>=h:h>=k;o=k>=0?++h:--h)m.push(g[o]);return m}if(n=null,a.isNull(g))return m;for(f=i=0,l=g.length-1;l>=0?l>=i:i>=l;f=l>=0?++i:--i)n=j.exec(b),a.isNull(n)||m.push(n[1]);return m},a.betns=function(b,c,d,e){return a.isBlank(c)||a.isBlank(d)||!a.isFunc(e)?b:b.replace(new RegExp("(?:\\"+c+")([\\s\\S]*?)(?:"+d+")","gim"),e)},a.querySelector=function(a,b,c){return null==b&&(b=!1),null==c&&(c=document),b?c.querySelectorAll(a):c.querySelector(a)},a.query=function(){var b,c,d,e,f,g;switch(e=1<=arguments.length?F.call(arguments,0):[],d=e.length,g="",c=!1,d){case 1:case 2:case 3:g=e[0],2===d&&(a.isBoolean(e[1])?c=e[1]:b=e[1]),3===d&&(b=e[1],c=e[2])}if(b=b||document,/^[A-Za-z0-9]+$/.test(g)){if(f=a.querySelector(g,c,b),null!==f)return f;g="[name="+g+"]"}return a.querySelector(g,c,b)},a.removeEl=function(){var b,c;c=1<=arguments.length?F.call(arguments,0):[],b=a.query(c),b&&b.parentNode.removeChild(b)},a.chkParam=function(){var b,c,d,e;if(e=1<=arguments.length?F.call(arguments,0):[],d=e[0],c=e[1]||"",b=a.slice(e,2),!d)throw new Error(a.format(c,b));return!0},a.fillParam=function(){var b,c,d,e,f,g,h,i,j,k;switch(g=1<=arguments.length?F.call(arguments,0):[],c="",b=null,j=["div","span"],f=g.length){case 1:b=g[0];break;case 3:case 2:3===f&&(j=j.concat(a.isArray(g[2])?g[2]:[g[2]])),c=g[0],b=g[1]}c=a.startIf(c,"#");for(e in b)k=b[e],i=null,i=a.startWith(e,["#","\\."])?c+" "+e:c+" [name="+e+"]",d=a.query(i),a.isBlank(d)||(h=(d.tagName||"").toLowerCase(),H.call(j,h)>=0?d.innerHTML=k:d.value=k)},a.getParam=function(){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q;for(h=arguments[0],i=2<=arguments.length?F.call(arguments,1):[],h=a.startIf(h,"#"),e=["hidden","text","checkbox","password","tel","email","url","number","date","time","datetime","month"],j=["li"],d=["select"].concat(i),m=0,k=e.length;k>m;m++)q=e[m],d.push("input[type="+q+"]");if(c={},b=a.query(h),a.isBlank(b))return c;for(o=a.query(d.join(","),b,!0),n=0,l=o.length;l>n;n++)f=o[n],g=f.getAttribute("name"),(g||"").length>0&&(c[g]=a.has(f,"value")?(p=(f.tagName||"").toLowerCase(),H.call(j,p)>=0?f.innerText:a.trim(f.value)):f.innerHTML);return c},w=function(a){var b,c,d,e;c=[];for(b in a)e=a[b],c.push(b);return d=new RegExp(c.join("|"),"ig"),function(b){return b.replace(d,function(b,c,d,e,f){var g;return g=a[b]||g})}},a.replacer=function(a){return new w(a)},u=function(b,c,d,e){var f,g;if(f=d||B,a.has(f,b)&&!e)throw new Error("module exists: "+b);f[b]=c,a.isFunc(c)&&f.mixin&&(g={},g[b]=c,f.mixin(g))},a.register=function(){var b,c,d,e;if(c=1<=arguments.length?F.call(arguments,0):[],a.isJson(c[0])){d=c[0];for(b in d)e=d[b],u(b,e,c[1],c[2])}else u.apply(this,arguments)},a.unregister=function(a,b){delete(b||B)[a]},a.methodRegister=function(a,b,c,d){l(a,b,c,d)},A=function(b,c){return(a.isUndefined(c)?a.getToStringShowType():c)?b:""},a.asStr=function(a,b,c){return g(a,b||"",c||!1)},a.rmEvtProp=function(b,c){var d,e,g,h;if(g={},a.isObject(b)&&a.isJson(b))for(e in b)h=b[e],a.isEvent(h)?(d=A("[object event]: ")+h.type,c&&(g[e]=d),a.isInfoEnabled()&&(f.getC().info("The "+d+" from '"+e+"' below is event detail:"),f.getC().info(h))):g[e]=h;return g},g=function(b,c,d){var e,f,h,j,k,l,m,n,o,p,q,r,s,t,u;switch(j=[],r=c||a.CRLF,q=a.type(b),m=a.type(b,!0)+": ",t=g,q){case i[11]:case i[7]:case i[10]:case i[2]:case i[5]:case i[6]:j.push(A(m,d)+b);break;case i[3]:case i[9]:j.push(A(m,d)+String(b));break;case i[4]:j.push(A(m,d)+(b.stack||b));break;case i[0]:case i[1]:for(q===i[0]&&(b=a.slice(b)),f=[],s=0,p=b.length;p>s;s++)u=b[s],f.push("object"==typeof u?t(u,r,!1):u);j.push(A(m,d)+"["+r+f.join(","+r)+r+"]");break;case i[8]:if(a.getToStringEvent()||(b=a.rmEvtProp(b,!0)),y.JSON&&a.isJson(b))try{e=[],j.push(JSON.stringify(b,function(a,b){if("object"==typeof b&&null!==b){if(-1!==e.indexOf(b))return;e.push(b)}return b}))}catch(v){l=v,a.warn(l.message,"JSON.stringify error (ignorable)")}break;default:h=[];for(o in b)G.call(b,o)&&(u=b[o],/^HTML/.test(q)?(n="innerHTML",k="documentElement",a.has(u,n)?u=u+" "+u[n]:a.has(u,k)&&(u=u+" "+u[k])):u=a.isJson(u)?t(u):u,h.push(o+": "+u));j.push(A(m,d)+"{"+r+h.join(","+r)+r+"}")}return j.join(r)},s=function(b,c){return l(B,b,function(a,d,e,f){return k({name:b,level:c},a,d,e,f)}),l(B,b+"Enabled",function(){return f.getC()&&parseInt(c)>=parseInt(a.getLogger())},"is"),l(B,b+"Enabled",function(){return a.setLogger(r[b])},"set")};for(p in r)E=r[p],E!==r.none&&s(p,E);k=function(b,c,d,e,h){var i,j;i=f.getC(),i&&parseInt(b.level)>=parseInt(a.getLogger())&&i[b.name]&&(j=a.getLogPrefix(b.name)+(d?d+a.CRLF:"")+g(c,e,h),i[b.name].call(i,j))},a.console=function(b,c){return a.isNull(b)?(f.setC(!1),b):((!f.getC()||c)&&(a.isFunc(b)?f.setC({log:b,info:b,warn:b,error:b}):a.isObject(b)?f.setC(b):a.isUndefined(y.console)||f.setC(y.console)),f.getC())},a.getLoggerName=function(b){return b=b||a.getLogger(),a.getKey(r,parseInt(b)>r.none?r.none:b)},h=function(){var b,c,d,e;return e=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,c=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,d=/[^-+\dA-Z]/g,b=function(b,c){return a.prefix(b,c||2)},function(f,g,h){var i,j,k,l,m,n,o,p,q,r,s,t,u;if(a.isUndefined(g)&&a.isString(f)&&!/\d/.test(f)&&(g=f,f=void 0),q=a.getDateI18n(),o=a.getDateMask(),f=a.isBlank(f)?new Date:new Date(f),isNaN(f))throw SyntaxError("invalid date: "+f);return g=String(o[g]||g||o["default"]),"UTC:"===g.slice(0,4)&&(g=g.slice(4),h=!0),m=a.isBlank(h)?"get":"getUTC",n=f[m+"Date"](),i=f[m+"Day"](),r=f[m+"Month"](),u=f[m+"FullYear"](),j=f[m+"Hours"](),l=f[m+"Minutes"](),t=f[m+"Seconds"](),k=f[m+"Milliseconds"](),s=a.isBlank(h)?f.getTimezoneOffset():0,p={d:n,dd:b(n),ddd:q.day[i],dddd:q.day[i+7],m:r+1,mm:b(r+1),mmm:q.month[r],mmmm:q.month[r+12],yy:String(u).slice(2),yyyy:u,h:j%12||12,hh:b(j%12||12),H:j,HH:b(j),M:l,MM:b(l),s:t,ss:b(t),l:b(k,3),L:b(k>99?Math.round(k/10):k),t:12>j?"a":"p",tt:12>j?"am":"pm",T:12>j?"A":"P",TT:12>j?"AM":"PM",Z:h?"UTC":(String(f).match(c)||[""]).pop().replace(d,""),o:(s>0?"-":"+")+b(100*Math.floor(Math.abs(s)/60)+Math.abs(s)%60,4),S:["th","st","nd","rd"][n%10>3?0:(n%100-n%10!==10)*n%10]},g.replace(e,function(a){return a in p?p[a]:a.slice(1,a.length-1)})}},h=h(),a.addDateMask=function(b,c){a.extend(t.dateMask,b=b||{}),a.each(b,function(b,d){a.methodRegister(c||a.when,d,function(c,d){return a.dateFmt(c,b,d)})})},a.dateFmt=function(a,b,c){return h(a,b,c)},a.keys=function(b,c){var d;if(null==c&&(c=function(){return!0}),a.isObject(b)&&Object.keys)return Object.keys(b);d=[];for(p in b)G.call(b,p)&&(E=b[p],c(E,p)&&d.push(p));return d},a.vals=function(b){var c,d,e,f,g,h;for(c=a.keys(b),d=c.length,h=new Array(d),g=[],f=0,e=c.length;e>f;f++)p=c[f],g.push(b[p]);return g},a.funcs=function(b){return a.keys(b,function(b){return a.isFunc(b)})},j=function(b,c){return a.prototype[b]=function(){var b;return b=[this._wrapped],Array.prototype.push.apply(b,arguments),x.call(this,c.apply(a,b))}},a.mixin=function(b){var c,d,e,f,g;for(g=a.funcs(b),f=0,d=g.length;d>f;f++)e=g[f],c=a[e]=b[e],j(e,c)},x=function(b){return this._chain?a(b).chain():b},a.mixin(a),a.chain=function(b){return a(b).chain()},a.prototype.chain=function(){return this._chain=!0,this},a.prototype.value=function(){return this._wrapped},function(a,b){var c;c=function(b,c,d){return a.dateFmt(c,b,d)},a.addDateMask(a.getDateMask(),c),c.idesc={year:" years ago",month:" months ago",week:" weeks ago",day:" days ago",hour:" hours ago",minute:" minutes ago",just:"just now"},c.time=function(b){var c;return b=b||new Date,a.isDate(b)||(c=new Date(b),b=isNaN(c)?new Date(b.replace(/-/g,"/")):c),b.getTime()},c.interval=function(a){var b,d,e,f,g;return g=1e3,b=86400,d=3600,f=60,a=c.time(a),e=(c.time()-a)/g,e>=0?e/15768e4>1?c["default"](a):e/31536e3>1?parseInt(e/31536e3)+c.idesc.year:e/2592e3>1?parseInt(e/2592e3)+c.idesc.month:e/604800>=1?7+c.idesc.day:1>e/604800&&e/b>=1?parseInt(e/b)+c.idesc.day:1>e/b&&e/d>=1?parseInt(e/d)+c.idesc.hour:d>e&&e>=f?parseInt(e/f)+c.idesc.minute:c.idesc.just:c["default"](a)},a.register(b,c)}(B,"when"),function(a,b){var c,d;d=function(a,b){return e(a,b)},c={};var e=function f(a,b){var d=/\W/.test(a)?new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+a.replace(/[\r\t\n]/g," ").split("<%").join("	").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("	").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');"):c[a]=c[a]||f(document.getElementById(a).innerHTML);return b?d(b):d};a.register(b,d)}(B,"tmpl"),function(a,b){"object"==typeof module&&module&&"object"==typeof module.exports?module.exports=a:(y.kiwi=y[b]=a,"function"==typeof define&&define.amd&&define(b,[],function(){return a}),"function"==typeof define&&define.cmd&&define(function(c,d,e){d[b]=a}))}(B,"lemon")}).call(this);
	!function(a,b){var c,d,e,f,g,h,i;f=function(a){return d(a)},f.reverse=function(a){return i(a)},f.highlight=function(a){return j(a)},f.get=function(a,b){return value(a,b)},e=function(a,b){return p[b-1]},g=function(a){return new Array(a+1).join("	")},value=function(b,c){c=c||"";var d=c.indexOf(".")>0?c.split("."):[c],e=b;return a.each(d,function(b,c){var d=b;if(b.indexOf("[")>0&&b.indexOf("]")>0){var f=a.betn(b,"[","]",!0);b=b.replace(f.join(""),"")}if(e=e&&e[b],a.isArray(e)){var g=a.betn(d,"[","]");if(g.length>0){var h=e;a.each(g,function(a,b){h=h&&h[parseInt(a)]}),e=h}}}),e},h=function(b,c,d){var e,f,g,h;return g="",e=a.trim(b),f=e.split(c),f.length>0?(h=[],a.each(f,function(b,c){h.push(a.trim(b))}),g=h.join(d?"":c)):g=e,g},c=function(b){if(a.isBlank(b))return"{}";if(a.isString(b))return b;if(JSON&&a.isJson(b))return JSON.stringify(b);throw new Error("This browser JSON.stringify is unsupported.")},i=function(a){var b;return b=h(c(a),"\n"),b=h(b,"["),b=h(b,"]"),b=h(b,"{"),b=h(b,"}"),b=h(b,","),b=h(b,":")},f.style={".string":{color:"green"},".number":{color:"blue"},".boolean":{color:"darkorange"},".null":{color:"magenta"},".key":{color:"gray"}},f.toCSS=function(a){var b="";for(var c in a){b+=c+" {\n";for(var d in a[c])if("CSS-INHERIT-SELECTOR"==d)for(var e in a[a[c][d]])b+="	"+e+":"+a[a[c][d]][e]+";\n";else b+="	"+d+":"+a[c][d]+";\n";b+="}\n"}return b},f.addStyle=function(b,c){var d;c=c||"json_syntax",a.removeEl("#"+c),d=document,b=d.createElement("style"),b.type="text/css",b.id=c,b.innerHTML=a.isString(b)?b:f.toCSS(f.style),a.query("head").appendChild(b)};var j=function(a){return f.addStyle(),a=d(a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),a.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,function(a){var b="number";return/^"/.test(a)?b=/:$/.test(a)?"key":"string":/true|false/.test(a)?b="boolean":/null/.test(a)&&(b="null"),'<span class="'+b+'">'+a+"</span>"})};d=function(a){var b,d,f,h,j,k;if(JSON)return JSON.stringify(JSON.parse(c(a)),void 0,4);for(h="",f=0,a=i(c(a)),d=j=0,k=a.length;k>=0?k>j:j>k;d=k>=0?++j:--j)switch(b=a.charAt(d)){case"{":case"[":h+=b+"\n"+g(++f);break;case"}":case"]":h+="\n"+g(--f)+b;break;case",":h+=",\n"+g(f);break;case":":h+=": ";break;default:h+=b}return h=h.replace(/\[[\d,\s]+?\]/g,function(a){return a.replace(/\s/g,"")}).replace(/\\(\d+)\\/g,e).replace(/\\(\d+)\\/g,e)},a.register(b,f)}(this.kiwi,"json");
	!function(a,b,c){function d(a){return function(){var b=_a.slice.call(arguments,0);b.unshift(g),k.appendChild(g),g.addBehavior("#default#userData"),g.load(i);var c=a.apply(store,b);return k.removeChild(g),c}}function e(a){return a.replace(/^d/,"___$&").replace(n,"___")}var f={};f=function(a,c,d){if(b.isUndefined(c))return f.get(a);if(b.isNull(c)){var e=f.get(a);return f.remove(a),e}return f.set(a,c),c};var g,h=a.document,i="localStorage",j="script";if(f.isSupport=function(){try{return i in a&&a[i]}catch(b){return!1}},f.serialize=function(c){return a.JSON&&b.isJson(c)?JSON.stringify(c):c},f.deserialize=function(a){if("string"!=typeof a)return a||void 0;try{return JSON.parse(a)}catch(b){return a||void 0}},f.transact=function(a,b,c){var d=f.get(a);null==c&&(c=b,b=null),typeof d==_undef&&(d=b||{}),c(d),f.set(a,d)},f.exists=function(a){return null!=f.get(a)},f.keys=function(){var a=[];return $.each(f.getAll(),function(b,c){a.push(b)}),a},f.size=function(a,b){return f.keys().length},f.isSupport())g=a[i],f.set=function(a,b){return void 0===b?f.remove(a):(g.setItem(a,f.serialize(b)),b)},f.get=function(a){return f.deserialize(g.getItem(a))},f.remove=function(a){g.removeItem(a)},f.clear=function(){g.clear()},f.getAll=function(){var a={};return f.forEach(function(b,c){a[b]=c}),a},f.forEach=function(a){for(var b=0;b<g.length;b++){var c=g.key(b);a(c,f.get(c))}};else if(h.documentElement.addBehavior){var k,l;try{l=new ActiveXObject("htmlfile"),l.open(),l.write("<"+j+">document.w=window</"+j+'><iframe src="/favicon.ico"></iframe>'),l.close(),k=l.w.frames[0].document,g=k.createElement("div")}catch(m){g=h.createElement("div"),k=h.body}var n=new RegExp("[!\"#$%&'()*+,/\\\\:;<=>?@[\\]^`{|}~]","g");f.set=d(function(a,b,c){return b=e(b),void 0===c?f.remove(b):(a.setAttribute(b,f.serialize(c)),a.save(i),c)}),f.get=d(function(a,b){return b=e(b),f.deserialize(a.getAttribute(b))}),f.remove=d(function(a,b){b=e(b),a.removeAttribute(b),a.save(i)}),f.clear=d(function(a){var b=a.XMLDocument.documentElement.attributes;a.load(i);for(var c,d=0;c=b[d];d++)a.removeAttribute(c.name);a.save(i)}),f.getAll=function(a){var b={};return f.forEach(function(a,c){b[a]=c}),b},f.forEach=d(function(a,b){for(var c,d=a.XMLDocument.documentElement.attributes,e=0;c=d[e];++e)b(c.name,f.deserialize(a.getAttribute(c.name)))})}b.register(c,f)}(this,this.kiwi,"store"),function(a,b,c){var d={};d.pushState=window.history&&window.history.pushState&&window.history.replaceState&&!navigator.userAgent.match(/((iPod|iPhone|iPad).+\bOS\s+[1-4]|WebApps\/.+CFNetwork)/),d.store=b.store.isSupport()?!0:!1,b.register(c,d)}(this,this.kiwi,"support");
	!function(a,b,c){var d={};d=function(a,b){return f(a,b)},d.mozilla=/firefox/.test(navigator.userAgent.toLowerCase()),d.webkit=/webkit/.test(navigator.userAgent.toLowerCase()),d.opera=/opera/.test(navigator.userAgent.toLowerCase()),d.msie=/msie/.test(navigator.userAgent.toLowerCase()),d.form=function(a,b,c,d){e(a,b,c,d)};var e=function(b,c,e,f){var g,h,i,j=!1;i=$(lemon.startIf(c,"#")),i.submit(function(){function c(){try{var a=h.get(0).contentWindow.name||null;null!=a&&(h.remove(),i.remove(),b(a))}catch(c){}}h=$('<iframe name="_rmfrm_form" id="_rmfrm_form" style="display:none;" scrolling="no" frameborder="0"></iframe>'),$(document.body).append(h),i.attr("target","_rmfrm_form"),i.attr("action",e),i.attr("method",f),a.postMessage?b&&(g=null,g=function(c){$(a).unbind("message",g),h.remove(),i.remove(),b(c.originalEvent.data)},$(a).bind("message",g)):(h.load(function(){j?d.msie||c():(j=!0,h.get(0).contentWindow.location="about:blank")}),d.msie&&(h.get(0).onreadystatechange=function(){j&&c()}))})},f=function(b,c){function e(){try{var a=g.get(0).contentWindow.name||null;null!=a&&(g.remove(),c(a))}catch(b){}}var f,g,h=!1;g=$('<iframe name="_rmfrm" id="_rmfrm" style="display:none;" scrolling="no" frameborder="0"></iframe>'),$(document.body).append(g),g.attr("src",b),a.postMessage?c&&(f=null,f=function(b){$(a).unbind("message",f),g.remove(),c(b.originalEvent.data)},$(a).bind("message",f)):(g.load(function(){h?d.msie||e():(h=!0,g.get(0).contentWindow.location="about:blank")}),d.msie&&(g.get(0).onreadystatechange=function(){h&&e()}))};b.register(c,d)}(this,this.kiwi,"cross");
	!function(a,b,c){function d(a){var b={};if(lemon.isString(a)&&$(a).length){var c=$(a).offset();c.w=$(a).width(),c.h=$(a).height(),b.el=a,b.area=c}else{if(!(lemon.isJson(a)&&lemon.has(a,"left")&&lemon.has(a,"top")&&lemon.has(a,"w")&&lemon.has(a,"h")))throw new Error("Arguments ilegal, supports jQuery selector || area eg: {left: 10, top: 70, w: 100, h: 300}");b.el="body",b.area=a}this.watch=b,this.area={},this.start()}var e={};e=function(a){return new d(a)};var f={};d.prototype.start=function(){var a=this.watch.el;return f[a]||($(a).bind("mousemove",{rel:this},g),f[a]=1),this},d.prototype.stop=function(){var a=this.watch.el;return f[a]&&($(a).unbind("mousemove",g),f[a]=0),this},d.prototype.listen=function(a){return a=b.extend({direct:"left",offsetX:5,offsetY:5,movein:null,moveout:null},a||{}),a.inplace=!1,this.area[a.direct]=a,this},e.status=function(){return{listening:f}};var g=function(a){var c=a.data.rel,d=null,e=c.watch.area,f=!1,g={x:a.pageX,y:a.pageY};b.each(c.area,function(a,c){switch(d=a,g.options=a,c){case"left":f=g.x>=e.left&&g.x<=e.left+d.offsetX&&g.y>=e.top+d.offsetY&&g.y<=e.top+e.h-d.offsetY;break;case"right":f=g.x>=e.left+e.w-d.offsetX&&g.x<=e.left+e.w&&g.y>=e.top+d.offsetY&&g.y<=e.top+e.h-d.offsetY;break;case"top":f=g.x>=e.left+d.offsetX&&g.x<=e.left+e.w-d.offsetX&&g.y>=e.top&&g.y<=e.top+d.offsetY;break;case"bottom":f=g.x>=e.left+d.offsetX&&g.x<=e.left+e.w-d.offsetX&&g.y>=e.top+e.h-d.offsetY&&g.y<=e.top+e.h;break;case"leftTop":f=g.x>=e.left&&g.x<=e.left+d.offsetX&&g.y>=e.top&&g.y<=e.top+d.offsetY;break;case"rightTop":f=g.x>=e.left+e.w-d.offsetX&&g.x<=e.left+e.w&&g.y>=e.top&&g.y<=e.top+d.offsetY;break;case"leftBottom":f=g.x>=e.left&&g.x<=e.left+d.offsetX&&g.y>=e.top+e.h-d.offsetY&&g.y<=e.top+e.h;break;case"rightBottom":f=g.x>=e.left+e.w-d.offsetX&&g.x<=e.left+e.w&&g.y>=e.top+e.h-d.offsetY&&g.y<=e.top+e.h}f?d.inplace||(d.inplace=!0,b.isFunc(d.movein)&&d.movein(g)):d.inplace&&(d.inplace=!1,b.isFunc(d.moveout)&&d.moveout(g))})};b.register(c,e)}(this,this.kiwi,"mousepos");
</script>
<style type="text/css">
    .fixed-panel { min-height: 430px; max-height: 430px; overflow-y: scroll; }
    .fixed-dropdown { min-height: 130px; max-height: 530px; overflow-y: scroll; max-width: 350px; }
    .block-grey { background-color: #e6e6e6; }

	.cm-s-lemon .CodeMirror { background-color:#ffffff; color:#2e383c; line-height:1.4375; }
	.cm-s-lemon .cm-comment {color:#75787b}
	.cm-s-lemon .cm-keyword, .cm-s-lemon .cm-property {color:gray}
	.cm-s-lemon .cm-atom {color: magenta} .cm-s-lemon .cm-number {color:blue}
	.cm-s-lemon .cm-node,.cm-s-lemon .cm-tag {color:#9c3328}
	.cm-s-lemon .cm-string {color:green}
	.cm-s-lemon .cm-variable,.cm-s-lemon .cm-qualifier {color:#047d65}
	.cm-s-lemon pre { padding:0; }
	.cm-s-lemon .CodeMirror-gutters { border:none; border-right:10px solid transparent; background-color:transparent; }
	.cm-s-lemon .CodeMirror-linenumber { padding:0; color:#e0e2e5; }
	.cm-s-lemon .CodeMirror-guttermarker { color: #1d75b3; }
	.cm-s-lemon .CodeMirror-guttermarker-subtle { color: #e0e2e5; }
</style>
</head>
<body>
	<nav class="navbar navbar-default" id="home_navbar" style="border:0px;">
		<div class="container-fluid">
			<div class="navbar-header">
				<a class="navbar-brand" href="javascript:void(0);"></a>
			</div>

			<div class="collapse navbar-collapse">
				<ul class="nav navbar-nav" id="env_container">
					<li class="dropdown">
						<a href="javascript:void(0);" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Environment <span class="caret"></span> </a>
						<ul class="dropdown-menu fixed-dropdown" role="menu" id="which_env">
							<li><a href="#">Test</a></li>
							<li><a href="#">Product</a></li>
						</ul>
					</li>
				</ul>
				<ul class="nav navbar-nav">
					<li class="dropdown">
						<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Which API <span class="caret"></span> </a>
						<ul class="dropdown-menu fixed-dropdown" role="menu" id="which_api" style="border:0px;">
							<li><a href="#">api1</a></li>
							<li><a href="#">api2</a></li>
						</ul>
					</li>
				</ul>
				<button type="button" class="hidden" id="btn_advance"></button>
				<form class="navbar-form navbar-left" role="search">
					<div class="form-group">
						<div class="input-group" id="group_search">
					      <div class="input-group-btn">
					        <button type="button" class="btn btn-default dropdown-toggle" style="border:0px;" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"> 
					        <span class="caret text-muted"></span></button>
					        <ul class="dropdown-menu" style="border:0px;"k>
					          <li role="separator" class="divider"></li>
					          <li> <a href="javascript:void(0);" onclick="api.typeSearch(12)"><span class="text-muted">Advance Search</span></a> </li>
					          <li role="separator" class="divider"></li>
					          <li><a href="javascript:void(0);" onclick="api.typeSearch(1)"><span class="text-muted">Defined APIs</span></a></li>
					          <li><a href="javascript:void(0);" onclick="api.typeSearch(4)"><span class="text-muted">Tag</span></a></li>
					          <li><a href="javascript:void(0);" onclick="api.typeSearch(5)"><span class="text-muted">Favourite</span></a></li>
					          <li><a href="javascript:void(0);" onclick="api.typeSearch(11)"><span class="text-muted">Mutation</span></a></li>
					          <li role="separator" class="divider"></li>
					        </ul>
					      </div>
					      <!-- <input type="text" class="form-control" id="input_search" style="width: 230px;" placeholder="API & Histories.."> -->
					      <textarea type="text" class="form-control" id="input_search" style="border:0px;width: 230px;height:34px;" placeholder="API & Histories.."></textarea>
					    </div>
					</div>
					<button type="button" class="btn btn-default" style="border:0px;" id="btn_search">
						<span class="glyphicon glyphicon-search text-muted" title="Search"></span>
					</button>
					<button type="button" class="btn btn-default" id="btn_request" style="border:0px;"><span class="text-muted">Request</span></button>					
					<div class="btn-group">
					  <button type="button" class="btn btn-default" style="border:0px;" id="btn_request_tab"><span class="text-muted">Request In New Tab</span></button>
					  <button type="button" class="btn btn-default dropdown-toggle" style="border:0px;" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
					    <span class="caret text-muted"></span>
					    <span class="sr-only">Toggle Dropdown</span>
					  </button>
					  <ul class="dropdown-menu" style="border:0px;">
					    <li role="separator" class="divider"></li>
					    <li><a href="javascript:void(0);" id="btn_request_get"><span class="text-muted">Request with Get</span></a></li>
					    <li role="separator" class="divider"></li>
					    <li><a href="javascript:void(0);" id="btn_request_post"><span class="text-muted">Request with Post</span></a></li>
					    <li role="separator" class="divider"></li>
					  </ul>
					</div>
					
					<button type="button" class="btn btn-default" style="border:0px;" id="btn_history"><span class="text-muted">History</span></button>
					<div class="btn-group">
					  <button type="button" class="btn btn-default" style="border:0px;" id="btn_note"><span class="text-muted">Note</span></button>
					  <button type="button" class="btn btn-default dropdown-toggle" style="border:0px;" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
					    <span class="caret text-muted"></span>
					    <span class="sr-only">Toggle Dropdown</span>
					  </button>
					  <ul class="dropdown-menu" style="border:0px;">
					    <li role="separator" class="divider"></li>
					    <li><a href="javascript:void(0);" id="btn_note_diff"><span class="text-muted">Diff & Merge</span></a></li>
					    <li role="separator" class="divider"></li>
					  </ul>
					</div>
					
					<div id="input_note_wrap" style="display:none;">
						<textarea type="text" class="hidden" id="input_note"></textarea>
						<div id="note_tool" style="display:none;" state="close"></div>
						<input type="file" id="note_open_file" class="hidden"/>
						<input type="file" id="diff_left_file" class="hidden"/>
						<input type="file" id="diff_editor_file" class="hidden"/>
						<input type="file" id="diff_right_file" class="hidden"/>
						<a class="hidden" id="note_merge"></a>
					</div>
				</form>
				<ul class="nav navbar-nav navbar-right">
				</ul>
			</div>
		</div>
	</nav>
	<div id="message"></div>

	<div class="row" style="margin: 0 5px;">
		<div class="col-md-6">
			<div class="panel panel-default" style="margin-bottom:2px;border:0px;">
				<div class="panel-body" id="view_left">
					<form>
						<div class="form-group">
							<div class="pull-left">
								<button type="button" class="btn btn-default" style="border:0px;"><span class="text-muted">Request</span></button>
							</div>
							<div class="btn-group pull-right" id="left_toolbar">
								<button type="button" class="btn btn-default" style="border:0px;" id="from_url">
								<span class="text-muted glyphicon glyphicon-road" title="Set Request Data From URL OR Join Selection with Comma Symbol"></span></button>
								<button type="button" class="btn btn-default" style="border:0px;" id="as_default">
								<span class="text-muted glyphicon glyphicon-camera" title="Set Request Default Value"></span></button>
								<button type="button" class="btn btn-default" style="border:0px;" id="define_api">
								<span class="text-muted glyphicon glyphicon-pencil" title="Define API"></span></button>
								<button type="button" class="btn btn-default" style="border:0px;" data-element="#request" data-toggle="modal" data-target="#modal_tpl">
								<span class="text-muted glyphicon glyphicon-tree-deciduous" title="Show Request In Fullscreen (Esc Quit)"></span></button>
								<button type="button" class="btn btn-default" style="border:0px;" data-element="both" data-toggle="modal" data-target="#modal_tpl">
								<span class="text-muted glyphicon glyphicon-eye-open" title="Show Request and Response In Fullscreen (Esc Quit)"></span></button>
								<button type="button" class="btn btn-default" style="border:0px;" id="copy_url">
								<span class="text-muted glyphicon glyphicon-copy" title="Show Request URL"></span></button>
								<button type="button" class="btn btn-default" style="border:0px;" id="snapshoot_share">
								<span class="text-muted glyphicon glyphicon-qrcode" title="Generate QRcode"></span></button>
								<button type="button" class="btn btn-default" style="border:0px;" id="share_this">
								<span class="text-muted glyphicon glyphicon-share" title="Snapshoot Current Status to Share"></span></button>
								<button type="button" class="btn btn-default" style="border:0px;" id="api_define">
								<span class="text-muted glyphicon glyphicon-question-sign" title="Show the Define API"></span></button>
							</div>
							<textarea class="form-control" style="border:0px;" rows="21" id="request"></textarea>
						</div>
					</form>

				</div>
				<!-- <div class="panel-footer"> </div> -->
			</div>
		</div>
		<div class="col-md-6">
			<div class="panel panel-default"  style="margin-bottom:2px;border:0px;">
				<div class="panel-body" id="view_right">
					<form>
						<div class="form-group">
							<div class="pull-left">
								<button type="button" class="btn btn-default" id="btn_repl" style="border:0px;"><span class="text-muted">Response</span></button>
								<div id="area_repl"> <button type="button" class="hidden" id="btn_resp" style="border:0px;"></button> </div>
							</div>
							<div class="btn-group pull-right" id="right_toolbar">
								<button type="button" class="btn btn-default" id="btn_his_prev" step="-1" style="border:0px;"><span title="Previous History" class="text-muted glyphicon glyphicon-chevron-left"></span></button>
								<button type="button" class="btn btn-default" id="btn_his_next" step="1" style="border:0px;"><span title="Next History" class="text-muted glyphicon glyphicon-chevron-right"></span></button>
								<button type="button" class="btn btn-default" style="border:0px;" data-element="#response" data-toggle="modal" data-target="#modal_tpl">
								<span class="text-muted glyphicon glyphicon-leaf" title="Show Response In Fullscreen (Esc Quit)"></span></button>
								<button type="button" class="btn btn-default" style="border:0px;" data-element="both" data-toggle="modal" data-target="#modal_tpl">
								<span class="text-muted glyphicon glyphicon-eye-open" title="Show Request and Response In Fullscreen (Esc Quit)"></span></button>
							</div>
							<textarea class="form-control" rows="21" style="border:0px;" id="response"></textarea>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>
	
<div class="modal fade"  tabindex="-1" id="modal_tpl" role="dialog"></div>
	
<script src="http://cdn.bootcss.com/labjs/2.0.3/LAB.min.js"></script>
<script type="text/javascript"> 
	lemon.setBasePath('http://cdn.bootcss.com');
	lemon.register({
		css: function(target) {
			lemon.each(lemon.isArray(target) ? target : [target], 
			function(style, idx) {
	    		var link = document.createElement('link');
	    		link.setAttribute('rel', 'stylesheet');
	    		link.setAttribute('type', 'text/css');
	    		link.setAttribute('href', lemon.getUrl(style));
	    		lemon.query('head').appendChild(link);
	    	});
		}
	});
	
	lemon.css([
		'bootstrap/3.3.5/css/bootstrap.min.css',
		'progress.js/0.1.0/progressjs.min.css'
	]);

	var  homeldend = function() {
		if (lemon.homeld && lemon.homeld.base && lemon.homeld.queue && lemon.homeld.css) {
			lemon.delay(function() { api.env.lemon(); }, 500);
			lemon.homeld.end();
		}
	}
	
	$LAB
	.script(lemon.getUrl('/jquery/2.1.4/jquery.min.js')).wait()
	.script(lemon.getUrl('/bootstrap/3.3.5/js/bootstrap.min.js'))
	.script(lemon.getUrl('/progress.js/0.1.0/progress.min.js'))
	.wait(function() { 
		lemon.homeld = progressJs().start().autoIncrease(5, 100);
		lemon.prevhash = location.hash;
		
		$(root).bind('popstate', function(e) {
			var hash = location.hash;
			if (!lemon.isBlank(hash) && hash != lemon.prevhash) {
				api.hash.page(lemon.ltrim(hash, '#'));
				lemon.prevhash = hash;
			} else {
				api.nav.title();
			}
		});
		
		api.initialize(); 
		lemon.homeld.base = 1; homeldend();
	});

	var cmprfix = 'codemirror/5.8.0/';
	var queue = $LAB
		.queueScript(lemon.getUrl(cmprfix + 'codemirror.min.js'))
		.queueWait()
		.queueScript(lemon.getUrl(cmprfix + 'addon/dialog/dialog.min.js'))
		.queueScript(lemon.getUrl(cmprfix + 'addon/scroll/annotatescrollbar.min.js'))
		
		.queueScript(lemon.getUrl(cmprfix + 'addon/search/searchcursor.min.js'))
		.queueScript(lemon.getUrl(cmprfix + 'addon/search/matchesonscrollbar.min.js'))
		.queueScript(lemon.getUrl(cmprfix + 'addon/search/search.min.js'))
		.queueScript(lemon.getUrl(cmprfix + 'addon/search/match-highlighter.min.js'))
		
		.queueScript(lemon.getUrl(cmprfix + 'addon/edit/matchbrackets.min.js'))
		.queueScript(lemon.getUrl(cmprfix + 'addon/edit/matchtags.min.js'))
		.queueScript(lemon.getUrl(cmprfix + 'addon/edit/closebrackets.min.js'))
		.queueScript(lemon.getUrl(cmprfix + 'addon/edit/closetag.min.js'))
		
		.queueScript(lemon.getUrl(cmprfix + 'addon/lint/javascript-lint.min.js'))
		.queueScript(lemon.getUrl(cmprfix + 'addon/lint/json-lint.min.js'))
		
		.queueScript(lemon.getUrl(cmprfix + 'addon/hint/javascript-hint.min.js'))
		.queueScript(lemon.getUrl(cmprfix + 'addon/hint/show-hint.min.js'))
		.queueScript(lemon.getUrl(cmprfix + 'addon/hint/anyword-hint.min.js'))
		.queueScript(lemon.getUrl(cmprfix + 'addon/hint/xml-hint.min.js'))
		.queueScript(lemon.getUrl(cmprfix + 'addon/hint/html-hint.min.js'))
		.queueScript(lemon.getUrl(cmprfix + 'addon/hint/css-hint.min.js'))
		.queueScript(lemon.getUrl(cmprfix + 'addon/hint/sql-hint.min.js'))
		
		
		.queueScript(lemon.getUrl(cmprfix + 'mode/markdown/markdown.min.js'))
		.queueScript(lemon.getUrl(cmprfix + 'mode/javascript/javascript.min.js'))
		.queueScript(lemon.getUrl(cmprfix + 'mode/xml/xml.min.js'))
		.queueScript(lemon.getUrl(cmprfix + 'mode/htmlmixed/htmlmixed.min.js'))
		.queueScript(lemon.getUrl(cmprfix + 'mode/css/css.min.js'))
		.queueScript(lemon.getUrl(cmprfix + 'mode/meta.min.js'))
		.queueScript(lemon.getUrl(cmprfix + 'addon/mode/loadmode.min.js'))
		.queueScript(lemon.getUrl(cmprfix + 'addon/mode/simple.min.js'))
		.queueScript(lemon.getUrl(cmprfix + 'addon/mode/overlay.min.js'))
		.queueScript(lemon.getUrl(cmprfix + 'addon/mode/multiplex.min.js'))
		
		.queueScript(lemon.getUrl(cmprfix + 'addon/display/fullscreen.min.js'))
		.queueScript(lemon.getUrl(cmprfix + 'addon/display/panel.min.js'))
		.queueScript(lemon.getUrl(cmprfix + 'addon/display/autorefresh.min.js'))
		
		.queueScript(lemon.getUrl(cmprfix + 'addon/comment/comment.min.js'))
		.queueScript(lemon.getUrl(cmprfix + 'addon/comment/continuecomment.min.js'))
		
		.queueScript(lemon.getUrl(cmprfix + 'addon/fold/foldcode.min.js'))
		.queueScript(lemon.getUrl(cmprfix + 'addon/fold/foldgutter.min.js'))
		.queueScript(lemon.getUrl(cmprfix + 'addon/fold/brace-fold.min.js'))
		.queueScript(lemon.getUrl(cmprfix + 'addon/fold/indent-fold.min.js'))
		.queueScript(lemon.getUrl(cmprfix + 'addon/fold/comment-fold.min.js'))
		.queueScript(lemon.getUrl(cmprfix + 'addon/fold/markdown-fold.min.js'))
		.queueScript(lemon.getUrl(cmprfix + 'addon/fold/xml-fold.min.js'))
		
		.queueScript(lemon.getUrl(cmprfix + 'keymap/vim.min.js'))
		.queueScript(lemon.getUrl(cmprfix + 'addon/selection/active-line.min.js'))
		
		.queueScript(lemon.getUrl('diff_match_patch/20121119/diff_match_patch.js'))
		.queueScript(lemon.getUrl(cmprfix + 'addon/merge/merge.min.js'))
		.queueScript(lemon.getUrl('/lz-string/1.4.4/lz-string.min.js'))
		.queueScript(lemon.getUrl('/jquery.qrcode/1.0/jquery.qrcode.min.js'))
		.queueScript(lemon.getUrl('/velocity/1.2.3/velocity.min.js'))
		.queueScript(lemon.getUrl('/velocity/1.2.3/velocity.ui.min.js'))
		.queueScript('http://jronrun.github.io/refs/jquery.blast.min.js')
		.queueWait(function() { 
			after.initialize(); 
			if (!lemon.isBlank(lemon.prevhash)) {
				api.hash.page(lemon.ltrim(location.hash, '#'));
			} else {
				api.nav.title();
			}
			lemon.homeld.queue = 1; homeldend();
		});
	
	lemon.delay(function() {
		if (!api.intialized) {
			api.initialize();
		}
		
		lemon.css([
		    cmprfix + 'codemirror.min.css',
		    cmprfix + 'addon/dialog/dialog.min.css',
		    cmprfix + 'addon/search/matchesonscrollbar.min.css',
		    cmprfix + 'addon/display/fullscreen.min.css',
		    cmprfix + 'addon/hint/show-hint.min.css',
		    cmprfix + 'addon/merge/merge.min.css',
		    cmprfix + 'addon/fold/foldgutter.min.css'
		]);
		queue.runQueue();

		try {
    		root.isFileSaverSupported = !!new Blob;
    		if (isFileSaverSupported) {
    			$LAB.script(lemon.getUrl('/FileSaver.js/2014-11-29/FileSaver.min.js'));
        	}
		} catch (e) {}
		lemon.homeld.css = 1; homeldend();
	}, 500);

	lemon.delay(function() {
		lemon.css(lemon.getUrl('/intro.js/1.1.1/introjs.min.css'));
		$LAB.script(lemon.getUrl('/intro.js/1.1.1/intro.min.js')).wait(function() {
			root.help = introJs().setOptions({
	            steps: [
	            		{ 
	                      intro: "hee!"
	                    },
	                    {
	                      element: lemon.query('#view_left'),
	                      intro: "This is a tooltip."
	                    }
	                  ]
	            });
		});
		
		$LAB.script('http://jronrun.github.io/refs/console/console.min.js').wait(function() { 
			lemon.css([
				lemon.getUrl(cmprfix + 'theme/eclipse.min.css'), 
				lemon.getUrl(cmprfix + 'theme/base16-dark.min.css'),
				'http://jronrun.github.io/refs/console/console.css'
			]);

			api.repl.intl();
		});
	}, 1000);
</script>

<script type="text/html" id="table_tmpl">
<div class="panel panel-default" id="r_search" style="border:0px;">
  <% var clientW = document.body.clientWidth - 110; if (lemon.isBlank(histories)) { clientW = clientW + 35; } var panelH = document.body.clientHeight - 85; %>
  <div class="panel-body fixed-panel" style="height:<%=panelH%>px;max-height:<%=panelH%>px;">
	<% if (!lemon.isBlank(apis)) { %>
	<table class="table table-hover">
		<caption>API</caption>
        <thead> <tr> <th>#</th> <th> <button type="button" class="btn btn-default btn-sm" id="btn_tgl_apirequ">Request</button> <button type="button" class="btn btn-default btn-sm" id="btn_tgl_apiresp">Response</button> <button type="button" class="btn btn-default btn-sm" id="btn_tgl_interf">Collapse Toggle</button> </th> <th></th></tr> </thead>
        <tbody>
		<% 
		   var interfType = '';
		   lemon.each(apis, function(v, k) {
				if (v && !lemon.isBlank(v.request)) {
					if (interfType != v.type.id) {
						interfType = v.type.id;
		%>
			<tr onclick="api.interfType(<%= interfType %>)"> <th></th> <td> <h4><span class="label label-info"><span class="glyphicon glyphicon-flag"></span> <%= v.type.name %></span></h4> </td> </tr>
		<% } %>
		   <tr id="<%= k %>" type="<%= interfType %>">
            <th scope="row">
			</th>
			<td onDblClick="api.onSelect('<%= k %>', this)" ctype="2">
			<blockquote style="width:<%=clientW - 60%>px;">
				<% if (v.mutation > 0) { %> 
					<span class="label label-success"> <%= v.name %> Mutation </span> 
					<span class="text-success"  style="font-size:85%;"><%= lemon.repeat('&nbsp;', 3) %> <%= v.note %></span> 
				<% } %>
  				<p>
					<pre style="background-color:#ffffff;border:0px;" tgl-apirequ="tgl"><p class="pull-right text-muted">Request</p><%= lemon.json.highlight(v.request) %></pre>
				</p>
				<% if (!lemon.isBlank(v.response)) { %>
					<%= api.showResponse(v.response) %>					
				<% } %>
				<% if (0 == v.mutation) { %>				
					<%= api.showNote(v.note) %>
				<% } %>
				<footer>
					<%= v.name %> <cite><%= v.desc %></cite>
				</footer>
			</blockquote>
			</td>
			<td>
				<% if (0 == v.mutation) { %>
				<button type="button" class="btn btn-default btn-xs" style="border:0px;" onclick="api.setAPIDefaultVal('<%= v.name %>')" id="set_default_<%= v.name %>">
					<span class="glyphicon glyphicon-camera text-muted" title="Set API Default Value"></span>
				</button>
				<% } %>
				<% if (!lemon.isBlank(v.response)) { %>
				<button type="button" class="btn btn-default btn-xs" style="border:0px;" onclick="api.onSelectSinleClick(this, 3, 4)" clkey="<%= k %>">
					<span class="glyphicon glyphicon-eye-open text-muted" title="Toggle Request Response"></span>
				</button>
				<% } %>
				<button type="button" class="btn btn-default btn-xs" style="border:0px;" onclick="api.hisTglRequResp('<%= k %>', 3)" id="his_tgl_apirequ_<%= k %>">
					<span class="glyphicon glyphicon-tree-deciduous text-muted" title="Toggle Request"></span>
				</button>
				<% if (!lemon.isBlank(v.response)) { %>
					<button type="button" class="btn btn-default btn-xs" style="border:0px;" onclick="api.hisTglRequResp('<%= k %>', 4)" id="his_tgl_apiresp_<%= k %>">
					<span class="glyphicon glyphicon-leaf text-muted" title="Toggle Response"></span>
					</button>				
				<% } %>
				<button type="button" class="btn btn-default btn-xs" style="border:0px;" onclick="api.redefineAPI('<%= k %>')">
					<span class="glyphicon glyphicon-pencil text-muted" title="Define API"></span>
				</button>
			</td>
          </tr>
		<% }}); %>
        </tbody>
     </table>
	<% } %>

	<% if (showHisBtn) { %>
        <button type="button" class="btn btn-info btn-lg btn-block" id="btn_show_match_his">Show Match Histories</button>
	<% } %>

  	<% if (!lemon.isBlank(histories)) { %>
	<div id="his_table">
	<!-- Table -->
	<table class="table table-hover">
		<caption>History Request</caption>
        <thead> <tr> <th>#</th> <th>
			<div class="row">
  				<div class="col-md-6">

				<h4><span class="label label-info"><span class="glyphicon glyphicon-filter"></span> Request Response</span></h4>
				<button type="button" class="btn btn-default btn-sm" id="btn_tgl_requ"><span class="text-muted">Request</span></button> 
				<button type="button" class="btn btn-default btn-sm" id="btn_tgl_resp"><span class="text-muted">Response</span></button>
				<button type="button" class="btn btn-default btn-sm" id="btn_tgl_interval"><span class="text-muted">Collapse Toggle</span></button>
				<button type="button" class="btn btn-info btn-sm" id="btn_extract"> <span class="glyphicon glyphicon-tint"></span> Extract... </button>

				<h4><span class="label label-info"><span class="glyphicon glyphicon-filter"></span> Filter Favourite</span></h4>
				<button type="button" class="btn btn-default btn-sm" id="prop_filter_1">
				<span class="text-muted glyphicon glyphicon-star"></span> <span class="text-muted">Favourite</span></button>

				<h4>
					<span class="label label-info"><span class="glyphicon glyphicon-filter"></span> Filter Tags</span>
					<div class="input-group input-group-sm"> 
						<span class="input-group-addon" style="border:0px;"><span title="Toggle Tag Manage Bar" class="text-muted glyphicon glyphicon-tag"></span></span>
						<input type="text" class="form-control" style="border:0px;" placeholder="tag.." id="tag_input">
      					<span class="input-group-btn input-group-sm"> 
							<button class="btn btn-default btn-sm" style="border:0px;" type="button" id="tag_add"><span class="text-muted glyphicon glyphicon-plus"></span></button> 
							<button class="btn btn-default btn-sm" style="border:0px;" type="button" id="tag_edit"><span class="text-muted glyphicon glyphicon-edit"></span></button> 
							<button class="btn btn-default btn-sm" style="border:0px;" type="button" id="tag_rem"><span class="text-muted glyphicon glyphicon-minus"></span></button> 
						</span>
    				</div>
				</h4>
				<div id="tag_group">
				<%
					lemon.each(api.tag(), function(v, k) {
						var tagName = decodeURI(v.name);
						var aTag = [
							' <button type="button" onclick="api.ontag('+ v.id + ');"',
							' class="btn btn-default btn-sm" style="margin-top:5px;" ',
							' id="tag_filter_'+ v.id + '"><span class="text-muted"> ' + tagName + ' </span></button> '
                        ].join('');
				%>
				<%= aTag %>
				<%
					});
				%>
				</div>

				</div>
  				<div class="col-md-6">

					<h4><span class="label label-info"><span class="glyphicon glyphicon-filter"></span> Filter Environment</span></h4>
					<%
						lemon.each(api.preference.service(), function(v, k) {
					%>
						<button type="button" class="btn btn-default btn-sm" id="env_filter_<%= v.env %>"><span class="text-muted"><%= v.desc %></span></button>
					<%
						});
					%>

					<h4><span class="label label-info"><span class="glyphicon glyphicon-filter"></span> Filter Server</span></h4>
					<%
						lemon.each(api.preference.service(), function(env, k) {
					%>
						<h6><span class="label label-success"><span class="glyphicon glyphicon-hand-down"></span> <%= env.env %> </span></h6>
					<%
						lemon.each(env.serv, function(serv, k) {
							var servName = api.getInterfGroup(serv.type.id).name + (lemon.isBlank(serv.note) ? '' : (' - ' + serv.note));
					%>
							<button type="button" class="btn btn-default btn-sm" style="margin-top:5px;" id="filter_<%= serv.id %>"><span class="text-muted"><%= servName %></span></button>
					<%
							});
						});
					%>

				</div>
			</div>

			</th><th></th></tr> </thead>
        <tbody id="his_body">
		<%= theHisTrs %>
        </tbody>
     </table>
	</div>
	<% } %>
  </div>
</div>

</script>

<script type="text/html" id="his_tr_tmpl">
<% 
	if (!lemon.isBlank(histories)) {
		var no = intlNo - 1;
		var clientW = document.body.clientWidth - 110;
		if (lemon.isBlank(histories)) {
			clientW = clientW + 35;
		}
	    var panelH = document.body.clientHeight - 150;
	
	   var tmp = '';
	   var batch = 0;
	   lemon.each(api.historySortDesc(histories), function(v, k) {
		   var env = api.env.which(v.interf);
		   if (lemon.isBlank(env)) {
		   		env = {
					id: -1,
					env: 'UNKNOWN',
					desc: '',
					type: {
						id: -2,
						name: ''
					}
				};
		   }
		   no++, tmp = lemon.when.interval(v.when);
	       if (tmp != api.previousInterval.when) {
				batch = lemon.uniqueId();

				api.previousInterval = {
					when: tmp,
					batch: batch
				};			

				api.batches.push(batch);
		%>
				<tr onclick="api.interval(<%= batch %>)"> <th></th> <td> <h4><span class="label label-info"><span class="glyphicon glyphicon-time"></span> <%= api.previousInterval.when %></span></h4> </td> </tr>
		<%
		   } else {
				batch = api.previousInterval.batch;
		   }
		   
		%>
				<%
					var hisTags = api.customHis(v.k, 'tag') || [];
					var hisTagMark = [];
					var hisShowTags = [];
					lemon.each(hisTags, function(tagId, idx) {
						var aTag = api.tag(tagId);
						if (lemon.isBlank(aTag)) {
							api.customHis(v.k, 'tag', -1, tagId);
						} else {
							hisTagMark.push('tag' + tagId + '="' + tagId + '"');
							hisShowTags.push(api.elhistag(v.k, tagId, aTag.name));
						}
					});
				%>
	   <tr id="<%= v.k %>" batch="<%= batch %>" <%= hisTagMark.join(' ') %> interf="<%= env.id %>" env="<%= env.env %>" his="1" prop="<%= api.customHis(v.k,'fav') %>">
	          <th scope="row">
		</th>
	          <td onDblClick="api.onSelect('<%= v.k %>', this)" rapi="<%= v.api %>" ctype="1">
			<blockquote style="width:<%=clientW - 25%>px;">
				<div id="tag_area_<%= v.k %>"><%= hisShowTags.join(' ') %></div>
				<p>
					<pre style="background-color:#ffffff;height:100%;border:0px;" tgl-requ="tgl"><p class="pull-right text-muted">Request</p><%= lemon.json.highlight(v.request) %></pre>
					<pre style="background-color:#ffffff;height:100%;border:0px;" tgl-resp="tgl"><p class="pull-right text-muted">Response</p><%= lemon.json.highlight(v.response) %></pre>
				</p>
				<%
					var envDesc = env.desc + '  ' + env.type.name + (lemon.isBlank(env.note) ? '' : (' - ' + env.note));
					var theStyle = 'PRODUCT' === env.env ? 'danger' : 'success';
				%>
				<div id="show_note_<%= v.k %>">
				<% 
					var note = api.customHis(v.k, 'note') || '';
					if (!lemon.isBlank(note)) {
				%>
					<div class="alert alert-warning" role="alert" style="font-size:75%;"><%= note %></div>
				<% } %>
				</div>
				<footer><span class="badge"><%= no %></span> <font class="text-<%= theStyle %>"><%= envDesc %></font></footer>
				<footer>
					<%= (v.name || '') + '  ' + (v.api || '') %> 
					<cite><code><font class="text-<%= theStyle %>"><%= v.interf %></font></code><%= ' ' + v.when %></cite>
				</footer>
			</blockquote>
		</td>
		<td>
			<button type="button" class="btn btn-default btn-xs" style="border:0px;" onclick="api.historyAPIDesc(<%= v.k %>, '<%= v.api %>')" id="desc_<%= v.k %>">
				<span class="text-muted glyphicon glyphicon-question-sign" title="Show the Define API Description"></span>
			</button>
			<button type="button" class="btn btn-default btn-xs" style="border:0px;" onclick="api.onSelectSinleClick(this)" clkey="<%= v.k %>">
				<span class="text-muted glyphicon glyphicon-eye-open" title="Toggle Request Response"></span>
			</button>
			<button type="button" class="btn btn-default btn-xs" style="border:0px;" onclick="api.hisTglRequResp(<%= v.k %>, 1)" id="his_tgl_requ_<%= v.k %>">
				<span class="text-muted glyphicon glyphicon-tree-deciduous" title="Toggle Request"></span>
			</button>
			<button type="button" class="btn btn-default btn-xs" style="border:0px;" onclick="api.hisTglRequResp(<%= v.k %>, 2)" id="his_tgl_resp_<%= v.k %>">
				<span class="text-muted glyphicon glyphicon-leaf" title="Toggle Response"></span>
			</button>
			<button type="button" class="btn btn-default btn-xs" style="border:0px;" onclick="api.favourite(this, <%= v.k %>)">
				<% if (1 == api.customHis(v.k,'fav')) { %>
					<span class="text-muted glyphicon glyphicon-star" title="Toggle Favourite"></span>
				<% } else { %>
					<span class="text-muted glyphicon glyphicon-star-empty" title="Toggle Favourite"></span>
				<% } %>
			</button>
			<button type="button" class="btn btn-default btn-xs" style="border:0px;" onclick="api.pencil(<%= v.k %>, <%= no %>)" id="pencil_<%= v.k %>">
				<span class="text-muted glyphicon glyphicon-pencil" title="Note"></span>
			</button>
			<button type="button" class="btn btn-default btn-xs" style="border:0px;" onclick="api.itemTag(<%= v.k %>, <%= no %>)" id="tags_<%= v.k %>">
				<span class="text-muted glyphicon glyphicon-tags" title="Tags"></span>
			</button>
		</td>
	        </tr>
	<% }); }%>
</script>

<script type="text/html" id="setting_tmpl">
<%
	var clientW = document.body.clientWidth - 30;
    var panelH = document.body.clientHeight - 70;
%>
<div id="settings" style="height:<%=panelH%>px;max-height:<%=panelH%>px;width:<%=clientW%>px;">
    <ul id="" class="nav nav-tabs" role="tablist">
      <li role="presentation" class="">
      	<a href="#basic" id="basic-tab" role="tab" data-toggle="tab" aria-controls="basic" aria-expanded="true">Basic Setting</a>
      </li>
      <li role="presentation" class="">
      	<a href="#server" role="tab" id="server-tab" data-toggle="tab" aria-controls="server" aria-expanded="false">Define Server</a>
      </li>
      <li role="presentation" class="">
      	<a href="#theapic" role="tab" id="theapic-tab" data-toggle="tab" aria-controls="theapic" aria-expanded="false">Define API</a>
      </li>
      <li role="presentation" class="dropdown">
        <a href="#" id="import_export_tab" class="dropdown-toggle" data-toggle="dropdown" aria-controls="import_export_tab-contents">
        	Import & Export <span class="caret"></span>
        </a>
        <ul class="dropdown-menu" style="border:0px;" aria-labelledby="import_export_tab" id="import_export_tab-contents">
          <li><a href="#import_tab" role="tab" id="import_tab-tab" data-toggle="tab" aria-controls="import_tab">@Import</a></li>
          <li><a href="#export_tab" role="tab" id="export_tab-tab" data-toggle="tab" aria-controls="export_tab">@Export</a></li>
        </ul>
      </li>
      <li role="presentation">
      	&nbsp; <button type="button" class="btn btn-info btn-xs" onclick="api.preference.close();"> <span class="glyphicon glyphicon-log-out" title="Tags"></span> Discard Changes</button>
      </li>
    </ul>

    <div id="myTabContent" class="tab-content" style="overflow-y:auto;height:550px;">
      <div id="message_settings"></div>
      <div role="tabpanel" class="tab-pane fade in" id="basic" aria-labelledby="basic-tab">
        <div class="row" style="margin: 0 5px;">

		  <div class="col-md-4">
		  	<h4>Interface Group</h4>
		  	<div class="panel panel-default">
			  <div class="panel-body">
			    <textarea id="p_interf" style="border:0px solid #ffffff;width:368px;height:450px;"></textarea>
			  </div>
			</div>
		  </div>
		  
		  <div class="col-md-4">
		  	<h4>Environment</h4>
		  	<div class="panel panel-default">
			  <div class="panel-body">
			    <textarea id="p_env" style="border:0px solid #ffffff;width:368px;height:450px;"></textarea>
			  </div>
			</div>
		  </div>

		  <div class="col-md-4">
		  	<h4>Configuration</h4>
		  	<div class="panel panel-default">
			  <div class="panel-body">
			    <textarea id="p_config" style="border:0px solid #ffffff;width:368px;height:450px;"></textarea>
			  </div>
			</div>
		  </div>

		</div>
      </div>
      <div role="tabpanel" class="tab-pane fade" id="server" aria-labelledby="server-tab">

      </div>
      <div role="tabpanel" class="tab-pane fade active" id="theapic" aria-labelledby="theapic-tab">

      </div>
      <div role="tabpanel" class="tab-pane fade" id="import_tab" aria-labelledby="import_tab-tab">

		<h4></h4>
        <h1>
		<div class="btn-group pull-right">
			<button type="button" class="btn btn-info btn-lg" onclick="api.impexp.load();" id="btn_imp"> 
				<%= lemon.repeat('&nbsp;', 3) %> <span class="glyphicon glyphicon-import" title="Import"></span> Import <%= lemon.repeat('&nbsp;', 3) %>
			</button>
		</h1>        
		<input type="file" id="imp_file" class="hidden"/>

      </div>
      <div role="tabpanel" class="tab-pane fade" id="export_tab" aria-labelledby="export_tab-tab">

		<h4></h4>
        <h1>
		<div class="btn-group pull-right">
			<button type="button" class="btn btn-info btn-lg" onclick="api.impexp.doexport(this);"> 
				<%= lemon.repeat('&nbsp;', 3) %> <span class="glyphicon glyphicon-export" title="Export"></span> Export <%= lemon.repeat('&nbsp;', 3) %>
			</button>
			<button type="button" class="btn btn-info btn-lg dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
				<span class="caret"></span>
				<span class="sr-only">Toggle Dropdown</span>
			</button>
			<ul class="dropdown-menu" style="border:0px;">
				<li role="separator" class="divider"></li>
				<li><a href="javascript:void(0);"  onclick="api.impexp.doexport(this, 2);">
					<span class="glyphicon glyphicon-export" title="Export"></span> Export as Human Readable
				</a></li>
				<li role="separator" class="divider"></li>
				<li><a href="javascript:void(0);"  onclick="api.impexp.doexport(this, 3);">
					<span class="glyphicon glyphicon-export" title="Export"></span> Export as data center configuration
				</a></li>
				<li role="separator" class="divider"></li>
			</ul>
		</div>
		</h1>

		<p>&nbsp;</p>
		<div id="export_option" class="list-group" style="width:50%">
			<button type="button" class="list-group-item btn btn-default active" id="exp_basic"> 
			<span class="glyphicon glyphicon-check" title="Basic Setting"></span> Basic Setting </button>
			<p></p>
			<button type="button" class="list-group-item btn btn-default active" id="exp_server"> 
			<span class="glyphicon glyphicon-check" title="Define Server"></span> Define Server </button>
			<p></p>
			<button type="button" class="list-group-item btn btn-default active" id="exp_api"> 
			<span class="glyphicon glyphicon-check" title="Define API"></span> Define API </button>
			<p></p>
			<button type="button" class="list-group-item btn btn-default active" id="exp_mutate"> 
			<span class="glyphicon glyphicon-check" title="Define API Mutation"></span> Define API Mutation</button>
			<p></p>
			<button type="button" class="list-group-item btn btn-default active" id="exp_dft"> 
			<span class="glyphicon glyphicon-check" title="Define API Default Value"></span> Define API Default Value </button>
			<p></p>
			<button type="button" class="list-group-item btn btn-default active" id="exp_cust"> 
			<span class="glyphicon glyphicon-check" title="Request History Note & Tag & Favourite"></span> Request History Note & Tag & Favourite </button>
			<p></p>
			<button type="button" class="list-group-item btn btn-default" id="exp_note"> 
			<span class="glyphicon glyphicon-unchecked" title="Notes"></span> Notes </button>
			<p></p>
			<button type="button" class="list-group-item btn btn-default" id="exp_history"> 
			<span class="glyphicon glyphicon-unchecked" title="Request History"></span> Request Histories </button>
		</div>

      </div>
    </div>
 </div>
</script>

<script type="text/html" id="setting_server_tmpl">

<div class="row" style="margin: 0 5px;">

<div class="col-md-6" id="p_server_left">
	<h4></h4>
<form>

<div class="btn-group" role="group" aria-label="...">
  <div class="btn-group" role="group">
    <select class="form-control" id="ss_env" name="env">
		<%
			lemon.each(api.preference.env().environment, function(env, idx)	{
		%>
    		<option value="<%= env.env %>"><%= env.desc %></option>
		<%	}); %>
    </select>
  </div>&nbsp;
  <span class="glyphicon glyphicon-pencil" aria-hidden="true" title="Define Environment" onclick="api.redefineEnvInterfG(1);"></span>
</div>

	<%= lemon.repeat('&nbsp;', 1) %>
    
<div class="btn-group" role="group" aria-label="...">
  <div class="btn-group" role="group">
    <select class="form-control" id="ss_interf" name="typeId">
		<%
			lemon.each(api.preference.interf(), function(group, idx)	{
		%>
    		<option value="<%= group.id %>"><%= group.name %></option>
		<%	}); %>
    </select>
  </div>&nbsp;
  <span class="glyphicon glyphicon-pencil" aria-hidden="true" title="Define Interface Group" onclick="api.redefineEnvInterfG(2);"></span>
</div>

	<%= lemon.repeat('&nbsp;', 1) %>
	<button type="button" class="btn btn-info" id="ss_default">
		<span class="glyphicon glyphicon-unchecked" aria-hidden="true"></span>  Default
	</button>
	<%= lemon.repeat('&nbsp;', 1) %>
	<button type="button" class="btn btn-default" onclick="api.preference.help(this);" title="Show Server Define Help">
		<span class="glyphicon glyphicon-question-sign" aria-hidden="true"></span>
	</button>
	<button type="button" class="btn btn-default" onclick="api.preference.newServId();" title="New Server ID">
		<span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
	</button>
</form>
	<h5> </h5>
	<textarea id="ss_server" style="border:0px solid #ffffff;width:580px;height:221px;"></textarea>
	<h5> </h5>
</div>

<div class="col-md-6" style="overflow-y:auto;height:550px;" id="p_server_right">
<%
lemon.each(api.preference.service(), function(envGroup, k) { 
	var isProduct = 'PRODUCT' === envGroup.env;
	var clazz = isProduct ? 'danger' : 'info';
	lemon.each(api.env.servSortEsc(envGroup.serv), function(serv, k) {
		var servGroup = api.getInterfGroup(serv.type.id);
		var servName = lemon.repeat('&nbsp;', 1) + servGroup.name;
		var showServ = lemon.clone(serv); delete showServ.type;
		if (showServ.asDefault) {
			delete showServ.asDefault;
		}
%>
			<div class="thumbnail" tenv="<%=envGroup.env%>" tgroup="<%= serv.type.id %>" tid="<%= serv.id %>">
      			<div class="caption">
        			<p>
						<span class="badge"><%= serv.id %></span>
						<code><font class="text-<%= clazz %>""> <%= envGroup.desc %><%= servName %> </font></code>
						<% if (serv.asDefault && 1 === serv.asDefault) { %>
							<span class="label label-info pull-right">Default Server</span>
						<% } %>
					<p>
					<pre style="border:0px solid #ffffff;background-color:#ffffff;"><%= lemon.json.highlight(showServ) %></pre>
      			</div>
    		</div>
	<% }); %>
<% }); %>

</div>
</div>
</script>

<script type="text/html" id="setting_apic_tmpl">
<div class="row" style="margin: 0 5px;">
	<div class="col-md-8" id="p_apic_left">
		<h4></h4>
		<blockquote>
			<form>
<%= lemon.repeat('&nbsp;', 2) %>
<div class="btn-group" role="group" aria-label="...">
  <div class="btn-group" role="group">
    <select class="form-control" id="sa_interf" name="apiTypeId"> 
		<% lemon.each(api.preference.interf(), function(group, idx) { %>
			<option value="<%= group.id %>"><%= group.name %></option> 
		<% }); %>
	</select>
  </div>&nbsp;
  <span class="glyphicon glyphicon-pencil" aria-hidden="true" title="Define Interface Group" onclick="api.redefineEnvInterfG(2);"></span>
</div>
<%= lemon.repeat('&nbsp;', 4) %>
	<button type="button" class="btn btn-info" onclick="api.defineMutation();" id="btn_mutation" title="Define as Mutation">
		<span class="glyphicon glyphicon-unchecked"></span> Define as Mutation 
	</button>
<%= lemon.repeat('&nbsp;', 4) %>
	<div class="btn-group" id="apic_env_container"></div>
			</form>
			<h4></h4>
			<textarea id="sa_apic" style="border: 0px solid #ffffff; width: 790px; height: 380px;"></textarea>
			<footer> The property "note": [ <cite>string | string array | JSON</cite> ] </footer>
		</blockquote>
	</div>
	<div class="col-md-4" id="p_apic_right">
	</div>
</div>
</script>

<script type="text/html" id="cross_source_tmpl">
<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport"
	content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<meta name="format-detection" content="telephone=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<title>API Configuration</title>
</head>
<body>
    <%= decodeURI('%3Cscript%20%20type=%22text/javascript%22%3E') %>
	var put = function(cfg) {
		window.name = cfg;
		try {
			var target = parent.postMessage ? parent : (parent.document.postMessage ? parent.document : undefined);

			if (typeof target != "undefined") {
				target.postMessage(cfg, "*");
			}
		} catch (e) {/**/}
	};
	var defines = <%= rapicfg %>;
	put(defines);
    <%= decodeURI('%3C/script%3E') %>
</body>
</html>
</script>
		
<script type="text/html" id="note_tool_tmpl">
<nav class="navbar navbar-default" id="note_tool_bar" style="margin-bottom:0px;border:0px;background-color:#ffffff">
  <div class="container-fluid">
      <ul class="nav navbar-nav">
        <li class="dropdown">
          <a href="javascript:void(0);" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">File</a>
          <ul class="dropdown-menu" style="border:0px;">
            <li><a href="javascript:void(0);" onclick="note.newNote();" title=":new"><%= note.menu('New', ':n', 'visual') %></a></li>
            <li><a href="javascript:void(0);" onclick="note.openFile();" title=":open"><%= note.menu('Open File...', ':o', 'visual') %></a></li>
			<li role="separator" class="divider"></li>
			<li><a href="javascript:void(0);" onclick="note.menuTgl();" title="Mouse move top toggle menu"><%= note.menu('Close Menu', ':menu', 'visual') %></a></li>
			<li><a href="javascript:void(0);" onclick="note.close();" title="Close Note"><%= note.menu('Close Note', ':q', 'visual') %></a></li>
			<li role="separator" class="divider"></li>
			<li><a href="javascript:void(0);" onclick="note.save();" title="Save Note"><%= note.menu('Save Note', ':w', 'visual') %></a></li>
			<li><a href="javascript:void(0);" onclick="note.saveclose();" title="Save & Close Note"><%= note.menu('Save & Close Note', ':wq', 'visual') %></a></li>
			<li><a href="javascript:void(0);" onclick="note.save(null, 1);" title="Save As..."><%= note.menu('Save As...', ':sa', 'visual') %></a></li>
			<li><%= lemon.repeat('&nbsp;', 80) %></li>
          </ul>
        </li>

		<li class="dropdown">
          <a href="javascript:void(0);" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Edit</a>
          <ul class="dropdown-menu" style="border:0px;" id="note_edit">
            <li><a href="javascript:void(0);" ex="undo" title=":undo"><%= note.menu('Undo', 'u', 'visual') %></a></li>
            <li><a href="javascript:void(0);" ex="redo" title=":redo"><%= note.menu('Redo', 'Ctrl-R', 'visual') %></a></li>
			<li role="separator" class="divider"></li>
			<li><a href="javascript:void(0);" func="editMode" title=""><%= note.menu('Edit Mode', 'i', 'visual') %></a></li>
			<li><a href="javascript:void(0);" func="visualMode" title=""><%= note.menu('Visual Mode', 'Esc', 'edit') %></a></li>
			<li role="separator" class="divider"></li>
			<li><a href="javascript:void(0);" func="wordwrap" title=":wrapword"><%= note.menu('Word Wrap', ':wrap', 'visual') %></a></li>
			<li><a href="javascript:void(0);" cmd="toggleComment" title=""><%= note.menu('Toggle Comment', 'Ctrl-/', 'visual & edit') %></a></li>
			<li><a href="javascript:void(0);" func="tglFoldCode" title=""><%= note.menu('Toggle Fold Code', 'Ctrl-Q', 'visual & edit') %></a></li>
			<li><a href="javascript:void(0);" cmd="autocomplete" title=""><%= note.menu('Content Assist', 'Ctrl-J', 'visual & edit') %></a></li>
			<li><a href="javascript:void(0);" cmd="toMatchingTag" title=""><%= note.menu('Matching Tag', 'Ctrl-K', 'visual & edit') %></a></li>
			<li role="separator" class="divider"></li>
			<li><a href="javascript:void(0);" cmd="selectAll" title="Select All"><%= note.menu('Select All', 'Ctrl-A', 'visual & edit') %></a></li>
			<li><a href="javascript:void(0);" cmd="find" title="/"><%= note.menu('Find...', 'Cmd-F', 'edit') %></a></li>
			<li><a href="javascript:void(0);" cmd="findNext" title="n"><%= note.menu('Find Next', 'Cmd-G', 'edit') %></a></li>
			<li><a href="javascript:void(0);" cmd="replace" title=":%s/"><%= note.menu('Replace...', 'Cmd-Alt-F', 'edit') %></a></li>
			<li><a href="javascript:void(0);" cmd="replaceAll" title=":%s/"><%= note.menu('Replace All', 'Shift-Cmd-Alt-F', 'edit') %></a></li>
			<li><%= lemon.repeat('&nbsp;', 80) %></li>
          </ul>
        </li>

		<li class="dropdown">
          <a href="javascript:void(0);" id="note_list_dd" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Note</a>
          <ul class="dropdown-menu fixed-dropdown" style="max-width: 400px;border:0px;" id="note_list">
			<div class="form-group form-group-lg" style="margin-left:15px;margin-bottom:15px;margin-top:15px;"> <div class="col-sm-12">
      		<input class="form-control" type="text" id="note_list_qry" style="width:300px;" placeholder="Search Note..."> </div> </div>
			<% lemon.each(note.listNote(), function(n, idx) { var cnid = note.instance.noteId || -1; %>
				<li nid="<%= n.id %>" id="note_<%= n.id %>" note="1"><blockquote style="width:380px;" title="" class="">
					<h4 class="text-info"><%= n.title %><% if (cnid == n.id) { %><span class="pull-right text-danger glyphicon glyphicon-check"></span><% } %></h4>
					<h6 class="text-muted">Created <%= '  ' + n.create %></h6> <h6 class="text-muted">Modified <%= ' ' + n.lastmodify %></h6>
					<h6 class="text-muted"> <span class="badge"><%= n.id %></span> <div class="btn-group pull-right" role="group" aria-label="..."> <button type="button" title="Delete Note <%= n.title %>" id="note_rem_<%= n.id %>" nt="<%= n.title %>" nid="<%= n.id %>" style="border:0px;" class="btn btn-default"> <span class="text-danger glyphicon glyphicon-remove-circle"></span> </button> </div> </h6>
				</blockquote></li>
			<% }); %>
          </ul>
        </li>

		<li class="dropdown">
          <a href="javascript:void(0);" id="note_mode_dd" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Language</a>
          <ul class="dropdown-menu fixed-dropdown" style="max-width: 400px;border:0px;" id="note_mode">
			<div class="form-group form-group-lg" style="margin-left:15px;margin-bottom:15px;margin-top:15px;"> <div class="col-sm-12">
      		<input class="form-control" type="text" id="note_mode_qry" style="width:300px;" placeholder="Search Language..."> </div> </div>
			<% lemon.each(notesource.langs, function(lang, langname) { %>
				<li name="<%= langname %>" id="lang_<%= lang.id %>" lang="1">
				<blockquote style="width:380px;" title="" class="">
					<h4 class="text-success"><%= langname %><% if (langname == note.storecfg('language')) { %><span class="pull-right text-danger glyphicon glyphicon-check"></span><% } %></h4>
					<div class="row">
					<div class="col-md-8">
					<% if ('null' != lang.mime || (lang.mimes && lang.mimes.length > 0)) { %> <h5><p class="text-muted"> Defined MIME types </p></h5> <% } %>
					<% if (lang.mimes && lang.mimes.length > 0) { lemon.each(lang.mimes, function(mime, i2) { %> <h5 class="text-muted"><a href="javascript:void(0);" clk="1" val="<%= mime %>"><%= mime %></a></h5> <% }); } else if ('null' != lang.mime) { %> <h5 class="text-muted"><a href="javascript:void(0);" clk="1" val="<%= lang.mime %>"><%= lang.mime %></a></h5> <% } %>
					</div> <div class="col-md-4">
					<% if (lang.ext && lang.ext.length > 0) {  %> <h5><p class="text-muted"> Extensions </p></h5> <% lemon.each(lang.ext, function(ext, idx) { %> <h5 class="text-muted"><a href="javascript:void(0);" clk="1" val="<%= ext %>"><%= ext %></a></h5> <% }); }%>
					</div>
					</div>
				</blockquote>
				</li>
			<%
			});
			%>
			<li><%= lemon.repeat('&nbsp;', 60) %></li>
          </ul>
        </li>

		<li class="dropdown">
          <a href="javascript:void(0);" id="note_theme_dd" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Theme</a>
          <ul class="dropdown-menu fixed-dropdown" style="border:0px;" id="note_theme"> <% lemon.each(notesource.themes, function(th, idx) { %>
		  <li th="<%= th %>"> <blockquote style="" title="" class=""> <h5 class="text-success"><%= th %><% if (th == note.storecfg('theme')) { %> <span class="pull-right text-danger glyphicon glyphicon-check"></span><% } %></h5> </blockquote> </li> <% }); %>
		  <li><%= lemon.repeat('&nbsp;', 60) %></li>
          </ul>
        </li>

		<li>
		<a href="javascript:void(0);" id="note_compare" role="button" aria-haspopup="true" aria-expanded="false">Compare</a>
		</li>

      </ul>
      <ul class="nav navbar-nav navbar-right">
		<li><a href="javascript:void(0);" class="close" title="Close Menu" aria-label="Close" onclick="note.menuTgl();"><span aria-hidden="true">-</span></a></li>
		<li><a href="javascript:void(0);" class="close" title="Close" aria-label="Close" onclick="note.close();"><span aria-hidden="true"></span></a></li>
      </ul>
  </div>
</nav>
</script>

<script type="text/html" id="note_merge_menu_tmpl">
<nav class="navbar navbar-default navbar-fixed-top" id="nav_merge" style="margin-bottom:0px;border:0px;background-color:#ffffff">
  <div class="container-fluid">
      <ul class="nav navbar-nav">

		<li class="dropdown">
          <a href="javascript:void(0);" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">File</a>
          <ul class="dropdown-menu" style="border:0px;" id="note_edit">
            <li> <a href="javascript:void(0);" onclick="note.diff.loadLeft();" role="button" aria-haspopup="true" aria-expanded="false">Open File for Left...</a> </li>
			<li> <a href="javascript:void(0);" onclick="note.diff.loadRight();" role="button" aria-haspopup="true" aria-expanded="false">Open File for Right...</a> </li>
			<li role="separator" class="divider"></li>
			<li> <a href="javascript:void(0);" onclick="note.diff.saveNote();" role="button" aria-haspopup="true" aria-expanded="false">Save Note</a> </li>
			<li> <a href="javascript:void(0);" onclick="note.diff.saveasNewNote();" role="button" aria-haspopup="true" aria-expanded="false">Save As New Note</a> </li>
			<li> <a href="javascript:void(0);" onclick="note.diff.saveas();" role="button" aria-haspopup="true" aria-expanded="false">Save As...</a> </li>
			<li><%= lemon.repeat('&nbsp;', 60) %></li>
          </ul>
        </li>

		<li><li> <a href="javascript:void(0);" title="Open File for Left..." onclick="note.diff.loadLeft();" role="button" aria-haspopup="true" aria-expanded="false">Left <span class="text-success glyphicon glyphicon-option-horizontal"></span></a></li>
		<li><li> <a href="javascript:void(0);" title="Open File for Right..." onclick="note.diff.loadRight();" role="button" aria-haspopup="true" aria-expanded="false">Right <span class="text-success glyphicon glyphicon-option-horizontal"></span></a></li>
		<li><li> <a href="javascript:void(0);" title="Next Different Section" onclick="note.diff.next();" role="button" aria-haspopup="true" aria-expanded="false">Next <span class="text-success glyphicon glyphicon-circle-arrow-down"></span></a></li>
		<li><li> <a href="javascript:void(0);" title="Previous Different Section" onclick="note.diff.prev();" role="button" aria-haspopup="true" aria-expanded="false">Prev <span class="text-success glyphicon glyphicon-circle-arrow-up"></span></a></li>

      </ul>
      <ul class="nav navbar-nav navbar-right">
		<li><button type="button" class="btn btn-info btn-xs" style="margin-top:15px;" title="Toggle Three Panes" onclick="note.diff.threeway();" id="btn_threeway"><span class="glyphicon glyphicon-unchecked"></span> Panes</button></li>
		<li style="margin-left:15px;"><button type="button" class="btn btn-info btn-xs" style="margin-top:15px;" title="Toggle Collapse Unchanged Stretches of Text" onclick="note.diff.collapse();" id="btn_collapse"><span class="glyphicon glyphicon-unchecked"></span> Collapse</button></li>
		<li id="li_to_note" style="display:none;"> <a href="javascript:void(0);" title="Note" role="button" aria-haspopup="true" aria-expanded="false"><span class="glyphicon glyphicon-th-list"></span></a> </li>
		<li><a href="javascript:void(0);" class="close" title="Close" aria-label="Close" onclick="note.diff.close();"><span aria-hidden="true"></span></a></li>
      </ul>
  </div>
</nav>
</script>

<script type="text/html" id="extract_base_tmpl">
<form class="form-inline" id="<%= cid %>">
<h4>
<span class="label label-info"><span class="glyphicon glyphicon-filter"></span> Matches</span>
<select class="form-control btn-sm" name="symbol"> 
	<option value="&">AND</option>
	<option value="|">OR</option>
</select>
<button type="button" class="btn btn-default" onclick="api.advqry.addCond('<%= cid %>');"><span class="text-muted glyphicon glyphicon-plus"></span></button>
<button type="button" class="btn btn-default" cid="<%= cid %>" onclick="api.advqry.camera(this);"><span class="text-muted glyphicon glyphicon-camera"></span></button>
</h4>
</form>
<h4></h4>
</script>
<script type="text/html" id="extract_tmpl">
<div ex="filter" idx="<%= index %>" id="ex_filter_<%= index %>">
<h4></h4>
<select class="form-control" name="op<%= index %>"> 
	<option value="both">Request OR Response</option>
	<option value="requ">Request</option>
	<option value="resp">Response</option>
</select>
<input type="text" class="form-control" name="key<%= index %>" placeholder="'s property">
<input type="text" class="form-control" name="val<%= index %>" placeholder="like this value">
<button type="button" class="btn btn-default" onclick="api.advqry.remCond('<%= index %>');"><span class="text-muted glyphicon glyphicon-minus"></span></button>
</div>
</script>
<script type="text/html" id="extract_prop_base_tmpl">
<form class="form-inline" id="<%= cid %>">
<h4>
<span class="label label-info"><span class="glyphicon glyphicon-filter"></span> Extract Properties</span>
<button type="button" class="btn btn-default" onclick="api.advqry.addProp('<%= cid %>');"><span class="text-muted glyphicon glyphicon-plus"></span></button>
<button type="button" class="btn btn-primary pull-right" cid="<%= cid %>" pid="<%= parentCid %>" onclick="api.advqry.extract2note(this);"><span class="glyphicon glyphicon-tint"></span> Extract to Note</button>
</h4>
</form>
<h4></h4>
</script>
<script type="text/html" id="extract_prop_tmpl">
<div ex="prop" idx="<%= index %>" id="ex_prop_<%= index %>">
<select class="form-control" name="op<%= index %>"> 
	<option value="requ">Request</option>
	<option value="resp">Response</option>
</select>
<input type="text" class="form-control" name="key<%= index %>" id="fname_key_<%= index %>" onkeyup="api.advqry.chgProp(this);" placeholder="'s property">
<input type="text" class="form-control" name="val<%= index %>" id="fname_val_<%= index %>" placeholder="as filed name...">
<button type="button" class="btn btn-default" onclick="api.advqry.remProp('<%= index %>');"><span class="text-muted glyphicon glyphicon-minus"></span></button>
</div>
</script>

<script type="text/html" id="share_opt_tmpl">
	<div id="share_option" class="list-group">
		<button type="button" style="border:0px;" class="list-group-item btn btn-default" id="share_min" stype="1"> 
		<span class="glyphicon glyphicon-hand-right" title="Readonly"></span> &nbsp;&nbsp; Minimum </button>
		<p></p>
		<button type="button" style="border:0px;" class="list-group-item btn btn-default" id="share_minhelp" stype="2"> 
		<span class="glyphicon glyphicon-hand-right" title="Readonly & API help"></span> &nbsp;&nbsp; Readonly & API help </button>
		<p></p>
		<button type="button" style="border:0px;" class="list-group-item btn btn-default" id="share_one" stype="3"> 
		<span class="glyphicon glyphicon-hand-right" title="Editable & Unload defines"></span> &nbsp;&nbsp; Editable & Unload defines </button>
		<p></p>
		<button type="button" style="border:0px;" class="list-group-item btn btn-default" id="share_max" stype="4"> 
		<span class="glyphicon glyphicon-hand-right" title="Share Maximum"></span> &nbsp;&nbsp; Maximum </button>
	</div>
</script>

<!-- {title:'', content: '', triggerId: '', modalDialogClass: 'modal-sm'} -->
<script type="text/html" id="modal_tmpl">
<% var titleLabel = 'title_' + lemon.uniqueId(); %>
<div class="modal fade" id="<%= triggerId %>" tabindex="-1" role="dialog" aria-labelledby="<%= titleLabel %>">
  <div class="modal-dialog <%= modalDialogClass %>">
    <div class="modal-content">
	 <% if (!lemon.isBlank(title)) { %>
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true"></span></button>
        <h6 class="modal-title" id="<%= titleLabel %>"><%= title %></h6>
      </div>
	 <% } %>
      <div class="modal-body">
		<% var theContent = content; if (lemon.isFunc(content)) { theContent = content(); } %>
        <%= theContent %>
      </div>
    </div>
  </div>
</div>
</script>
						
<script type="text/javascript">
	root = window;
	lemon.addDateMask({
		tiny: 'yyyymmddHHMMss',
		mark: 'yyyymmddHHMMss.l'
	});
	lemon.console();
	lemon.getset({
		env: null,
		api: null
	});
	
	var api = api || {
		batches: [],
		intialized: false,
		previousInterval: {
			when: '',
			batch: 0
		},
		analyze: [
		  	//a:3,b:4
			{ id: 1, sep: ',', subsep: ':' },
			//a=3,b=4
			{ id: 2, sep: ',', subsep: '=' },
			//a=3&b=4
			{ id: 3, sep: '&', subsep: '=' },
			//a:3&b:4
			{ id: 4, sep: '&', subsep: ':' },
			//a=3;b=4
			{ id: 5, sep: ';', subsep: '=' },
			//a:3;b:4
			{ id: 6, sep: ';', subsep: ':' }
		],
		initialize: function() {
			this.env.render();
			this.cmd.render();
			this.nav.render();
			this.mod.render();
			this.intialized = true;
			/*root.onbeforeunload = function() {
				return 'Leaving ...';
			}*/
		},
		hash: {
			curHisId: null,
			to: function(pg) {
				location.hash = lemon.startIf(pg, '#');
			},
			requ: function(api, hisId) {
				this.to(lemon.format('#api/{0}/{1}.{2}', api, lemon.when.mark(), hisId));
			},
			apid: function(api, mutateOrServId) {
				this.to(lemon.format('#apid/{0}/{1}{2}', api, lemon.when.mark(), (lemon.isUndefined(mutateOrServId) ? '' : ('.' + mutateOrServId))));
			},
			snap: function(data, shareType) {
				api.hash.localtrigger = 1;
				this.to(lemon.format('#snap/{0}/{1}', lemon.when.mark(), data || api.hash.snapshoot(shareType)));
			},
			snapshoot: function(shareType) {
				var aserv = api.env.which(lemon.getEnv());
				if (-10 != aserv.id) {
					aserv = api.getServer(aserv.id);
				}
				
				var data = {
					api: lemon.getApi(),
					name: api.getAPI(lemon.getApi()).desc,
					serv: aserv,
					requ: lemon.json.reverse(api.requ()),
					resp: lemon.json.reverse(api.resp())
				};
				
				if (shareType) {
					data.share = {
						type: parseInt(shareType)
					};

					if (!lemon.isBlank(data.api)) {
						data.share.dapi = api.getAPI(data.api);
					}
					
					switch(data.share.type) {
					// Readonly (Minimum)
					case 1:
						data.share.dapi = null;
						break;
					// Readonly & API help
					case 2:
						break;
					// Editable & unload defines
					case 3:
						break;
					// Share Maximum
					case 4:
						break;
					}
				}
				
				return LZString.compressToEncodedURIComponent(lemon.json.reverse(data));
			},
			page: function(pg) {
				try {
					var args = pg.split('/'), component = '.navbar,#left_toolbar,#right_toolbar';
					switch(args[0]) {
					case 'api': 
						var hid = args[2].substring(19);
						api.apichg(hid); 
						api.hash.curHisId = parseInt(hid);
						api.enable(component); $('#copy_url,#share_this').show();
					break;
					case 'apid':
						var mid = args[2].substring(19);
						api.apichg(lemon.format('api_{0}{1}', args[1], (lemon.isBlank(mid) ? '' : ('_' + mid))));
						api.enable(component); $('#copy_url,#share_this').show();
						break;
					case 'snap':
						var capture = $.parseJSON(LZString.decompressFromEncodedURIComponent(args[2]));
						api.nav.title(capture.api);
						api.requ(lemon.json(capture.requ));
						api.resp(lemon.json(capture.resp));
						lemon.setEnv(capture.serv.interf);
						var existServ = api.env.which(capture.serv.interf);
						if (-10 == existServ.id) {
							existServ = null;
						}
						api.env.changeEnv(existServ || capture.serv);
						var typeId = api.env.which(capture.serv.interf).type.id;
						lemon.setApi(capture.api);
						if (typeId > 0) {
							api.env.dorender(typeId);
						}
						api.chgJSONPView();

						if (api.hash.localtrigger) {
							
						} else {
							if (capture.share) {
								api.hash.localtrigger = 0;
								api.hash.capture = capture;
								$('#copy_url,#share_this').hide();
								switch(api.hash.capture.share.type) {
								// Readonly (Minimum)
								case 1:
									api.disable(component);
									break;
								// Readonly & API help
								case 2:
									api.disable(component.replace(',#left_toolbar', ''));
									api.disable($('#left_toolbar button').not('#api_define'));
									break;
								// Editable & unload defines
								case 3:
									break;
								// Share Maximum
								case 4:
									break;
								}
							} else {
								api.disable(component);
							}
						}

						after.rich.fitSize(after.request);
						after.rich.fitSize(after.response);
						break;
					default: api.tip('Unknow action ' + pg); break;
					}
				} catch(e) {
					api.tip('Unknow action ' + pg + ' ' + e.message);
				}
			}
		},
		nav: {
			render: function() {
				api.nav.navTitle();
				$('.dropdown-toggle').dropdown();

				$('#btn_request').click(function() {
					if (!api.isServSupportJSONP()) { return; }
					if (!api.chkRequest()) { return; }
					api.progressHome();
					api.resp('');
					api.request(function(data) {
						api.resp(lemon.json(data));
						api.progressHomeEnd();
					}, function() {
						api.progressHomeEnd();
					});
				});

				api.requestGetPost('#btn_request_post');
				api.requestGetPost('#btn_request_get', 'get');

				$('#btn_request_tab').click(function() {
					if (!api.chkRequest()) { return; }
					var cleanData = api.getCleanRequestData();
					var param = api.getRequestData(cleanData);
					var rapi = api.getCurrentAPI(cleanData);
		        	lemon.store.set(api.uniqueId(), {
			        	api: rapi,
		 				when: lemon.when(),
		 				request: cleanData, 
		 				response: null,
		 				interf: lemon.getEnv(),
		 				name: api.getAPI(rapi).desc
		 			});
					
					window.open(api.nav.getRequestURLwithParams(lemon.json.reverse(param), true));
				});

				$('#as_default').click(function() {
					var data = api.getCleanRequestData();
					var capi = api.getCurrentAPI(data);
					if (!lemon.isBlank(capi)) {
						api.defaultValue(capi, data);
						api.inlineTip('#as_default');
					}
				});

				var fromUrlModal = api.nav.newModal({
					title: 'Set Join Selection Separator', 
					triggerId: 'from_url_modal',
					content: function() {
						return [
							'<div class="input-group input-group-lg">',
							'<input type="text" id="input_sep" class="form-control" style="width:265px;" placeholder="Separator default is \',\'">',
							'</div>'
						].join('');
					},
					onHidden: function() {
						lemon.joinsep = $('#input_sep').val();
					}
				});
				api.nav.rightclick('#from_url', function() {
					lemon.delay(function() {
						fromUrlModal.toggle();
					}, 100);
				});
				
				$('#from_url').click(function() {
					if (after.styled && after.request.somethingSelected()) {
						var sel = after.request.getSelection();
						if (!lemon.isBlank(sel)) {
							var join = [], tmp = null;
							lemon.each(sel.split(/\s/), function(v, idx) {
								if (!lemon.isBlank(tmp = lemon.trim(v))) {
									join.push(tmp);
								}
							});
						}
						after.request.replaceSelection(join.join(lemon.joinsep || ','));
						return false;
					}
					
					var data = api.requ();
					var decodeData = api.decode(data, 2);
					if (data != decodeData) {
						api.requ(api.decode(data, 2));
					}
					
					var data = api.strAsJSON(data); 
					if (data.url) {
						lemon.setEnv(data.url);
						api.env.change(data.url);
					}
					
					api.requ(lemon.json(data.param));

					var apiTmp = null;
					if (lemon.isBlank(data.url)) {
						
					} else {
						//-10
						var sinfo = api.env.which(data.url);
						if (-10 == sinfo.id) {
						} else {
							var rcfg = sinfo.request;
							if (rcfg && 1 == rcfg.type) {
								apiTmp = api.getRequestAPI(data.param[rcfg.paramName] || {});
								api.requ(lemon.json(data.param[rcfg.paramName]));
							}
							api.env.render(sinfo.type.id);
						}
					}
					
					if (lemon.isBlank(apiTmp)) {
						apiTmp = api.getRequestAPI(data.param);
						if (!lemon.isBlank(apiTmp)) {
							var defineTmp = api.getAPI(apiTmp);
							if (!lemon.isBlank(defineTmp)) {
								api.env.render(defineTmp.type.id);
							} 
						}
					}

					lemon.setApi(apiTmp || null);
				});

				$('#define_api').click(function() {
					var capi = api.getRequestAPI(api.getCleanRequestData() || {});
					if (!lemon.isBlank(capi)) {
						if (lemon.isBlank(api.getAPI(capi))) {
							api.redefineAPI('new');
						} else {
							api.redefineAPI(capi, 1);
						}
					} else if (!lemon.isBlank(api.requ())) {
						var cenv = api.env.which(lemon.getEnv());
						if (cenv.id = -10) {
							api.redefineAPI('new');
						}
					}
				});

				api.nav.rightclick('#share_this', function() {
					api.hash.snap(null, 1);
				});
				api.popover('#share_this', function() {
					return lemon.tmpl($('#share_opt_tmpl').html(), {});
				}, {
					placement: 'right', title: 'Share...'
				}).on('inserted.bs.popover', function() {
					var el = $(this).data("bs.popover").tip();
				}).on('show.bs.popover', function() { 
					$(this).data("bs.popover").tip().css({
						border: 0
					});
				}).on('shown.bs.popover', function() {
					var el = $(this).data("bs.popover").tip();
					$('#share_option button[id^=share_]').click(function() {
						api.hash.snap(null, $(this).attr('stype'));
						$('#share_this').popover('hide');
					});
				});
				
				api.popover('#snapshoot_share', function() {
					return '<div id="snap_qrcode"></div>';
				}, {placement: 'right'}).on('show.bs.popover', function() { 
					$(this).data("bs.popover").tip().css({
						'min-width': 288,
						height: 278,
						border: 0
					});
				}).on('shown.bs.popover', function() {
					try {
						$('#snap_qrcode').qrcode({
							width: 256,
							height: 256,
							text: api.requ()
						});
					} catch(e) {
						$('#snapshoot_share').popover('hide');
						var msg = 'Generate qrcode fail ' + e.message;
						lemon.warn(msg);
						api.tip(msg);
					}
				});
				
				api.description('#api_define');
				api.popover('#copy_url', function() {
					var requestURL = api.nav.humanreadRequest();

					var h = 80;
			  		var w = document.body.clientWidth / 2;
			  		
			  		var html = [
							'<textarea id="request_url" style="border:0px solid #ffffff;height:' + h + 'px;width:' + w + 'px">' + requestURL + '</textarea>',
						].join('');
					
					return html;
				}, { 
					title: [
						'Request URL', 
						'<div class="pull-right">',
						'<span class="glyphicon glyphicon-pencil" title="encodeURIComponent" onclick="api.nav.copyEncodeUrl(this);"></span>',
					 	'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
				 		'<button type="button" class="close" aria-label="Close" onclick="javascript:$(\'#copy_url\').click();">',
				 		'<span aria-hidden="true">&times;</span></button>',
				 		'</div>'
				 	].join(''),
					placement: 'top'
				}).on('show.bs.popover', function() { 
					$(this).data("bs.popover").tip().css({
						border: 0,
						maxWidth: (document.body.clientWidth / 2) + 200
					});
				}).on('shown.bs.popover', function() {
					$("#request_url").focus(function() {
					    var $this = $(this); $this.select();

					    // Work around Chrome's little problem
					    $this.mouseup(function() {
					        // Prevent further mouseup intervention
					        $this.unbind("mouseup");
					        return false;
					    });
					});
				});

				$('.navbar-brand').click(function() {
					api.typeSearch(7);
				});

				$('#input_search').click(function() {
					if ($('#btn_search').hasClass('active')) {
						$('#btn_search').click();
					}
				});
				$("#input_search").keypress(function(event) { 
					if(event.ctrlKey && event.which == 13 || event.which == 10) { 
						
					} else if (event.shiftKey && event.which == 13 || event.which == 10) { 
						
					} else if (event.keyCode == "13") {
						event.preventDefault();
						$('#btn_search').click();         
					}
				});

				api.advqry.intl({
					triggerId: '#btn_advance',
					container: 'advance_qry',
					title: 'Advance Search',
					inserted: function(el) {
						var el = $(el).data("bs.popover").tip();
						el.find('.arrow').remove();
						el.hide();
					},
					hidden: function(el) {
						api.enable('#group_search,#btn_search');
					},
					shown: function(el) {
						if ($('#btn_search').hasClass('active')) {
							$('#btn_search').click();
						}
						
						var el = $(el).data("bs.popover").tip();
						var offset = $('#input_search').offset(), h = $('#input_search').height();
						el.css({
							left: offset.left - 150,
							top: offset.top + h
						});
						api.disable('#group_search,#btn_search');
						var btn = [
							'<h4></h4>',
							'<p class="pull-right" style="margin-right:13px;">',
							'<button type="button" onclick="api.advqry.search(\'#advance_qry\',\'#btn_advance\');" class="btn btn-primary">',
							'<span class="glyphicon glyphicon-search" title="Search"></span> Search</button></p>',
							'<h4></h4>'
						].join('');
						$('#advance_qry').after(btn);
						api.advqry.fill('advance_qry');
						el.show();
					}
				});

				api.popoverOnBtn('#btn_search', function() {
					lemon.notes = [];
					lemon.defaults = [];
					lemon.tags = [];
					lemon.descs = [];
					lemon.nextHis = null;
					lemon.searchconds = null;
					lemon.skeys = [];
					
					api.progressHome();
					api.previousInterval = {
				   		when: '',
				   		batch: 0
				    };
					var key = lemon.trim($('#input_search').val());
					//1 Just All API, 2 Normal Search, 3 Advance, 4 Tag, 5 Fav, 6 ALL History, 7 Settings, 
					//8 complex or requ.{propA}:{valueA}|resp.{propB}:{valueB}, 9 complex and requ.{propA}:{valueA}&resp.{propB}:{valueB}
					//11 API Mutation
					var searchType = 1;
					var searchProp = '';
					if (!lemon.isBlank(key)) {
						searchType = 2;
						if (lemon.startWith(key, '/l') || lemon.startWith(key, '/r')) {
							searchType = 8;
						} else if (key.indexOf('|') > 0) {
							searchType = 8;
						} else if (key.indexOf('&') > 0) {
							searchType = 9;
						} else if (key.indexOf(':') > 0) {
							searchType = 3;
							var tmp = key.split(':');
							searchProp = tmp[0];
							key = tmp[1];
							if ('TAG' == searchProp) {
								searchType = 4;
							}
						} else {
							if ('FAV' == key) {
								searchType = 5;
							} else if ('ALL' == key) {
								searchType = 6;
							} else if ('SETTING' == key) {
								searchType = 7;
							} else if ('MUTATION' == key) {
								searchType = 11;
							}
						}
					}

					lemon.searchType = searchType;
					var regEx = new RegExp(key), apis = {}, histories = {}, showHisBtn = false;

					switch (searchType) {
					case 1:
					case 2:
					case 3:
						var isAdvance = 3 == searchType;
						var justAllAPI = 1 == searchType;
						var items = api.preference.defines().items.sort(function(a, b) {
							return a.type.id - b.type.id;
						});

						lemon.each(api.apiMutation(), function(v, k) {
							lemon.each(v, function(mutate, mutateId) {
								var r = api.nav.makeApi(mutate);

								if (isAdvance) {
									if (regEx.test(lemon.json.get(mutate.request, searchProp))) {
										apis['api_' + mutate.api + '_' + mutateId] = r;
									}
								} else {
									if (justAllAPI || regEx.test(mutate.api) || regEx.test(mutate.note) || regEx.test(mutate.desc)) {
										apis['api_' + mutate.api + '_' + mutateId] = r;
									}
								}
							});
						});
						
						lemon.each(items, function(v, k) {
							var r = api.nav.makeApi(v);

							if (isAdvance) {
								if (regEx.test(lemon.json.get(v.request, searchProp))) {
									apis['api_' + v.api] = r;
								}
							} else {
								if (justAllAPI || regEx.test(v.api) || regEx.test(v.desc)) {
									apis['api_' + v.api] = r;
								}
							}
						});

						if (!justAllAPI) {
							showHisBtn = true;
							var conds = [];
							if (isAdvance) {
								conds.push({
									type: 'both',
									prop: searchProp,
									match: regEx
								});
							} else {
								conds.push({
									type: 'self',
									prop: 'api',
									match: regEx
								});
								conds.push({
									type: 'self',
									prop: 'name',
									match: regEx
								});
								conds.push({
									type: 'cust',
									prop: 'note',
									match: regEx
								});
							}
							
							lemon.searchconds = { opt: 1, exp: conds };
							if (lemon.isBlank(apis)) {
								var r  = api.queryNextHis(lemon.searchconds);
								if (r.realSize > 0) {
									lemon.searchconds.now = true;
									histories = r.items;
								}
								showHisBtn = false;
							}

							lemon.skeys.push(key);

							/*
							lemon.store.forEach(function(k, v) {
								if (v && !lemon.isBlank(v.request)) {
									
									var r = api.nav.makeHis(v);
									if (isAdvance) {
										if (regEx.test(lemon.json.get(v.request, searchProp)) 
												|| regEx.test(lemon.json.get(v.response, searchProp))) {
											histories[k] = r;
										}
									} else {
										if (regEx.test(api.getRequestAPI(v.request) || '') 
												|| regEx.test(r.desc) 
												|| regEx.test(api.customHis(k, 'note'))) {
											histories[k] = r;
										}
									}
								}
							});
							*/
						}
						break;

					case 8: //Complex
					case 9:
						lemon.searchconds = api.getSearchConds(key, function(unitkey) {
							lemon.skeys.push(unitkey);
						});
						var r  = api.queryNextHis(lemon.searchconds);
						if (r.realSize > 0) {
							lemon.searchconds.now = true;
							histories = r.items;
						}
						showHisBtn = false;
						break;

					case 4:	//Tag
						lemon.each(api.tag(), function(v, k) {
							if (lemon.isBlank(key)) {
								lemon.each(api.customHis(), function(v1, k1) {
									var hisTags = v1.tag || [];
									if (hisTags.length > 0) {
										var aHis = lemon.store(k1);
										if (aHis && aHis.request) {
											histories[k1] = api.nav.makeHis(aHis);
										}
									}
								});
							} else {
								lemon.skeys.push(key);
								if (regEx.test(decodeURI(v.name))) {
									var tagId = parseInt(v.id);
									lemon.each(api.customHis(), function(v1, k1) {
										var hisTags = v1.tag || [];
										if (hisTags.indexOf(tagId) != -1) {
											var aHis = lemon.store(k1);
											if (aHis && aHis.request) {
												histories[k1] = api.nav.makeHis(aHis);
											}
										}
									});
								}
							}
						});
						break;
					case 5:	//Fav
						lemon.each(api.customHis(), function(v, k) {
							if (v.fav && 1 == v.fav) {
								histories[k] = api.nav.makeHis(lemon.store(k));
							}
						});
						break;
					case 6:	//All
						lemon.store.forEach(function(k, v) {
							if (v && !lemon.isBlank(v.request)) {
								histories[k] = api.nav.makeHis(v);
							}
						});
						break;
					case 11:
						lemon.each(api.apiMutation(), function(v, k) {
							lemon.each(v, function(mutate, mutateId) {
								var r = api.nav.makeApi(mutate);
								apis['api_' + mutate.api + '_' + mutateId] = r;
							});
						});
						break;

					case 7: //Settings
						return lemon.tmpl($('#setting_tmpl').html(), {});
					}

					//var empty = 'Couldnt find any APIs or histories';
					return lemon.tmpl($('#table_tmpl').html(), {
						histories: histories, 
						apis: apis, 
						showHisBtn: showHisBtn,
						theHisTrs: api.getTrHis(1, histories)
					});
				}, { title: '', trigger: 'click' }, function(el) {
					if ($('#btn_history').hasClass('active')) {
						$('#btn_history').click();
					}
					if (lemon.searchconds && lemon.searchconds.now) {
	                	$('#btn_search').data("bs.popover").tip().find('div .panel-body').attr({id: 'scroll_search_body'});
	    	            api.scroll('#scroll_search_body', function() {
	    	            	api.progressHome();
	    	            	var queryR = api.queryNextHis(lemon.searchconds);
	    	            	$('#his_body').append(api.getQueryTrHis(queryR.items, lemon.nextHis.intlNo));
	    	            	api.progressHomeEnd();
	    	            });
		            }

		            api.matchSearch();
					switch(lemon.searchType) {
					case 1:
					case 2:
					case 3:
					case 11:
						$('#btn_show_match_his').click(function() {
							$(this).button('loading');
							api.showMatchedHistories(lemon.searchconds);
							api.matchSearch();
							api.historyCtl();
							$(this).slideToggle();
						});
						$('#btn_tgl_apirequ').click(function() {
							$(this).button('toggle');
							$('pre[tgl-apirequ="tgl"]').fadeToggle("slow", "linear");
						});
						$('#btn_tgl_apiresp').click(function() {
							$(this).button('toggle');
							$('pre[tgl-apiresp="tgl"]').fadeToggle("slow", "linear");
						});
						$('#btn_tgl_interf').click(function() {
		                	$(this).button('toggle');
		                	lemon.each(api.preference.interf(), function(v, k) {
		                    	api.interfType(v.id);
		                    });
		                });

						break;
					case 7:
						$(el).data("bs.popover").tip().css({left:0});
						$('#export_option button[id^=exp_]').click(function() {
							api.nav.check('#' + $(this).attr('id'), 1);
						});
						$('#imp_file').change(function(event) {
							api.file.handle(this, event, {
								onLoadStart: function(e, target) {
									$('#btn_imp').button('loading');
									api.progressHome();
								},
								onLoadEnd: function(e, target) {
									api.impexp.doimport(target.reader.result, true);
									api.progressHomeEnd();
									$('#btn_imp').button('reset');
									$('#imp_file').val('');
								}
							});
						});

						$('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
							var curTab = e.target, prevTab = e.relatedTarget;
							api.preference.tab = {
								current: curTab,
								previous: prevTab
							};

							var curHref = $(curTab).attr('href');
							if ('#basic' == curHref) {
								api.mirrorVal('#p_interf', api.preference.interf());
								api.mirrorVal('#p_env', api.preference.env());
								api.mirrorVal('#p_config', api.preference.basic());
							} else if ('#export_tab' == curHref) {
								
							} else if ('#import_tab' == curHref) {
								
							} else if ('#server' == curHref) {
								var settingServerHtml = lemon.tmpl($('#setting_server_tmpl').html(), {});
								$('#server').empty().append(settingServerHtml);

								$('#server .thumbnail').hover(function(){  
									$(this).css({'background-color': '#fafafa'});   
								},function(){  
									$(this).css({'background-color': ''});   
								});

								lemon.prevDefineServId = null;
								api.mirrorVal('#ss_server', {
									id: "",
									interf: "",
									note: ""
								}, {
									width: 580,
									height: 172,
									valchange: function(cm) {
										try {
											var servc = $.parseJSON(cm.getValue()), isStr = lemon.isString(servc.id), aservId = parseInt(servc.id);
											if (aservId && aservId > 0) {
												var cursor = cm.getCursor();
												if (aservId != lemon.prevDefineServId) {
													lemon.prevDefineServId = aservId;
													servc = api.getServer(aservId);
													if (isStr) {
														cursor.ch = cursor.ch - 1;
													}
													
													if (!lemon.isBlank(servc)) {
														api.preference.showServer(servc);
													} else {
														servc = {
															id: aservId,
															interf: "",
															note: ""
														};
														cm.setValue(lemon.json(servc));
													}
												}
												cm.setCursor(cursor);
											}
										} catch(e) {
										}
									}
								});

								$('#ss_default').click(function() {
									api.nav.check('#ss_default', 1);
								});
								$('#p_server_right .thumbnail').click(function() {
									var servId = parseInt($(this).attr('tid'));
									var aServ = api.getServer(servId);
									api.preference.showServer(aServ);
								});
							} else if ('#theapic' == curHref) {
								var settingAPIcHtml = lemon.tmpl($('#setting_apic_tmpl').html(), {});
								$('#theapic').empty().append(settingAPIcHtml).show();
								$('#sa_interf').change(function() {
									api.preference.apicEnvRender();
								});
								
								var apic = null;
								if (lemon.apicedit) {
									if ('new' == lemon.apicedit) {
										apic = {
											api: "",
											desc: "",
											note: "",
											request: api.getCleanRequestData()
										};
									} else {
										var parts = lemon.apicedit.split('_');
										lemon.apicedit = parts[0];
										if (parts.length == 2) {
											apic = lemon.clone(api.apiMutation(lemon.apicedit, parts[1]));
											api.mutation(2);
										} else if (parts.length == 1) {
											apic = lemon.clone(api.getAPI(lemon.apicedit));
											if (1 == lemon.apiceditfrom) {
												apic.request = lemon.extend(apic.request, api.getCleanRequestData());
											}
										}
										
										if (apic.type) {
											lemon.fillParam('#p_apic_left', {
												apiTypeId: apic.type.id
											});
											delete apic.type;
										}
									}
								}

								api.preference.apicEnvRender();

								lemon.prevDefineId = lemon.apicedit;
								api.mirrorVal('#sa_apic', apic || {
									api: "",
									desc: "",
									note: "",
									request: ""
								}, {
									lineNumbers: true,
									height: 436,
									width: 796,
									valchange: function(cm) {
										try {
											var apic = $.parseJSON(cm.getValue()), apicId = apic.api;
											//api.mutation
											if (apicId && apicId.length > 0) {
												if (apicId != lemon.prevDefineId) {
													lemon.prevDefineId = apicId;
													apic = lemon.clone(api.getAPI(apicId));
													
													if (!lemon.isBlank(apic)) {
														lemon.fillParam('#p_apic_left', {
															apiTypeId: apic.type.id
														});
														delete apic.type;
													} else {
														apic = {
															api: apicId,
															desc: "",
															note: "",
															request: ""
														};
													}
												}
												var cursor = cm.getCursor();
												cm.setValue(lemon.json(apic));
												cm.setCursor(cursor);
												after.rich.chgFontSize(cm, 15);
											}
										} catch(e) {
										}
									}
								});
								after.rich.chgFontSize(lemon.mirror["sa_apic"], 15);

								if (apic && apic.defserv && apic.defserv > 0) {
									api.preference.apicEnvClick(api.getServer(apic.defserv));
								}
							}
						}).on('hide.bs.tab', function (e) {
							if (!api.preference.saveBasic()) {
								return false;
							}
						});

						if ('' == api.preference.tab.current) {
							$('#theapic-tab').click();
						}
						break;
					};

					api.progressHomeEnd();
				}, function(el) {
					switch(lemon.searchType) {
					case 7:
						lemon.mirror = {};
						api.preference.tab = {
							current: '',
							previous: ''
						};
						break;
					}
				});

				$('#btn_note').click(function() {
					note.open();
				});

				$('#btn_note_diff').click(function() {
					$('#btn_note').click();
					note.open(1);
				});

				$('#btn_repl').click(function() {
					$(this).button('toggle');
					var isActive = $(this).hasClass('active');
					if (isActive) {
						if (!api.repl.views) {
							api.repl.views = true;
							$('#btn_resp').click();
						}
						$('#area_repl').show();
					} else {
						$('#area_repl').hide();
					}
				});

				$('#btn_his_prev, #btn_his_next').click(function() {
					var lastId = parseInt(lemon.store('last') || '0');
					var hid = api.hash.curHisId || lastId;
					var step = parseInt($(this).attr('step'));
					var nextid = hid + step;
					if (nextid <= 0 || nextid > lastId) {
						api.tip('There is no ' + ((step == -1) ? 'previous' : 'next') + ' history.');
					} else {
						api.hash.requ('history', nextid);
					}
				});

				api.popoverOnBtn("#btn_history", function() {
					lemon.notes = [];
					lemon.descs = [];
					lemon.tags = [];
					lemon.currentP = 1;
					lemon.searchconds = null;

					api.progressHome();
					api.previousInterval = {
				   		when: '',
				   		batch: 0
				    };
                    return lemon.tmpl($('#table_tmpl').html(), {histories: 1, apis: {}, showHisBtn: false, theHisTrs: api.getTrHis()});
                }, { title: '', trigger: 'click' }, function(el) {
                	if ($('#btn_search').hasClass('active')) {
						$('#btn_search').click();
					}
                	$(el).data("bs.popover").tip().find('div .panel-body').attr({id: 'scroll_body'});
                    api.scroll('#scroll_body', function() {
                    	api.progressHome();
                        ++lemon.currentP;
    					$('#his_body').append(api.getTrHis());
    					api.tglhis('#btn_tgl_requ', 'pre[tgl-requ="tgl"]');
    					api.tglhis('#btn_tgl_resp', 'pre[tgl-resp="tgl"]');
    					api.doHisFilter();
    					api.progressHomeEnd();
                    });
                    api.progressHomeEnd();
                });

				/* api.nav.textarea('#request');
				api.nav.textarea('#response'); */
				$('#request,#response').css({
					border: '0px solid #ffffff'
				});
				api.nav.dblclick('#request');
				api.nav.dblclick('#response');
				
				$('#request').change(function() {
					try { $(this).val(lemon.json($(this).val())); } 
					catch (e) { lemon.warn(e, 'Can not parse JSON string.'); }
					$('#request_url').text(api.nav.humanreadRequest());
				});
			},
			navTitle: function() {
				$('.navbar-brand').text(api.preference.basic().navTitle || 'Manual API');
			},
			title: function(title) {
				$('title').text(title || api.preference.basic().title || 'API');
			},
			copyEncodeUrl: function(el) {
				if ($('#request_url').length) {
					$(el).button('toggle');
					$('#request_url').text(api.nav.humanreadRequest($(el).hasClass('active')));
				}
			},
			makeApi: function(aApi) {
				return {
					name: aApi.api,
					desc: aApi.desc,
					note: aApi.note,
					type: api.getInterfGroup(aApi.type.id),
					when: '',
					request: aApi.request,
					response: aApi.response || '',
					interf: '',
					mutation: aApi.mutation || 0
				};
			},
			makeHis: function(aHis) {
				var capi = aHis.api || api.getRequestAPI(aHis.request);
				var desc = aHis['name'] || (api.getAPI(capi) || {desc: ''}).desc;
				return {
					api: capi,
					when: aHis.when,
					request: aHis.request,
					response: aHis.response,
					interf: aHis.interf,
					name: desc
				};
			},
			check: function(selector, opt) {
				//opt undefined get value 1 checked 0 unchecked, 1 toggle, 2 check, 3 uncheck
				switch (opt = (opt || 4)) {
				case 1:
					$(selector).button('toggle');
					break;
				case 2:
					$(selector).addClass('active');
					break;
				case 3:
					$(selector).removeClass('active');
					break;
				}
				var isActive = $(selector).hasClass('active');
				if (4 == opt) {
					return isActive ? 1 : 0;
				}
				if (isActive) {
					$(selector + ' .glyphicon').removeClass('glyphicon-unchecked').addClass('glyphicon-check');
				} else {
					$(selector + ' .glyphicon').removeClass('glyphicon-check').addClass('glyphicon-unchecked');
				}

				return isActive ? 1 : 0;
			},
			newModal: function(options) {
				options = lemon.extend({
					title:'', 
					content: '', 
					triggerId: '', 
					modalDialogClass: 'modal-sm',
					onShow: null,
					onShown: null,
					onHide: null,
					onHidden: null,
					onLoaded: null
				}, options || {});			

				$('body').append(lemon.tmpl($('#modal_tmpl').html(), options));

				var mid = '#' + options.triggerId;
				api.nav.disableRightclick(mid);
				
				$(mid).on('show.bs.modal', function (e) {
					lemon.isFunc(options.onShow) && options.onShow(mid);
				}).on('shown.bs.modal', function (e) {
					lemon.isFunc(options.onShown) && options.onShown(mid);
				}).on('hide.bs.modal', function (e) {
					lemon.isFunc(options.onHide) && options.onHide(mid);
				}).on('hidden.bs.modal', function (e) {
					lemon.isFunc(options.onHidden) && options.onHidden(mid);
				}).on('loaded.bs.modal', function (e) {
					lemon.isFunc(options.onLoaded) && options.onLoaded(mid);
				});

				return {
					mid: mid,
					show: function() { $(mid).modal('show'); },
					hide: function() { $(mid).modal('hide'); },
					handleUpdate: function() { $(mid).modal('handleUpdate'); },
					toggle: function() { $(mid).modal('toggle'); },
					options: function(options) {
						$(mid).modal(lemon.extend({
							backdrop: true,
							keyboard: true,
							show: true
						}, options || {}));
					}
				}
			},
			disableRightclick: function(selector) {
				//forbiden right click context menu
				$(selector).bind('contextmenu', function() { 
					return false; 
				});
			},
			rightclick: function(selector, callback) {
				api.nav.disableRightclick(selector);
				$(selector).mousedown(function(event) {
					//1 left 2 middle 3 right
					if (event.which == 3) {
						event.stopPropagation();
						event.preventDefault();
						lemon.isFunc(callback) && callback(selector, event)
					}
				});
			},
			dblclick: function(selector) {
				api.nav.disableRightclick(selector);
				api.nav.rightclick(selector, function(selector) {
					if (lemon.endWith(selector, '_view')) {
						api.nav.edit(selector);
					} else {
						api.nav.view(selector);
					}
				});
			},
			humanreadRequest: function(encode) {
				var cleanData = api.getCleanRequestData();
				var param = api.getRequestData(cleanData);
				param = lemon.json.reverse(param);
				var requestURL = api.nav.getRequestURLwithParams(param, encode);
				lemon.info(requestURL, 'Request URL');
				return requestURL;
			},
			getRequestURLwithParams: function(param, encode) {
				var curServ = api.env.which(lemon.getEnv());
				var requCfg = curServ.request || api.preference.basic().request;
				if (-10 == curServ.id) {
					requCfg.type = 2;
				}
				//1 wrap request data into a parameter ('paramName' value), 2 using lemon.getUrl eg: ?a=1&b=2
				switch(requCfg.type) {
				case 1:
					if (encode) {
						param = encodeURIComponent(param);
					}
					return lemon.format('{0}?{1}={2}', lemon.getEnv(), requCfg.paramName, param);
					
				case 2:
					param = $.parseJSON(param);
					if (encode) {
						return lemon.getUrl(lemon.getEnv(), param);
					}
					var pair = [];
					
					lemon.each(param, function(v, k) {
						pair.push(k + '=' + v);
					});
					return lemon.format('{0}?{1}', lemon.getEnv(), pair.join('&'));
				}
			},
			textarea: function(selector, options) {
				api.popover(selector, function() {
					return [
						'<div class="btn-group btn-group-xs" role="group">',
						'<button type="button" class="btn btn-default" ',
						'onclick="api.nav.edit(\'' + selector + '\');">&nbsp;&nbsp;&nbsp;edit&nbsp;&nbsp;&nbsp;</button>',
						'<button type="button" class="btn btn-default" ',
						'onclick="api.nav.view(\'' + selector + '\');">&nbsp;&nbsp;&nbsp;view&nbsp;&nbsp;&nbsp;</button>',
						'</div>'
					].join('');
				}, lemon.extend({ 
					trigger: 'focus', placement: 'bottom' 
				}, options || {})).on('shown.bs.popover', function() { 
					var $parent = $(selector).parent();
					$parent.children('.popover').children('.arrow').removeClass('arrow');
					$parent.children('.popover').css({top: "-10px"});
				});
			},
			edit: function(elId) {
				if (lemon.endWith(elId, '_view')) {
					$(elId).popover('destroy').remove();
					$(lemon.rtrim(elId, '_view')).show();
				}
			},
			view: function(elId, reset) {
				if (lemon.endWith(elId, '_view')) {
					return;
				}

				var vid = elId + '_view';
				if (reset) {
					$(vid).remove();
				}
				
				var theVal = $(elId).val();
				if (lemon.isBlank(theVal)) {
					if (!reset) {
						return;
					}
				} else {
					try {
						JSON.parse(theVal);
					} catch (e) {
						lemon.warn(e, 'Can not parse JSON string');
						return;
					}
				}

				var heightOffset = 12;
				var height = $(elId).height() - heightOffset;
				var width = $(elId).width();
				$(elId).hide();

				var contentH = height - 5;
				var html = [
					'<div class="panel panel-default" id="' + lemon.ltrim(vid, '#') + '" style="margin-bottom:0px;height:' + contentH + 'px;width:' + width + 'px;border:0px solid #ffffff;">',
					'<div class="panel-body" style="padding:0px;"><pre style="border:0px solid #ffffff;background-color:#ffffff;height:' + (contentH - 22) + 'px;">',
					lemon.json.highlight(theVal),
					'</pre></div></div>'
				].join('');
				$(elId).parent().append(html);
				if (!after.styled) {
					api.nav.dblclick(vid, {
						trigger: 'click'
					});
				}
			},
		},
		decode: function(data, opt) {
			if (!lemon.isString(data)) {
				return data;
			}
			//opt 1 decodeURI, 2 decodeURIComponent, 3 both
			opt = opt || 1;
			if (1 == opt || 3 == opt) {
				try {
					data = decodeURI(data);
				} catch(e) {
					lemon.info(data, 'decode');
					lemon.warn(e, 'decodeURI');
				}
			}
			if (2 == opt || 3 == opt) {
				try {
					data = decodeURIComponent(data);
				} catch(e) {
					lemon.info(data, 'decode');
					lemon.warn(e, 'decodeURIComponent');
				}
			}
			return data;
		},
		decodeJson: function(data) {
			if (!lemon.isJson(data)) {
				return data;
			}
			var target = {};
			lemon.each(data, function(v, k) {
				target[api.decode(k, 3)] = api.decode(v, 3);
			});
			return target;
		},
		strAsJSON: function(data) {
			if (!lemon.isString(data)) {
				return data;
			}
			
			var holder = { url: null, param: {} };
			data = data.replace(/\n/g,'');

			var qidx = data.indexOf('?');
			if (qidx != -1) {
				holder.url = data.substr(0, qidx);
				data = data.substring(qidx + 1);
			}

			data = api.decode(data);
			var isContinue = true;
			for (var i = 0; i < api.analyze.length; i++) {
				var v = api.analyze[i], analyze = {};;
				if (data.indexOf(v.sep) != -1 && data.indexOf(v.subsep) != -1) {
					if (1 == v.id) {
						var lidx = data.indexOf('{');
						var ridx = data.lastIndexOf('}');
						if (lidx >= 0 && ridx >= 0) {
							data = data.substring(lidx, ridx + 1);
						}
						try {
							analyze = $.parseJSON(lemon.endIf(lemon.startIf(data, '{'), '}'));
							isContinue = false;
							break;
						} catch(e1) {
							lemon.warn(e1, 'Invalid request JSON data');
						}
					}

					try {
						lemon.each(data.split(v.sep), function(v1, i) {
							var kv = v1.split(v.subsep);
							analyze[kv[0]] = kv[1];
						});
						if (!lemon.isBlank(analyze)) {
							isContinue = false;
							break;
						}
					} catch(e) {
						lemon.warn(e, 'Invalid request data');
					}
				}
			};

			if (isContinue) {
				try {
					analyze = {}; var onlyMainSep = null;
					if (data.indexOf(onlyMainSep = '=') != -1 || data.indexOf(onlyMainSep = ':') != -1) {
						var seps = data.split(onlyMainSep);
						analyze[seps[0]] = seps[1];
					}
				} catch(e) {}
			}

			holder.param = analyze;
			var analyze2 = {};
			lemon.each(analyze, function(v, k) {
				var val = api.decode(v, 2);
				if (lemon.isString(val)) {
					var lidx = val.indexOf('{');
					var ridx = val.lastIndexOf('}');
					if (lidx >= 0 && ridx >= 0) {
						val = api.strAsJSON(val).param;
					} 
				}
				analyze2[api.decode(k, 2)] = val;
			});

			holder.param = analyze2;
			return holder;
		},
		typeSearch: function(type, key) {
			var val = '';
			switch (type) {
			case 1: break;
			case 4: val = 'TAG:'; break;
			case 5: val = 'FAV'; break;
			case 6: val = 'ALL'; break;
			case 7: val = 'SETTING'; break;
			case 11: val = 'MUTATION'; break;
			case 100: val = key || ''; break;
			case 12:
				$('#btn_advance').click();
				return;
			}
			$('#input_search').val(val);
			if (4 != type) {
				$('#btn_search').click();
			}

			switch (type) {
			case 5:
			case 6:
			case 7: 
			case 11:
				$('#input_search').val('');
				break;
			}
		},
		scroll: function(selector, handle) {
			var prevContentH = 0;
			lemon.scrollNext = false;
			$(selector).scroll(function(){
		        var $this = $(this), viewH = $(this).height(),
		        contentH = $(this).get(0).scrollHeight, scrollTop = $(this).scrollTop();
		      	//when reach bottom 100px, if(contentH - viewH - scrollTop <= 100)
		        if(lemon.scrollNext || ((prevContentH != contentH) && (scrollTop / (contentH - viewH) >= 0.95))){ 
		        	lemon.scrollNext = false;
		        	prevContentH = contentH;
					lemon.isFunc(handle) && handle();
		        }
		     });
		},
		description: function(selector, cmd, onShown, onHidden, options) {
			api.popover(selector, function() {
				var capi = cmd || api.getRequestAPI(api.getCleanRequestData()) || '';
				var cloneAPI = lemon.clone(api.getAPI(capi));
				var note = cloneAPI.note;
				delete cloneAPI.note;
				var apiDefined = lemon.json.highlight(cloneAPI);
				var preH = document.body.clientHeight - 50;
				var preW = document.body.clientWidth / 2;
				return [
					'<div style="max-height:' + preH + 'px;overflow-y: scroll;">',
					api.showNote(note),
					'<pre style="width:620px;max-width:' + preW + 'px;max-height:' + (preH - 5) + 'px;border:0;background-color:#ffffff;">' + apiDefined + '</pre>',
					'</div>'
				].join('');
			}, lemon.extend({ 
				placement: 'right',
				title: 'API Description'
			}, options || {})).on('show.bs.popover', function() { 
				$(this).data("bs.popover").tip().css({
					border: 0,
					maxWidth: (document.body.clientWidth / 2) + 200
				});
			}).on('shown.bs.popover', function() { 
				lemon.isFunc(onShown) && onShown();
			}).on('hidden.bs.popover', function() { 
				lemon.isFunc(onHidden) && onHidden();
			});
		},
		showResponse: function(response, options) {
			if (lemon.isBlank(response)) {
				return '';
			}
			return [
				'<pre title="Property Description" style="background-color:#ffffff;border:0px;" tgl-apiresp="tgl">',
				'<p class="pull-right text-muted">Response</p>',
				lemon.json.highlight(response),
				'</pre>'
			].join('');
		},
		showNote: function(note) {
			if (lemon.isBlank(note)) {
				return '';
			}
			if (!lemon.isBlank(note)) {
				if (lemon.isFunc(note)) {
					return note();
				} else if (lemon.isArray(note)) {
					var html = ['<ul class="list-group">'];

					lemon.each(note, function(v, k) {
						html.push('<li class="list-group-item"><h6 class="text-muted">' + v + '</h6></li>');
					});
					
					html.push('</ul>');
					return html.join('');
				} else if (lemon.isJson(note)) {
					return '<pre title="Property Description" style="border:0px;">' + lemon.json.highlight(note) + '</pre>';
				} 
				else {
					return '<div class="panel panel-default"><div class="panel-body"><h6 class="text-muted">' + note + '</h6></div></div>';
				}
			}
		},
		historySortDesc: function(histories) {
			var items = [];
			lemon.each(histories, function(v, k) {
				if (v && !lemon.isBlank(v.request)) {
					v.k = k;
					v.api = v.api || api.getRequestAPI(v.request);
					items.push(v)
				}
			});
			return items.sort(function(a, b) {
				return b.k - a.k;
			});
		},
		getTrHis: function(pn, histories) {
			pn = pn || lemon.currentP;
        	var histories = histories || api.getHistories(pn);
        	var intlNo = (pn - 1) * api.preference.basic().history.pageSize + 1;
			return lemon.tmpl($('#his_tr_tmpl').html(), {histories: histories, intlNo: intlNo});
		},
		getQueryTrHis: function(histories, intlNo) {
			return lemon.tmpl($('#his_tr_tmpl').html(), {histories: histories, intlNo: intlNo});
		},
		matchSearch: function() {
			lemon.each(lemon.skeys, function(v, i) {
            	api.matched(v, '#r_search');
            });
		},
		showMatchedHistories: function(conds, ps, lastId) {
			api.progressHome();
			if (!$('#scroll_search_body').length) {
				$('#btn_search').data("bs.popover").tip().find('div .panel-body').attr({id: 'scroll_search_body'});

				if (!$('#his_table').length) {
		            var showHis = {show: 1};
		            var hisHtml = lemon.tmpl($('#table_tmpl').html(), {
						histories: showHis, 
						apis: {}, 
						showHisBtn: false,
						theHisTrs: ''
					});
		            $('#scroll_search_body').append($(hisHtml).find('#his_table').html());
		            $('#btn_search').data("bs.popover").tip().css({maxWidth: "100%"});
				}

				lemon.nextHis = null;
	            api.scroll('#scroll_search_body', function() {
	            	api.progressHome();
	            	var queryR = api.queryNextHis(conds);
	            	$('#his_body').append(api.getQueryTrHis(queryR.items, lemon.nextHis.intlNo));
	            	api.matchSearch();
	            	api.progressHomeEnd();
	            });
			}

			var queryR = api.queryNextHis(conds);
        	$('#his_body').append(api.getQueryTrHis(queryR.items, lemon.nextHis.intlNo));
        	api.progressHomeEnd();
		},
		queryNextHis: function(conds) {
			if (lemon.isBlank(lemon.nextHis)) {
				lemon.nextHis = {
					lastId: null,
					intlNo: 1,
					ps: null,
					rs: null,
					mayHasNext: true
				};
			} else {
				lemon.nextHis.intlNo = lemon.nextHis.rs + lemon.nextHis.intlNo;
			}

			if (lemon.nextHis.mayHasNext) {
				var queryR = api.queryHistories(conds, lemon.nextHis.ps, lemon.nextHis.lastId);
				lemon.nextHis = {
					lastId: queryR.lastId,
					ps: queryR.pageSize,
					rs: queryR.realSize,
					intlNo: lemon.nextHis.intlNo,
					mayHasNext: queryR.mayHasNext
				};
				
				return queryR;
			}

			return {};
		},
		queryHistories: function(condition, ps, lastId) {
			/*condition: {
				opt: 'number, 1 or(||) 2 and(&&)', 
				exp: [{type: '[requ|resp|both]', prop: '[string, support nest property]', match: '[RegExp]' }]
			} */
			var recordsLen = parseInt(lemon.store('last') || '0');
			lastId = lastId || recordsLen;
			var items = {}, ps = ps || api.preference.basic().searchPageSize, matched = 0, looped = 0;
			ps = -1 == ps ? (lastId + 1) : ps;
			
			for (var idx = lastId; idx >= 0; idx--) {
				var item = lemon.store(idx);
				if (item && item.request) {
					var condRArr = [];
					lemon.each(condition.exp, function(cond, i) {
						var condR = false;
						switch (cond.type) {
						case 'requ':
							condR = cond.match.test(lemon.json.get(item.request, cond.prop));
							break;
						case 'resp':
							condR = cond.match.test(lemon.json.get(item.response, cond.prop));
							break;
						case 'both':
							condR = cond.match.test(lemon.json.get(item.request, cond.prop))
								|| cond.match.test(lemon.json.get(item.response, cond.prop));
							break;
						case 'self':
							if ('api' == cond.prop || 'name' == cond.prop) {
								var capi = item.api || api.getRequestAPI(item.request);
								if ('name' == cond.prop) {
									var desc = item['name'] || (api.getAPI(capi) || {desc: ''}).desc;
									condR = cond.match.test(desc);
								} else {
									condR = cond.match.test(capi);
								}
							} else {
								condR = cond.match.test(lemon.json.get(item, cond.prop));
							}
							break;
						case 'cust':
							condR = cond.match.test(api.customHis(idx, cond.prop));
							break;
						}

						condRArr.push(condR ? true : false);
					});

					var isSatisfy = condRArr[0];
					for (var i = 1; i < condRArr.length; i++) {
						//OR
						if (1 == condition.opt) {
							isSatisfy = isSatisfy || condRArr[i];
							if (isSatisfy) {
								break;
							}
						} 
						//AND
						else if (2 == condition.opt) {
							isSatisfy = isSatisfy && condRArr[i];
							if (!isSatisfy) {
								break;
							}
						}
					}

					++looped;
					if (isSatisfy) {
						items[idx] = api.nav.makeHis(item);
						lastId = idx;
						++matched;
						if (matched >= ps) {
							break;
						}
					}
				}
			}

			var hasNext = lemon.isBlank(items) ? false : (matched < ps ? false : true);
			return {
				lastId: hasNext ? (lastId - 1) : null,
				mayHasNext: hasNext,
				pageSize: ps,
				realSize: matched,
				items: items
			}
		},
		getHistories: function(pn, ps) {
			var lastId = parseInt(lemon.store('last') || '0');
			var items = {}, ps = ps || api.preference.basic().history.pageSize, pn = pn || 1, offset = (pn - 1) * ps;
			var startId = lastId - offset;
			
			for (var idx = 0; idx < ps; idx++) {
				var key = startId - idx, item = lemon.store(key);
				if (item && item.request) {
					items[key] = api.nav.makeHis(item);
				}
			}

			return items;
			//return lemon.store.getAll();
		},
		inlineTip: function(selector, msg, delay) {
			var tipSel = selector + ' .inlinetip';
			var isBtn = $(selector).get(0).tagName == 'BUTTON';
			if (!$(tipSel).length) {
				$(selector).append('<span class="inlinetip"></span>');
			}
			if (isBtn) {
				$(selector).attr({disabled: 'disabled'}).addClass('disabled');
			}
			$(tipSel).html(msg || ' done!');
			lemon.delay(function(){
				$(tipSel).empty();
				$(selector).removeAttr('disabled').removeClass('disabled');
			}, delay || 1500);
		},
		elhistag: function(hisId, tagId, tagName) {
			return '<span id="t_' + hisId + '_' + tagId + '">&nbsp;<span class="label label-success"> ' + tagName + ' </span></span>';
		},
		onhistag: function(hisId, tagId) {
			var id = '#tag_his_' + hisId + '_' + tagId;
			var hisTags = api.customHis(hisId, 'tag') || [];
			if (hisTags.indexOf(tagId) == -1) {
				hisTags.push(tagId);
				$(id).addClass('active');
				$('#tag_area_' + hisId).append(api.elhistag(hisId, tagId, $(id).text()));
				$('#' + hisId).attr('tag' + tagId, tagId);
			} else {
				lemon.rmByVal(hisTags, tagId);
				$(id).removeClass('active');
				$('#t_' + hisId + '_' + tagId).remove();
				$('#' + hisId).removeAttr('tag' + tagId).hide();
			}
			api.customHis(hisId, 'tag', hisTags);
		},
		mutation: function(opt) {
			return api.nav.check('#btn_mutation', opt);
		},
		defineMutation: function(el) {
			var step = '';
			try {
				step = 'Define API Mutation';
				var theAPIc = $.parseJSON(api.mirrorVal('#sa_apic'));
				if (api.mutation(1)) {
					var mutateId = $('#btn_mutation').data('mutateId');
					mutateId = mutateId ? mutateId : api.autoId();
					$('#btn_mutation').data('mutateId', mutateId);
					theAPIc.mutation = mutateId;
				} else {
					delete theAPIc.mutation;
				}
				api.mirrorVal('#sa_apic', theAPIc);
			} catch(e) {
				api.preference.tip(step, ' invalid JSON value, ' + e.message);
			}
		},
		apiMutation: function(theapi, mutateId, mutate) {
			var key = "mutation";
			var mutates = lemon.store(key) || {};
			if (lemon.isUndefined(theapi)) {
				return mutates;
			}

			var apicMutates = mutates[theapi] || {};
			if (lemon.isUndefined(mutateId)) {
				return apicMutates;
			}

			var mu = apicMutates[mutateId] || {};
			if (lemon.isBlank(mutate)) {
				return mu;
			}
			
			if (!lemon.isBlank(mu)) {
				mutate = lemon.extend(mu, mutate);
			}
			apicMutates[mutateId] = mutate;
			if (lemon.has(mutate, 'delete') && 1 == mutate['delete']) {
				delete apicMutates[mutateId];
				mutates[theapi] = apicMutates;
				lemon.store(key, mutates);
				return mutate;
			}

			mutates[theapi] = apicMutates;
			lemon.store(key, mutates);
			return mutate;
		},
		tag: function(tagId, tagName) {
			var key = "definedTag";
			var tags = lemon.store(key) || {};
			if (lemon.isUndefined(tagId)) {
				return tags;
			}

			var aTag = tags[tagId] || {};
			if (lemon.isUndefined(tagName)) {
				if (lemon.isBlank(aTag)) {
					return aTag;
				}
				
				aTag.name = decodeURI(aTag.name);
				return aTag;
			}

			var existsTag = 1;
			var encodeTagName = encodeURI(tagName);
			if (-1 == tagName) {
				delete tags[tagId];
				lemon.store(key, tags);
				return aTag;
			} else {
				lemon.each(tags, function(v, k) {
					if (encodeTagName == v.name) {
						existsTag = 2;
						aTag = v;
					}
				});
			}

			if (1 == existsTag) {
				tags[tagId] = {
					id: tagId,
					name: encodeTagName
				};
				lemon.store(key, tags);
				return {
					id: tagId,
					name: tagName
				};
			}

			aTag.exists = true;
			return aTag;
		},
		defaultValue: function(cmd, val) {
			var key = "defaultApiVal";
			var hold = lemon.store(key) || {};
			if (lemon.isUndefined(cmd)) {
				return hold;
			}

			var defaultCmdVal = hold[cmd] || {};
			if (lemon.isUndefined(val)) {
				return hold[cmd];
			}

			hold[cmd] = val;
			lemon.store(key, hold);
			return hold[cmd];
		},
		customHis: function(hisId, key, val, rmVal) {
			var defineHisKey = 'definehis';
			var cust = lemon.store(defineHisKey) || {};
			if (lemon.isUndefined(hisId)) {
				return cust;
			}

			var tmp = cust[hisId] || {};
			if (lemon.isUndefined(key)) {
				return tmp;
			}
			
			if (lemon.isUndefined(val)) {
				return tmp[key];
			} else if (-1 == val) {
				if (lemon.isUndefined(rmVal)) {
					delete tmp[key];
					lemon.store(defineHisKey, cust);
					return tmp;
				} else {
					var aVal = tmp[key];
					if (lemon.isBlank(aVal)) {
						return aVal;
					}
					if (lemon.isArray(aVal)) {
						aVal = lemon.rmByVal(aVal, rmVal);
						lemon.store(defineHisKey, cust);
						return aVal;
					} else {
						delete aVal[rmVal];
						lemon.store(defineHisKey, cust);
						return aVal;
					}
				}
			} else {
				tmp[key] = val;
				cust[hisId] = tmp;
				lemon.store(defineHisKey, cust);
			}
			return cust[hisId];
		},
		resetDefaultVal: function(el) {
			var theAPI = $(el).attr('tapi');
			if (after.styled && after[theAPI]) {
				after[theAPI].setValue(lemon.json(api.getAPI(theAPI).request || {}));
			}
		},
		setAPIDefaultValClose: function(theAPI) {
			$('#set_default_' + theAPI).popover('hide');
		},
		setAPIDefaultVal: function(theAPI) {
			var apiDefaultId = '#set_default_' + theAPI;
			var title = [
			 	theAPI + ' Default Value',
			 	'<div class="pull-right">',
			 	'<span class="glyphicon glyphicon-refresh" title="Reset API Defaut Value" onclick="api.resetDefaultVal(this);" tapi="' + theAPI + '"></span>',
			 	'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
			 	'<button type="button" class="close" aria-label="Close" onclick="api.setAPIDefaultValClose(\'' + theAPI + '\');">',
			 	'<span aria-hidden="true">&times;</span></button>',
			 	'</div>'
			 ].join('');
			 
			if (lemon.defaults.indexOf(theAPI) == -1) {
				api.popover(apiDefaultId, function() {
					var apiVal = lemon.json(api.getAPIDefaultVal(theAPI, api.getAPI(theAPI).request));
					return '<textarea id="api_default_edit_' + theAPI + '" style="height:300px;width:500px;border:0px solid #ffffff;">' + apiVal + '</textarea>';
				}, { 
					title: title, placement: 'left'
				}).on('shown.bs.popover', function() {
					if (after.styled) {
						after[theAPI] = after.mirror('#api_default_edit_' + theAPI, {
							width: 500,
							height: 305
						});
					}
				}).on('show.bs.popover', function() { 
					$(this).data("bs.popover").tip().css({
						border: 0,
						maxWidth: (document.body.clientWidth / 2) + 200
					});
					$(apiDefaultId).addClass('active');
				}).on('hidden.bs.popover', function() {
					$(apiDefaultId).removeClass('active');
				}).on('hide.bs.popover', function() {
					var data = $('#api_default_edit_' + theAPI).val();
					if (after.styled) {
						data = after[theAPI].getValue();
						after[theAPI] = null;
					}
					if (!lemon.isBlank(data)) {
						try {
							data = $.parseJSON(data || {});
							api.defaultValue(theAPI, data);
						} catch(e) {}
					}
				});

				lemon.defaults.push(theAPI);
				$(apiDefaultId).popover('show');
			}
		},
		itemTag: function(hisId, no) {
			var tagBtnId = '#tags_' + hisId;
			var title = [
			 	'Tags <span class="badge">' + no + '</span>',
			 	'<div class="pull-right">',
			 	'<button type="button" class="close" aria-label="Close" onclick="api.itemTagClose(' + hisId + ');">',
			 	'<span aria-hidden="true">&times;</span></button>',
			 	'</div>'
			 	].join('');
			if (lemon.tags.indexOf(hisId) == -1) {
				api.popover(tagBtnId, function() {
			  		var html = [
						'<div style="height:300px;width:500px;overflow-y:auto;">'
						];
			  		var hisTags = api.customHis(hisId, 'tag') || [];

			  		var definedTags = api.tag();
			  		lemon.each(definedTags, function(v, k) {
						var tagName = decodeURI(v.name);
						var aTag = [
								' <button type="button" onclick="api.onhistag(' + hisId + ','+ v.id + ');"',
								' class="btn btn-default ' + ((hisTags.indexOf(v.id) > -1) ? 'active' : '') + '" style="margin-top:5px;" ',
								' id="tag_his_' + hisId + '_' + v.id + '"> ' + tagName + ' </button> '
                            	].join('');
                    	html.push(aTag);
					});

					if (lemon.isBlank(definedTags)) {
						return '<div style="width:500px" class="alert alert-info" role="alert">No tag defined.</div>';
					}
					html.push('</div>');
			  		
					return html.join('');
				}, { 
					title: title,
					placement: 'left'
				}).on('show.bs.popover', function() {
					$(this).data("bs.popover").tip().css({
						border: 0,
						maxWidth: (document.body.clientWidth / 2) + 200
					});
				}).on('shown.bs.popover', function() {
					$(tagBtnId).addClass('active');
				}).on('hidden.bs.popover', function() {
					$(tagBtnId).removeClass('active')
				}).on('hide.bs.popover', function() {
					
				});
				lemon.tags.push(hisId);
				$(tagBtnId).popover('show');
			}
		},
		itemTagClose: function(hisId) {
			$('#tags_' + hisId).popover('hide');
		},
		redefineEnvInterfG: function(type) {
			//type 1 env, 2 interf group
			$('#basic-tab').click(); var selector = null;
			switch (type) {
			case 1: selector = '#basic .panel:eq(1)'; break;
			case 2: selector = '#basic .panel:eq(0)'; break;
			}

			lemon.delay(function() {
				api.attention(selector);
			}, 1000);
		},
		redefineAPI: function(target, from) {
			lemon.apicedit = target.replace('api_', '');
			lemon.apiceditfrom = from || 0;
			if ($('#btn_search').hasClass('active')) {
				$('#btn_search').click();
			}
			api.typeSearch(7);
		},
		hisTglRequResp: function(hisId, type) {
			switch (type) {
			case 1: type = 'requ'; break;
			case 2: type = 'resp'; break;
			case 3: type = 'apirequ'; break;
			case 4: type = 'apiresp'; break;
			}
			var id = lemon.format('#his_tgl_{0}_{1}', type, hisId);
			$(id).button('toggle');
			$(lemon.format('#{0} pre[tgl-{1}="tgl"]', hisId, type)).fadeToggle("slow", "linear");
		},
		historyAPIDesc: function(hisId, cmd) {
			var descId = '#desc_' + hisId;
			if (lemon.descs.indexOf(hisId) == -1) {
				api.description(descId, cmd, function() {
					$(descId).addClass('active');
				}, function() {
					$(descId).removeClass('active');
				}, {placement: 'left'});
				lemon.descs.push(hisId);
				$(descId).popover('show');
			}
		},
		pencil: function(hisId, no) {
			var pencilId = '#pencil_' + hisId;
			var title = [
			 	'Note <span class="badge">' + no + '</span>',
			 	'<div class="pull-right">',
			 	'<span class="glyphicon glyphicon-trash" title="Clean Note" onclick="api.pencilClose(' + hisId + ', 1);"></span>',
			 	'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
			 	'<button type="button" class="close" aria-label="Close" onclick="api.pencilClose(' + hisId + ');">',
			 	'<span aria-hidden="true">&times;</span></button>',
			 	'</div>'
			 	].join('');
			if (lemon.notes.indexOf(hisId) == -1) {
				api.popover(pencilId, function() {
			  		var html = [
							'<textarea id="his_note_' + hisId + '" style="border:0px solid #ffffff;height:150px;width:500px"></textarea>',
						].join('');
					
					return html;
				}, { 
					title: title,
					placement: 'left'
				}).on('show.bs.popover', function() {
					$(this).data("bs.popover").tip().css({
						border: 0,
						maxWidth: (document.body.clientWidth / 2) + 200
					});
				}).on('shown.bs.popover', function() {
					$(pencilId).addClass('active');
					var note = api.customHis(hisId, 'note') || '';
					$('#his_note_' + hisId).val(note);
				}).on('hidden.bs.popover', function() {
					$(pencilId).removeClass('active');
				}).on('hide.bs.popover', function() {
					var note = $('#his_note_' + hisId).val() || '';
					api.customHis(hisId, 'note', note);
					
					var showNoteId = '#show_note_' + hisId;
					if (!lemon.isBlank(note)) {
						$(showNoteId).html('<div class="alert alert-warning" role="alert" style="font-size:75%;">' + note + '</div>');
					} else {
						$(showNoteId).empty();
					}
				});
				lemon.notes.push(hisId);
				$(pencilId).popover('show');
			}
		},
		pencilClose: function(hisId, trash) {
			$('#pencil_' + hisId).popover('hide');
			if (1 == trash) {
				api.customHis(hisId, 'note', '');
				$('#show_note_' + hisId).empty();
			}
		},
		favourite: function(el, hisId) {
			var $span = $(el).children('span');
			var isFavShow = $('#prop_filter_1').hasClass('active');
            //unfav
            if ($span.hasClass('glyphicon-star')) {
                $span.removeClass('glyphicon-star');
                $span.addClass('glyphicon-star-empty');
                api.customHis(hisId, 'fav', 0);
                if (isFavShow) {
                    $('#' + hisId).attr({prop: 0}).fadeToggle("slow", "linear");
                }
            } 
            //fav
            else {
            	$span.removeClass('glyphicon-star-empty');
                $span.addClass('glyphicon-star');
				api.customHis(hisId, 'fav', 1);
				$('#' + hisId).attr({prop: 1});
            }
		},
		tglhis: function(selector, tglTarget) {
			var isActive = $(selector).hasClass('active');
			if (isActive) {
				$(tglTarget).hide("slow", "linear");
			} else {
				$(tglTarget).show("slow", "linear");
			}
			
		},
		popoverOnBtn: function(selector, content, options, onShown, onHidden) {
			api.popover(selector, content, options)
			  .on('show.bs.popover', function() { 
				$(this).data("bs.popover").tip().css({
					border: 0,
					maxWidth: "100%"
				});
				$(selector).button('toggle');
			}).on('hide.bs.popover', function() {
				switch(lemon.searchType) {
				case 7:
					if (!api.preference.saveBasic()) {
						return false;
					}
				}
				$(selector).button('toggle');
			}).on('hidden.bs.popover', function() {
				lemon.isFunc(onHidden) && onHidden(this);
			}).on('shown.bs.popover', function() {
				lemon.isFunc(onShown) && onShown(this);
				api.historyCtl();				
			});
		},
		repl: {
			views: false,
			intl: function() {
				var wrap = after.response.getWrapperElement();
				var offset = $(wrap).position();
				offset.width = $(wrap).width() + 23;
				offset.height = $(wrap).height() + 26;
				
				api.popover('#btn_resp', function() {
					return [
						'<div id="repl_view"></div>'
					].join('');
				}, {
					placement: 'bottom'
				}).on('inserted.bs.popover', function() {
					var el = $(this).data("bs.popover").tip();
					el.hide();
				}).on('hidden.bs.popover', function() {
					$('#btn_resp').button('toggle');
				}).on('show.bs.popover', function() {
					var el = $(this).data("bs.popover").tip();
					el.find('.arrow').remove();
				}).on('shown.bs.popover', function() {
					$('#btn_resp').button('toggle');
					var el = $(this).data("bs.popover").tip();
					el.css({ 
						top: offset.top - 5, 
						left: offset.left - 15, 
						'max-width': offset.width, 
						width: offset.width,
						height: offset.height,
						'max-height': offset.height,
						border: 0 
					});
					el.show();

					if (!lemon.isUndefined(console)) {
						root.repl = new Console(lemon.query('#repl_view'), {outputH: offset.height - 30});
						repl.wrapLog(console);
						after.rich.mapkey(repl.input, {
							Tab: 'autocomplete',
							Enter: function(cm) {
								var text = repl.input.getValue().trim();
								if (text) { repl.exec(text); }
								after.rich.toLastLine(repl.output);
							}
						});
						repl.input.focus();
					}
				});
			}
		},
		advqry: {
			intl: function(options) {
				var title = [
				 	options.title,
				 	'<div class="pull-right">',
				 	'<button type="button" class="close" aria-label="Close" onclick="api.advqry.close(\'' + options.triggerId + '\');">',
				 	'<span aria-hidden="true">&times;</span></button>',
				 	'</div>'
				 ].join('');
				api.popover(options.triggerId, function() {
					return lemon.tmpl($('#extract_base_tmpl').html(), {cid: options.container});
				}, {
					title: title,
					placement: 'bottom'
				}).on('inserted.bs.popover', function() {
					options.inserted && options.inserted(this);
				}).on('hidden.bs.popover', function() {
					options.hidden && options.hidden(this);
				}).on('show.bs.popover', function() {
					var el = $(this).data("bs.popover").tip();
					var w = $(root).width() / 2 - 26;
					el.css({ width: w, 'max-width': w, border: 0 });
					options.show && options.show(this);
				}).on('shown.bs.popover', function() {
					options.shown && options.shown(this);
				});
			},
			close: function(triggerId) {
				$(triggerId).click();
			},
			fill: function(containerId) {
				var key = $('#input_search').val();
				var params = {};
				if (!lemon.isBlank(key)) {
					if (key.indexOf('|') != -1) {
						params.symbol = '|';
					} else if (key.indexOf('&') != -1) {
						params.symbol = '&';
					} else {
						params.symbol = '&';
					}

					lemon.each(key.split(params.symbol), function(v, i) {
						var idx = api.advqry.addCond(containerId), op = 'both', sk = '', sv = '', tmp = null;
						var isrequ = false, isresp = false, tmpk = v;
						var isrequ = lemon.startWith(v, '/l.'), isresp = lemon.startWith(v, '/r.');
						if (isrequ) {
							op = 'requ', tmpk = v.substring(3);
						} else if (isresp) {
							op = 'resp', tmpk = v.substring(3);
						}
						
						tmp = tmpk.split(':');
						if (tmp.length >= 2) {
							sk = tmp[0]; sv = tmp[1];
						} else {
							sv = tmp[0];
						}

						params['op' + idx] = op;
						params['key' + idx] = sk;
						params['val' + idx] = sv;
					});

					lemon.fillParam(containerId, params);
				} else {
					api.advqry.addCond(containerId);
				}
			},
			search: function(containerId, triggerId) {
				//{symbol: "&", op10: "requ", key10: "", val10: ""}
				api.typeSearch(100, api.advqry.getKeys(containerId));
				api.advqry.close(triggerId);
			},
			getKeys: function(containerId) {
				var params = lemon.getParam(containerId);
				var keys = [];
				$(containerId + ' div[ex="filter"]').each(function(i, el) {
					var idx = $(this).attr('idx');
					var op = params['op' + idx], sk = params['key' + idx], sv = params['val' + idx], exp = '';
					if (!lemon.isBlank(op) && !lemon.isBlank(sk) && !lemon.isBlank(sv)) {
						exp = sk + ':' + sv;
						switch(op) {
						case 'requ': exp = '/l.' + exp; break;
						case 'resp': exp = '/r.' + exp; break;
						case 'both': break;
						}
						keys.push(exp);
					}
				});
				return keys.join(params.symbol);
			},
			getExtracts: function(containerId) {
				var rdata = {requ: {}, resp: {}}, extrs = lemon.getParam(containerId);
				$(containerId + ' div[ex="prop"]').each(function(i, el) {
					var idx = $(this).attr('idx');
					rdata[extrs['op' + idx]][extrs['key' + idx]] = extrs['val' + idx];
				});
				return rdata;
			},
			extract2note: function(el) {
				if ($(el).hasClass('disabled')) {
					return;
				}
				
				api.progressHome(); $(el).addClass('disabled');
				var cid = '#' + $(el).attr('cid'), pid = '#' + $(el).attr('pid'), rdata = '';
				var fkey = api.advqry.getKeys(pid);
				var conds = lemon.searchconds ? lemon.searchconds : api.getSearchConds(fkey);
				var data = api.queryHistories(conds, -1);

				var extrs = api.advqry.getExtracts(cid);
				if (lemon.isBlank(extrs.requ) && lemon.isBlank(extrs.resp)) {
					rdata = lemon.json(data.items);
				} else {
					var props = { extracts: [] };
					lemon.each(data.items, function(item, idx) {
						var rprop = {}, tmp = null;
						lemon.each(extrs.requ, function(v, k) {
							if ('all' == k) {
								rprop.request = item.request;
							} else if (!lemon.isBlank(tmp = lemon.json.get(item.request, k))) {
								rprop[v] = tmp;
							}
						});
						lemon.each(extrs.resp, function(v, k) {
							if ('all' == k) {
								rprop.response = item.response;
							} else if (!lemon.isBlank(tmp = lemon.json.get(item.response, k))) {
								rprop[v] = tmp;
							}
						});
						if (!lemon.isBlank(rprop)) {
							props.extracts.push(rprop);
						}
					});

					props.summary = {
						size: props.extracts.length,
						time: lemon.when(),
						filter: fkey
					};
					rdata = lemon.json(props);
				}

				note.open();
				note.newNote(rdata);
				note.mode('json');
				
				api.progressHomeEnd();
				$(el).removeClass('disabled');
			},
			chgProp: function(el) {
				var kid = '#' + $(el).attr('id'), vid = kid.replace('_key_', '_val_'), k = $(kid).val();
				$(vid).val(k.substring(k.lastIndexOf('.') + 1));				
			},
			addProp: function(containerId) {
				var idx = lemon.uniqueId();
				var cond = lemon.tmpl($('#extract_prop_tmpl').html(), {
					index: idx
				});
				$('#' + containerId).append(cond);
				return idx;
			},
			remProp: function(idx) {
				$('#ex_prop_' + idx).remove();
			},
			camera: function(el) {
				$('#input_search').val(api.advqry.getKeys('#' + $(el).attr('cid')));
			},
			addCond: function(containerId) {
				var idx = lemon.uniqueId();
				var cond = lemon.tmpl($('#extract_tmpl').html(), {
					index: idx
				});
				$('#' + containerId).append(cond);
				return idx;
			},
			remCond: function(condId) {
				$('#ex_filter_' + condId).remove();
			}
		},
		historyCtl: function() {
			api.advqry.intl({
				triggerId: '#btn_extract',
				container: 'his_extract',
				title: 'Extract What You Need',
				shown: function(el) {
					$('#btn_extract').button('toggle');
					if ($('#btn_search').hasClass('active')) {
						api.advqry.fill('his_extract');
					}

					$('#his_extract').after(lemon.tmpl($('#extract_prop_base_tmpl').html(), { 
						parentCid: 'his_extract',
						cid: 'his_extract_prop' 
					}));
				},
				hidden: function(el) {
					$('#btn_extract').button('toggle');
				}
			});

			$('#btn_tgl_requ').click(function() {
				$(this).button('toggle');
				lemon.scrollNext = true;
				api.tglhis(this, 'pre[tgl-requ="tgl"]');
			});
			$('#btn_tgl_resp').click(function() {
				$(this).button('toggle');
				lemon.scrollNext = true;
            	//$('pre[tgl-resp="tgl"]').fadeToggle("slow", "linear");
				api.tglhis(this, 'pre[tgl-resp="tgl"]');
            });
            $('#btn_tgl_interval').click(function() {
            	$(this).button('toggle');
            	var isActive = $(this).hasClass('active');
            	lemon.each(api.batches || [], function(v, k) {
            		var exp = api.getHisFilterExp();
            		var target = '';
        			if (!lemon.isBlank(exp)) {
        				target = 'tr[batch="' + v + '"]' + exp;
        			} else {
            			target = 'tr[batch="' + v + '"]';
        			}
        			if (isActive) {
        				$(target).hide("slow", "linear");
            		} else {
            			$(target).show("slow", "linear");
                	}
                });
            });

            $('#tag_edit').click(function() {
            	var $input = $('#tag_input');
            	var tagId = $input.attr('tagId');
            	var msg = '';
            	var tagNmae = $input.val();
            	if (tagId && !lemon.isBlank(tagNmae)) {
                    var id = '#tag_filter_' + tagId;
                    api.tag(tagId, tagNmae);
                    $(id).text(tagNmae);
                    msg = ' Edit Done!';
                    $('span[id$=' + tagId + ']').children('span').text(tagNmae);
                } else {
                    msg = ' None Exist Tag.';
                }
            	api.inlineTip('#tag_edit', msg);
            });
            $('#tag_add').click(function() {
                $(this).button('disable');
                var $input = $('#tag_input');
                var $group = $('#tag_group');
                var tag = $input.val();
                if (!lemon.isBlank(tag)) {
                    var tagId = api.autoId();
                    var theTag = api.tag(tagId, tag);
                    var msg = '';
                    if (!theTag.exists) {
                        var tagBtn = [
							' <button type="button" onclick="api.ontag('+ tagId + ');"',
							' class="btn btn-default btn-sm" style="margin-top:5px;" ',
							' id="tag_filter_'+ tagId + '"> ' + tag + ' </button> '
                        	].join('');
                        $group.append(tagBtn);
                        $input.attr({tagId: theTag.id});
                        msg = ' Add Done!';
                    } else {
                        msg = ' Tag Exists.';
                    }
                    
                    api.inlineTip('#tag_add', msg);
                }
            });
            $('#tag_rem').click(function() {
            	var $input = $('#tag_input');
            	var tagId = $input.attr('tagId');
            	var msg = '';
            	if (tagId) {
                    var id = '#tag_filter_' + tagId;
                    api.tag(tagId, -1);
                    $(id).remove();
                    $input.removeAttr('tagId');
                    msg = ' Remove Done!';

                    $('span[id$=' + tagId + ']').remove();
                    $(lemon.format('[tag{0}="{0}"]', tagId)).removeAttr('tag' + tagId).hide();
                    api.filters.tag = lemon.rmByVal(api.filters.tag, parseInt(tagId));
                    api.doHisFilter();
                } else {
                    msg = ' None Exist Tag.';
                }
            	api.inlineTip('#tag_rem', msg);
            });

            api.filters = {
            	env: [],
            	interf: [],
            	prop: [],
            	tag: []
            };
            $('button[id^="env_filter_"],button[id^="filter_"],button[id^="prop_filter_"]').click(function() {
				var isActive = $(this).hasClass('active');
				var id = $(this).attr('id');
				var mark = lemon.ltrim(id, 'env_filter_|filter_|prop_filter_');
				
				var whichGroup = 0;
				var expTpl = '';
				if (lemon.startWith(id, 'env_filter_')) {
					whichGroup = 1;
					expTpl = '[env="{0}"]';
				} else if (lemon.startWith(id, 'filter_')) {
					whichGroup = 2;
					expTpl = '[interf="{0}"]';
				} else if (lemon.startWith(id, 'prop_filter_')) {
					whichGroup = 3;
					expTpl = '[prop="{0}"]';
				}
				
				$(this).button('toggle');
				if (isActive) {
					switch (whichGroup) {
					case 1:
						api.filters.env.pop();
						break;
					case 2:
						api.filters.interf.pop();
						break;
					case 3:
						api.filters.prop.pop();
						break;
					}
				} else {
					switch (whichGroup) {
					case 1:
						if (api.filters.env.length > 0) {
							$('#env_filter_' + api.filters.env.pop()).button('toggle');
						}
						api.filters.env.push(mark);
						break;
					case 2:
						if (api.filters.interf.length > 0) {
							$('#filter_' + api.filters.interf.pop()).button('toggle');
						}
						api.filters.interf.push(mark);
						break;
					case 3:
						if (api.filters.interf.length > 0) {
							$('#prop_filter_' + api.filters.prop.pop()).button('toggle');
						}
						api.filters.prop.push(mark);
						break;
					}
				}
				
				api.doHisFilter();
			});
		},
		getHisFilterExp: function() {
			var exp = [
				(api.filters.env.length > 0 ? lemon.format('[env="{0}"]', api.filters.env[0]) : ''),
				(api.filters.interf.length > 0 ? lemon.format('[interf="{0}"]', api.filters.interf[0]) : ''),
				(api.filters.prop.length > 0 ? lemon.format('[prop="{0}"]', api.filters.prop[0]) : '')
			];

			lemon.each(api.filters.tag, function(tagId, k) {
				exp.push(lemon.format('[tag{0}={0}]', tagId));
			});

			return exp.join('');
		},
		doHisFilter: function() {
			var filterExp = api.getHisFilterExp();
			//lemon.info(filterExp, 'History filter expression');
			$('tr[his="1"]').show();
			if (!lemon.isBlank(filterExp)) {
				$('tr[his="1"]:not(' + filterExp + ')').hide();
			}
		},
		ontag: function(tagId) {
			var id = '#tag_filter_' + tagId;
			var aTag = api.tag(tagId);
			var $input = $('#tag_input');
            $input.val(aTag.name).attr({tagId: aTag.id});

            var isActive = $(id).hasClass('active');
            if (isActive) {
            	api.filters.tag = lemon.rmByVal(api.filters.tag, tagId);
            } else {
            	api.filters.tag.push(tagId);
            }
            $('#tag_filter_' + tagId).button('toggle');

            api.doHisFilter();
		},
		popover: function(selector, content, options) {
			var popoverTemplate = [
           		'<div class="popover" role="tooltip">',
           		'<div class="arrow"></div>',
           		'<h3 class="popover-title"></h3>',
           		'<div class="popover-content"></div>',
           		'</div>'
            ].join('');

            var headId = 'prevent_twice' + lemon.uniqueId();
            options = options || {title: null};
			var thePopover = $(selector).popover(lemon.extend({
                title: '',
                trigger: 'click',
                content: content,
                template: popoverTemplate,
                placement: "bottom",
                html: true
            }, options || {}, {
            	//Prevent popover content function is executed twice
                title: options.title || ('<div id="' + headId + '">&nbsp;</div>')
            })).on('shown.bs.popover', function() {
            	if (lemon.isBlank(options.title)) {
                	$('#' + headId).parent().hide();
                }
            });
            
			return thePopover;
		},
		autoId: function(key) {
			key = key || 'autoid';
			return lemon.store.set(key, parseInt(lemon.store.get(key) || 0) + 1);
		},
		uniqueId: function() {
			var historySize = api.preference.basic().history.max;
			var maxId = lemon.store.set('last', parseInt(lemon.store.get('last') || 0) + 1);
			if (historySize > 0 && maxId >= historySize) {
				lemon.store.forEach(function(k) {
					if (k <= (maxId - historySize + 1)) {
						lemon.store(k, null);
					}
				});
			}
			return maxId;
		},
		chkRequest: function() {
			if (null == lemon.getEnv()) {
				api.tip('Choose an environment first!');
				return false;
			}

			if (lemon.isBlank(api.requ())) {
				api.tip('Choose or define an API first!');
				return false;
			}

			if (api.env.isProduct()) {
				var toBeContinue = confirm('Are you sure?\nProduct Environment!');
				if (!toBeContinue) {
					return false;
				}
			}
			
			return true;
		},
		getSearchConds: function(key, valueHandle) {
			var keys = [], split = '|';
			if (key.indexOf('|') != -1) { split = '|'; } else if (key.indexOf('&') != -1) { split = '&'; }
			lemon.each(key.split(split), function(v, idx) {
				var tmp = v.split(':'), cond = {}, condK = null;
				if (lemon.startWith(tmp[0], '/l.')) {
					cond = {
						type: 'requ',
						prop: tmp[0].replace('/l.', ''),
						match: new RegExp(tmp[1])
					};
				} else if (lemon.startWith(tmp[0], '/r.')) {
					cond = {
						type: 'resp',
						prop: tmp[0].replace('/r.', ''),
						match: new RegExp(tmp[1])
					};
				} else {
					cond = {
						type: 'both',
						prop: tmp[0],
						match: new RegExp(tmp[1])
					};
				}
				
				keys.push(cond);
				lemon.isFunc(valueHandle) && valueHandle(tmp[1]);
			});

			var opt = '|' == split ? 1 : 2;
			return { opt: opt, exp: keys };
		},
		getCleanRequestData: function(data) {
			var data = api.requ();
			if (lemon.isBlank(data)) {
				lemon.warn(data, 'request params is not valid.');
				return {};
			}
			
			try {
				return $.parseJSON(data || {});
			} catch(e) {
				api.tip(lemon.asStr(e.message));
				throw e;
			}
		},
		getRequestData: function(data) {
			data = lemon.clone(data || {});
			var env = api.env.which(lemon.getEnv());
			if (!lemon.isBlank(env.params)) {
				lemon.extend(data, env.params);
			}
			return data;
		},
		getHoverOrSelectItem: function(key) {
			var result = {};
			if (lemon.isUndefined(key)) {
				return result;
			}
			
			if (lemon.startWith(key, 'api_')) {
				var parts = key.split('_');
				if (parts.length == 2) {
					result = api.getAPI(parts[1]);
				} else {
					if (lemon.endWith(parts[2], 's')) {
						result = api.getAPI(parts[1]);
					} else {
						result = api.apiMutation(parts[1], parts[2]);
					}
				}
			} else {
				result = lemon.store(key) || {};
			}

			return result;
		},
		getInterfGroup: function(id) {
			var r = {};
			lemon.each(api.preference.interf(), function(v, k) {
				if (id == v.id) {
					r = v;
					return false;
				}
			});
			return r;
		},
		getServer: function(servId) {
			var result = {};
			lemon.each(api.preference.service(), function(envGroup, k) {
				lemon.each(envGroup.serv, function(serv, k) {
					if (serv.id === servId) {
						result = serv;
						result.env = envGroup.env;
						result.desc = envGroup.desc;
						result.type = api.getInterfGroup(serv.type.id);
						result.request = serv.request || api.preference.basic().request;
						return false;
					}
				});
			});

			return result;
		},
		getAPI: function(theAPI) {
			if (!lemon.isBlank(api.hash.capture) && !lemon.isBlank(api.hash.capture.share.dapi)) {
				return api.hash.capture.share.dapi;
			}
			
			var result = {};
			lemon.each(api.preference.defines().items, function(v, k) {
				if (v.api === theAPI) {
					result = v;
					result.type = api.getInterfGroup(v.type.id);
					return false;
				}
			});
			return result;
		},
		getAPIDefaultVal: function(theAPI, defaultVal) {
			var dv = api.defaultValue(theAPI)
			return lemon.isBlank(dv) ? defaultVal : dv;
		},
		interval: function(batch) {
			var exp = api.getHisFilterExp();
			if (!lemon.isBlank(exp)) {
				$('tr[batch="' + batch + '"]' + exp).fadeToggle("slow", "linear");
			} else {
				$('tr[batch="' + batch + '"]').fadeToggle("slow", "linear");
			}
	
		},
		interfType: function(type) {
			$('[type="' + type + '"]').fadeToggle("slow", "linear");
		},
		onSelectSinleClick: function(el, requType, respType) {
			var key = $(el).button('toggle').attr('clkey');
			api.hisTglRequResp(key, requType || 1);
			api.hisTglRequResp(key, respType || 2);
		},
		onSelect: function(key, el) {
			var type = $(el).attr('ctype'), rapi = $(el).attr('rapi');
			switch(type) {
			case "1": api.hash.requ(rapi, key); break;
			case "2": 
				var parts = key.split('_');
				if (parts.length == 2) {
					api.hash.apid(parts[1]);
				} else {
					api.hash.apid(parts[1], parts[2]);
				}
				break;
			}
		},
		apichg: function(key) {
			var item = api.getHoverOrSelectItem(key), capi = null;
			if (!lemon.isBlank(item)) {
				var typeId = 0;
				if (lemon.startWith(key, 'api_')) {
					var parts = key.split('_');
					capi = parts[1];
					var requestV = {}, isenvset = false;
					if (parts.length == 2) {
						requestV = api.getAPIDefaultVal(capi) || item.request || {};
					} else {
						if (isenvset = lemon.endWith(parts[2], 's')) {
							requestV = api.getAPIDefaultVal(capi) || item.request || {};
						} else {
							requestV = item.request;
						}
					}
					api.requ(lemon.json(requestV));
					if (lemon.isBlank(item.response)) {
					} else {
						api.resp(lemon.json(item.response));
					}

					if (item.defserv && item.defserv > 0) {
						var serv = api.getServer(item.defserv);
						lemon.setEnv(serv.interf);
						api.env.change(serv.interf);
					} else if (isenvset) {
						var serv = api.getServer(parseInt(lemon.rtrim(parts[2], 's')));
						lemon.setEnv(serv.interf);
						api.env.change(serv.interf);
					}
					
					typeId = item.type.id;
					if ($('#btn_search').hasClass('active')) {
						$('#btn_search').click();
					}
				} else {
					capi = item.api || api.getRequestAPI(item.request);
					api.requ(lemon.json(item.request || {}));
					api.resp(lemon.json(item.response || {}));
					lemon.setEnv(item.interf);
					api.env.change(item.interf);
					if ($('#btn_history').hasClass('active')) {
						$('#btn_history').click();
					}
					if ($('#btn_search').hasClass('active')) {
						$('#btn_search').click();
					}
					typeId = api.env.which(item.interf).type.id;
				}

				api.nav.title(capi);
				lemon.setApi(capi);
				if (typeId > 0) {
					api.env.render(typeId);
				}

				if (after.styled) {
					
				} else {
					if (!$('#request:visible').length) {
						api.nav.view('#request', true);
					}
					api.nav.view('#response', true);
				}

				api.chgJSONPView();
			}
		},
		mirrorVal: function(selector, value, options) {
			var theK = lemon.ltrim(selector, '#'); lemon.mirror = lemon.mirror || {};
			if (lemon.isUndefined(value)) {
				if (after.styled) {
					if (lemon.mirror[theK]) {
						return lemon.mirror[theK].getValue();
					}
					return {};
				}

				return $(selector).val();
			} else {
				value = lemon.json(value);
				if (after.styled) {
					lemon.mirror[theK] = lemon.mirror[theK] || after.mirror(selector, lemon.extend({
						width: 358,
						height: 360
					}, options || {}));
					
					return lemon.mirror[theK].setValue(value);
				}

				return $(selector).val(value);
			}
		},
		requ: function(data) {
			var requId = '#request';
			if (lemon.isUndefined(data)) {
				if (after.styled) {
					return after.request.getValue();
				}
				
				return $(requId).val();
			}

			if (after.styled) {
				after.request.setValue(lemon.isNull(data) ? '' : data);
				return data;
			}

			$(requId).val(data);
			return data;
		},
		resp: function(data) {
			var respId = '#response';
			if (lemon.isUndefined(data)) {
				if (after.styled) {
					return after.response.getValue();
				}
				
				return $(respId).val();
			}

			if (after.styled) {
				after.response.setValue(lemon.isNull(data) ? '' : data);
				return data;
			}

			$(respId).val(data);
			return data;
		},
		matched: function(target, selector) {
			var blast = $(selector).blast({ search: target });
			blast.css({
                backgroundColor: "yellow",
                transition: "color 400ms"
            }).velocity({ backgroundColorAlpha: 1 }, { duration: 400 });
            return blast;
		},
		disable: function(selector) {
			return progressJs(selector).setOptions({
				theme: 'blueOverlayRadiusHalfOpacity', 
				overlayMode: true 
			}).start().set(0);
		},
		enable: function(selector) {
			progressJs(selector).end();
		},
		progressHomeEnd: function() {
			api.loadingHome.end();
		},
		progressHome: function(selector) {
			api.loadingHome = api.progress({ 
				selector: selector || api.progressSelector || '#home_navbar', 
				auto: { ms: 100, step: 1 }, set: 50
			});
			if (api.progressSelector) {
				api.progressSelector = null;
			}
		},
		progress: function(options) {
			options = lemon.extend({
				selector: null,
				start: 1,
				auto: {
					ms: 1000,
					step: 1
				},
				set: 0,
				cfg: {
					theme: 'blueOverlayRadiusHalfOpacity', 
					overlayMode: true 
				}
			}, options || {});
			var pg = progressJs(options.selector).setOptions(options.cfg).set(options.set);
			if (options.start) {
				pg.start();
			}
			if (options.auto) {
				pg.autoIncrease(options.auto.step, options.auto.ms);
			}
			return pg;
		},
		requestGetPost: function(selector, type) {
			$(selector).click(function() {
				if (!api.chkRequest()) { return; }
				
				api.progressHome();
				api.resp('');
				api.request(function(data) {
					api.resp(lemon.json(data));
					api.progressHomeEnd();
				}, function(jqXHR, textStatus, errorThrown) {
					api.progressHomeEnd();
				}, type || 'post');
			});
		},
		chgJSONPView: function() {
			if (!api.isServSupportJSONP()) {
				$('#btn_request').addClass('disabled');
			} else {
				$('#btn_request').removeClass('disabled');
			}
		},
		//1 support else unsupport
		isServSupportJSONP: function(interf) {
			var requCfg = api.getServRequCfg(interf);
			return lemon.isUndefined(requCfg.jsonp) ? 1 : parseInt(requCfg.jsonp);
		},
		getServRequCfg: function(interf) {
			var curServ = api.env.which(interf || lemon.getEnv());
			return curServ.request || api.preference.basic().request;
		},
		getRequestAPI: function(data) {
			var defineCfg = api.preference.basic(), capi = null;
			if (lemon.isJson(data) && !lemon.isBlank(defineCfg.apiParamNameInRequest)) {
				capi = data[defineCfg.apiParamNameInRequest];
			}

			if (!lemon.isBlank(capi)) {
				return capi;
			}

			var requCfg = api.getServRequCfg();
			if (2 == requCfg.type) {
				return api.getCurrentAPI();
			}
			
			return null;
		},
		getCurrentAPI: function(data) {
			return lemon.getApi() ? lemon.getApi() : api.getRequestAPI(data || api.getCleanRequestData());
		},
		request: function(success, failure, type) {
			var cleanData = api.getCleanRequestData();
			var request = api.getRequestData(cleanData);
			lemon.info(request, 'request');

			var done = function(data, textStatus, jqXHR) {
	           	 lemon.info(textStatus, 'request status');
	        	 lemon.info(data, 'response');
	        	 var rapi = api.getCurrentAPI(cleanData);
	        	 var hisId = api.uniqueId();
	        	 lemon.store.set(hisId, {
		        	api: rapi,
	 				when: lemon.when(),
	 				request: cleanData, 
	 				response: data,
	 				interf: lemon.getEnv(),
	 				name: api.getAPI(rapi).desc
	 			 });
	 			 api.hash.requ(rapi, hisId);
		         success && success(data);
		         if (!after.styled) {
		        	 api.nav.view('#response', true);
			     }
		     };

		     type = type || 'jsonp';
		     var url = lemon.getEnv(), curServ = api.env.which(url), rdata = {};
			 var requCfg = curServ.request || api.preference.basic().request;
			 switch (requCfg.type) {
			 case 1:
			     rdata[requCfg.paramName] = lemon.json.reverse(request);
			     break;
			 case 2:
				 url = api.nav.humanreadRequest();
				 break;
			 }
		     var fail = function(jqXHR, textStatus, errorThrown){  
            	 lemon.error(jqXHR);
            	 lemon.error(textStatus, 'request status');
            	 lemon.error(errorThrown);
            	 
            	 api.resp(lemon.json({
                	 title: 'Request Failed (' + type.toUpperCase() + ')',
                	 cause: ((!lemon.startWith(location.href, url) && (type != 'jsonp'))
                	 	? 'May cross domain issue. ' : '') + 'See browser console for more information',
                	 jqXHR: jqXHR,
                	 textStatus: textStatus,
                	 errorThrown: errorThrown,
                	 server: url
               	 }));
            	 $('#btn_request').button('reset');
            	 failure && failure(jqXHR, textStatus, errorThrown);
             }

			switch (type) {
			case 'jsonp':
				$.ajax({  
		             type: "get",
		             async: false,
		             url: url,
		             data: rdata,
		             dataType: "jsonp" 
		        }).done(done).fail(fail);
				break;

			case 'get':
				$.get(url, rdata).success(done).error(fail);
				break;

			case 'post':
				$.post(url, rdata).success(done).error(fail);
				break;
			}
		},
		attention: function(selector, duration, times) {
			lemon.times(times || 4, function() {
				$(selector).fadeToggle(duration || 500);
			});
		},
		tip: function(text, options) {
			options = lemon.extend({
				//1 main page, 2 settings page, 3 merge page
				where: 1,
				level: 'warning',
				delay: 3000,
				//auto: disappear when options.delay millesecond, manual: manual close
				close: 'auto'
			}, options || {});

			var tipId = '#tip_id_' + options.where + lemon.uniqueId(), msgId = '#msg_id';
			var msg = $(document.createElement('div')).attr({
				class: 'alert alert-' + options.level,
				role: 'alert',
				id: lemon.ltrim(tipId, '#'),
				style: 'display:none'
			}).html(text);

			switch (options.where) {
			case 1:
				$('#message').append(msg);
				$(msgId).slideToggle();  
				break;
			case 2:
				$('#message_settings').append(msg);
				break;
			case 3:
				$('#nav_merge').append(msg);
				break;
			}
			
			if (options.close == 'manual') {
				msg.append([
					'<button type="button" class="close" data-dismiss="alert" aria-label="Close">',
					'<span aria-hidden="true">&times;</span></button>'
				].join(''));
			};

			$(tipId).slideToggle();
			if (options.close == 'auto') {
				lemon.delay(function() {
					if (1 == options.where) {
						$(msgId).slideToggle(); 
					}
					$(tipId).slideToggle(function() {
						$(tipId).remove();
					});
				}, options.delay);
			}
		},
		msg: function(type, text, title) {
			var msg = $(document.createElement('div')).attr({
				class: 'alert alert-' + type || 'info',
				role: 'alert',
				env: title,
				id: 'msg_id'
			}).text(text);
			$('#message').empty().append(msg);
			/* .popover({
				content: function() {
					return $('#msg_id').attr('env');
				},
				placement: 'bottom',
				trigger: 'hover'
			}).on('show.bs.popover', function() { 
				$(this).data("bs.popover").tip().css({
					border: 0,
					maxWidth: "800px"
				});
			}); */
			return msg;
		},
		preference: {
			help: function(el) {
				$(el).button('toggle');
                var isActive = $(el).hasClass('active');
				var servHelpId = 'serv_help_tip_id';
				$('#' + servHelpId).remove();
				if (isActive) {
					this.tip(this.getWarn(this.valid.serv, null, 1), null, '#p_server_left', servHelpId);
				}
			},
			showServer: function(aServ) {
				var showServ = lemon.clone(aServ);
				delete showServ.type; delete showServ.asDefault; 
				delete showServ.env; delete showServ.desc;
				lemon.fillParam('#p_server_left', {
					env: aServ.env,
					typeId: aServ.type.id
				});
				if (aServ.asDefault && 1 == aServ.asDefault) {
					api.nav.check('#ss_default', 2);
				} else {
					api.nav.check('#ss_default', 3);
				}
				api.mirrorVal('#ss_server', showServ);
			},
			apicEnvClick: function(serv) {
				var step = '';
				try {
					step = api.mutation() ? 'Define API Mutation' : 'Define API';
					var theAPIc = $.parseJSON(api.mirrorVal('#sa_apic'));
					theAPIc.defserv = serv.id;
					api.mirrorVal('#sa_apic', theAPIc);
				} catch(e) {
					api.preference.tip(step, ' invalid JSON value, ' + e.message);
				}

				$('#api_default_serv_href').attr({title: serv.desc}).text(serv.note || serv.type.name);
				if ('PRODUCT' == serv.env) {
					$('#api_default_serv_href').removeClass('text-info').addClass('text-danger');
				} else {
					$('#api_default_serv_href').removeClass('text-danger').addClass('text-info');
				}
			},
			apicEnvRender: function() {
				var typeId = parseInt($('#sa_interf').val());
				$('#apic_env_container').html(api.env.envselect({
					id: 'api_default_serv',
					name: 'API default server',
					typeId: typeId,
					handle: function(serv) {
						api.preference.apicEnvClick(serv);
					}
				}));
				$('#show_envs').remove();
			},
			newServId: function() {
				var theMaxId = 0;
				lemon.each(api.preference.service(), function(env, k) {
					lemon.each(env.serv, function(serv, k1) {
						theMaxId = Math.max(theMaxId, serv.id);
					});
				});
				try {
					var aServ = $.parseJSON(api.mirrorVal('#ss_server'));
					aServ.id = theMaxId + 1;
					api.mirrorVal('#ss_server', aServ);
				} catch(e) {
					api.preference.tip('New Server ID', ' invalid JSON value, ' + e.message);
				}
			},
			tab: {
				current: '',
				previous: ''
			},
			valid: {
				basic: { 
					"{{Group name}}" : {
						id: "[number, unique id]",
						name: "[string]"
					}
				},
				env: { 
					environment: [ 
						{ 
							env: "[string, unique string]", 
							desc: "[string]"
						} 
					]
				},
				serv: {
					id: "[number, unique id]",
					interf: "[string, request url]",
					note: "[string]",
					//asDefault: "[number optional, 1 set default]",
					params: "[JSON optional, add to request parameters]",
					request: {
						type: "[number, 1 wrap as a param eg: {{paramName}}={a:1,b:2}, 2 using lemon.getUrl eg: ?a=1&b=2]",
						paramName: "[string, if type is 1 then must provide]",
						jsonp: "[string optional, 1 support JSONP else unsupport, default is support]"
					}
				},
				interf: {
					api: "[string, unique string]",
					desc: "[string, interface description]",
					note: "[string|string array|JSON]",
					request: "[JSON, request data structure]"
				}
			},
			close: function() {
				api.preference.closeanyway = true;
				$('#btn_search').click();
			},
			saveBasic: function() {
				if (api.preference.closeanyway) {
					api.preference.closeanyway = false;
					return true;
				}

				var step = '', curHref = $(api.preference.tab.current).attr('href');
				if ('#export_tab' == curHref) {
					
				} else if ('#import_tab' == curHref) {
					
				} else if (curHref == '#server') {
					try {
						step = 'Define Server';
						var aServ = $.parseJSON(api.mirrorVal('#ss_server'));
						var aChoose = lemon.getParam('#p_server_left');
						var asDefault = api.nav.check('#ss_default');
	
						var theErr = '';
						if ('' == aServ.id && '' == aServ.interf && '' == aServ.note) {
							lemon.mirror['ss_server'] = undefined;
							return true;
						}
						
						if (aServ.id && aServ.interf) {
							if (lemon.has(aServ, 'params') && !lemon.isJson(aServ.params)) {
								theErr = 'the "params" must be a valid JSON. ';
							} else if (lemon.has(aServ, 'request')) {
								if (!lemon.isJson(aServ.request)) {
									theErr = 'the "request" must define a valid JSON. {"type":"","paramName":""}';
								} else if (lemon.has(aServ.request, 'type')) {
									if (1 == aServ.request.type && !aServ.request.paramName) {
										theErr = 'the "request" must define paramName when type is 1. ';
									} else if (2 != aServ.request.type && 1 != aServ.request.type) {
										theErr = 'the "request" must define a valid type 1 or 2.';
									}
								} else {
									theErr = 'the "request" must define a valid type.';
								}
							}
						} else {
							theErr = api.preference.getWarn(api.preference.valid.serv, aServ);
						}

						if (!lemon.isBlank(theErr)) {
							api.preference.tip(step, theErr);
							return false;
						}
						

						var theDefinedService = api.preference.service();
						if (lemon.has(aServ, 'delete') && 1 == aServ['delete']) {
							var keepServs = [], serverId = parseInt(aServ.id);
							lemon.each(theDefinedService[aChoose.env].serv, function(serv, idx) {
								if (serverId != serv.id) {
									keepServs.push(serv);
								}
							});

							theDefinedService[aChoose.env].serv = keepServs;
							api.preference.service(theDefinedService);
							lemon.mirror['ss_server'] = undefined;
							api.env.dorender();
							return true;
						}

						var aDefineServ = lemon.extend({
							asDefault: asDefault,
							type: api.getInterfGroup(aChoose.typeId)
						}, aServ);
						aDefineServ.id = parseInt(aDefineServ.id);
						aDefineServ.note = aDefineServ.note || '';
						
						var isModify = false;
						if (1 == aDefineServ.asDefault) {
							lemon.each(theDefinedService, function(env, k) {
								lemon.each(env.serv, function(serv, idx) {
									if (1 == serv.asDefault) {
										serv.asDefault = 0;
									}
								});
							});
						}

						var theServs = theDefinedService[aChoose.env].serv;
						lemon.each(theServs, function(serv, idx) {
							if (serv.id == aDefineServ.id) {
								theServs[idx] = lemon.extend(serv, aDefineServ);
								isModify = true;
								return false;
							}
						});

						if (!isModify) {
							theServs.push(aDefineServ);
						}

						api.preference.service(theDefinedService);
					} catch(e) {
						api.preference.tip(step, ' invalid JSON value, ' + e.message);
						return false;
					}

					api.env.dorender();
					lemon.mirror['ss_server'] = undefined;
				} 

				else if (curHref == '#theapic') {
					step = 'Define API', override = false;
					if (api.mutation()) {
						step = 'Define as Mutation';
					}
					
					try {
						var theAPIc = $.parseJSON(api.mirrorVal('#sa_apic'));

						var theErr = '';
						if ('' == theAPIc.api && '' == theAPIc.desc && '' == theAPIc.note && '' == theAPIc.request) {
							lemon.mirror['sa_apic'] = undefined;
							return true;
						}

						if (!lemon.has(theAPIc, 'api') || !lemon.has(theAPIc, 'desc') 
								|| !lemon.has(theAPIc, 'request') || !lemon.has(theAPIc, 'note')) {
							theErr = api.preference.getWarn(api.preference.valid.interf, theAPIc);
						} else {
							if (!lemon.isJson(theAPIc.request)) {
								theErr = 'The property "request" must be a JSON.';
							} else if (!(lemon.isString(theAPIc.note) || lemon.isArray(theAPIc.note) || lemon.isJson(theAPIc.note))) {
								theErr = 'The property "note" must be a [string | string array | JSON].';
							} else if (lemon.isArray(theAPIc.note)) {
								var hasNoneStrEl = false;
								lemon.each(theAPIc.note, function(v, idx) {
									if (!lemon.isString(v)) {
										hasNoneStrEl = true;
										return false;
									}
								});
								if (hasNoneStrEl) {
									theErr = 'The property "note" must be a string array when define as array.';
								}
							} else if (lemon.isBlank(theAPIc.api) || (theAPIc.api.indexOf('_') != -1)) {
								theErr = 'The property "api" cannot be empty or contains underline "_"';
							} else if (lemon.isBlank(theAPIc.desc)) {
								theErr = 'The property "desc" cannot be empty.';
							} else if (lemon.isBlank(theAPIc.request)) {
								theErr = 'The property "request" cannot be a empty JSON.';
							}
						}

						if (!lemon.isBlank(theErr)) {
							api.preference.tip(step, theErr);
							return false;
						}

						theAPIc.type = api.getInterfGroup(lemon.getParam('#p_apic_left').apiTypeId);
						if (api.mutation() && (theAPIc.mutation > 0)) {
							if (!lemon.isString(theAPIc.note)) {
								api.preference.tip(step, 'Property "note" must be a string when define mutation.');
								return false;
							}
							api.apiMutation(theAPIc.api, theAPIc.mutation, theAPIc);
							lemon.mirror['sa_apic'] = undefined;
							return true;
						}

						var theDefinedInterf = api.preference.defines();
						var isDel = lemon.has(theAPIc, 'delete') && 1 == theAPIc['delete'], aDefines = [], isNewDefine = true;
						lemon.each(theDefinedInterf.items, function(v, idx) {
							if (theAPIc.api == v.api) {
								if (!isDel) {
									isNewDefine = false;
									aDefines.push(lemon.extend(v, theAPIc));
								}
							} else {
								aDefines.push(v);
							}
						});

						if (!isDel && isNewDefine) {
							aDefines.push(theAPIc);
						}

						theDefinedInterf.items = aDefines;
						api.preference.defines(theDefinedInterf);
						
					} catch(e) {
						api.preference.tip(step, ' invalid JSON value, ' + e.message);
						return false;
					}

					api.cmd.render();
					lemon.mirror['sa_apic'] = undefined;
					//lemon.apicedit = null;
				}

				else if (curHref == '#basic') {
					step = 'Interface Group';
					try {
						var theErr = '', theInterf = {}, override = false;
						var theInterfs = $.parseJSON(api.mirrorVal('#p_interf')), ids = [];
						lemon.each(theInterfs, function(v, k) {
							if (v && v.id && v.name) {
								if (ids.indexOf(v.id) == -1) {
									if (override = (lemon.has(v, 'delete') && 1 == v['delete'])) {
									} else {
										theInterf[k] = v;
										ids.push(v.id);
									}
								} else {
									theErr = 'the id ' + v.id + ' is duplicated';
									return false;
								}
							} else {
								var theV = {};
								theV[k] = v;
								theErr = api.preference.getWarn(api.preference.valid.basic, theV);
								return false;
							}
						});
						if (!lemon.isBlank(theErr)) {
							api.preference.tip(step, theErr);
							return false;
						}
						api.preference.interf(theInterf, override);
						
						step = 'Environment', override = false;
						var theEnvs = $.parseJSON(api.mirrorVal('#p_env')).environment;
						var theEnv = {}; theErr = '', valid = api.preference.valid.env, envs = [];
						if (!theEnvs) {
							api.preference.tip(step, api.preference.getWarn(valid));
							return false;
						}
						var theDefinedService = api.preference.service();
						lemon.each(theEnvs, function(v, i) {
							if (v && v.env && v.desc) {
								if (envs.indexOf(v.env) == -1) {
									var r = {
										env: v.env,
										desc: v.desc
									};
									if (theDefinedService[v.env]) {
										r.serv = theDefinedService[v.env].serv;
									} else {
										r.serv = [];
									}

									if (override = (lemon.has(v, 'delete') && 1 == v['delete'])) {
									} else {
										theEnv[v.env] = r;
										envs.push(v.env);
									}
								} else {
									theErr = 'the env ' + v.env + ' is duplicated';
									return false;
								}
							} else {
								theErr = api.preference.getWarn(valid, {environment:[v]});
								return false;
							}
						});
						if (!lemon.isBlank(theErr)) {
							api.preference.tip(step, theErr);
							return false;
						}
						api.preference.service(theEnv, override);

						step = 'Configuration', override = false;
						var theConfig = $.parseJSON(api.mirrorVal('#p_config'));
						if (override = (lemon.has(theConfig, 'delete'))) {
							var theD = theConfig['delete'];
							if (theD && theD.indexOf('.') > 0) {
								var lastD = theD.lastIndexOf('.');
								var val = lemon.json.get(theConfig, theD.substring(0, lastD));
								delete val[theD.substring(lastD + 1)];
							} else {
								delete theConfig[theD];
							}
							delete theConfig['delete'];
						}
						
						api.preference.basic(theConfig, override);
						api.nav.title();
					} catch(e) {
						api.preference.tip(step, ' invalid JSON value, ' + e.message);
						return false;
					}

					api.env.dorender();
					api.cmd.render();
				}

				return true;
			},
			getWarn: function(valid, wrong, column) {
				var msg = []; column = column || 2;
				msg.push('<div class="row">');

				var clazz = 1 == column ? 'col-md-12' : 'col-md-6';
				if (valid) {
					msg.push('<div class="' + clazz + '"><pre style="background-color:#ffffff;border:0px;">');
					msg.push('<p class="text-success">the legal structure</p>' + lemon.json.highlight(valid) + '</pre></div>');
				}

				if (wrong) {
					msg.push('<div class="' + clazz + '"><pre style="background-color:#ffffff;border:0px;">');
					msg.push('<p class="text-danger">below is illegal structure</p>' + lemon.json.highlight(wrong) + '</pre></div>');
				}

				msg.push('</div>');	
				return msg.join('');
			},
			tip: function(title, msg, selector, tipId) {
				/* api.tip(msg, lemon.extend({
					close:'manual',
					where:2
				}, options || {})); */
				
				var tipId = tipId || ('p_tip_' + lemon.uniqueId());
				var html = [
					'<div class="alert alert-default alert-dismissible fade in" style="border:1px solid;border-color:#a94442;" role="alert" id="' + tipId + '">',
				    '<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true"></span></button>'
				];

				if (title) {
					html.push(title);
				} else {
					html.push('<h5>Oh snap! You got an error!</h5>');
				}

				if (msg) {
					html.push('<p>' + msg + '</p>');
				}
				html.push('</div>');

				$(selector || '#message_settings').append(html.join(''));
				return tipId;
			},
			basic: function(preference, override) {
				return api.preference.val('basic', preference, override);
			},
			interf: function(preference, override) {
				return api.preference.val('interf', preference, override);
			},
			env: function(preference) {
				var env = {
					environment: []
				};
				lemon.each(api.preference.service(), function(v, k) {
					env.environment.push({
						env: v.env,
						desc: v.desc
					});
				});
				return env;
			},
			service: function(preference, override) {
				return api.preference.val('service', preference, override);
			},
			defines: function(preference, override) {
				return api.preference.val('defines', preference, override);
			},
			val: function(key, val, override) {
				var preference = 'preference';
				var preferences = lemon.store(preference) || {};
				if (lemon.isUndefined(key)) {
					return preferences;
				}

				var defined = preferences[key] || {};
				if (lemon.isUndefined(val)) {
					return defined;
				}

				if (override) {
					if (lemon.isNull(val)) {
						delete preferences[key];
					} else {
						preferences[key] = val;
					}
				} else {
					preferences[key] = lemon.extend(defined, val);
				}
				
				lemon.store(preference, preferences);
				return preferences[key];
			},
			isExists: function(obj, key, target) {
				for (var i = obj.length - 1; i >= 0; i--) {
					if (obj[i][key] == target[key]) {
						return true;
					}
				};
				
				return false;
			}
		},
		env: {
			servSortEsc: function(items) {
				return items.sort(function(a, b) {
					return a.type.id - b.type.id;
				});
			},
			load: function() {
				var theDefined = null;
				if (!lemon.isBlank(root.config)) {
					theDefined = api.preference.basic();
					lemon.each(config, function(v, k) {if (!theDefined[k]) {theDefined[k] = v; } });
					api.preference.basic(theDefined);
					theDefined = null, config = undefined;
				}
				
				if (!lemon.isBlank(root.interf)) {
					theDefined = api.preference.interf();
					lemon.each(interf, function(v, k) {if (!theDefined[k]) {theDefined[k] = v; } });
					api.preference.interf(theDefined);
					theDefined = null, interf = undefined;
				}
				
				if (!lemon.isBlank(root.definedServs)) {
					theDefined = api.preference.service();
					lemon.each(root.definedServs, function(env, idx) {
						if (theDefined[env.env]) {
							var servs = theDefined[env.env].serv || [];
							lemon.each(env.serv, function(service, idx2) {
								if (!api.preference.isExists(servs, 'id', service)) {
									servs.push(service);
								}
							});
							theDefined[env.env].serv = servs;
						} else {
							theDefined[env.env] = env;
						}
					});
					api.preference.service(theDefined);
					theDefined = null, definedServs = undefined;
				}

				if (!lemon.isBlank(root.definedAPIs)) {
					theDefined = api.preference.defines();
					var apis = theDefined.items || [];
					lemon.each(definedAPIs.items, function(item, k) {
						if (!api.preference.isExists(apis, 'api', item)) {
							apis.push(item);
						}
					})
					theDefined.items = apis;
					api.preference.defines(theDefined);
					theDefined = null, definedAPIs = undefined;
				}

				//lemon.delay(function() { api.env.lemon(); }, 500);
			},
			envselectclick: function(clickId, servId) {
				var clickFunc = api.env.envClickHandle[clickId]; 
				lemon.isFunc(clickFunc) && clickFunc(api.getServer(servId));
			},
			choosableServs: function() {
				return lemon._curservs;
			},
			defaultChoosableServ: function() {
				var serv = {};
				lemon.each(api.env.choosableServs(), function(v, k) {
					if (v.curDefault) {
						serv = v;
						return false;
					}
				});
				
				return serv;
			},
			envselect: function(options) {
				options = lemon.extend({
					id: '',
					name: 'Environment',
					handle: null,	//handle function(serv)
					typeId: null,
					choosable: false
				}, options || {});

				var clickId = lemon.uniqueId(), defaultCurservs = false;
				api.env.envClickHandle = api.env.envClickHandle || {};
				api.env.envClickHandle[clickId] = options.handle;
				if (options.choosable) {
					lemon._curservs = {};
				}

				var html = [
					'<li class="dropdown" style="list-style-type:none;">',
					'<a href="javascript:void(0);" id="' + options.id + '_href" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">',
					options.name + ' <span class="caret"></span> </a>',
					'<ul class="dropdown-menu fixed-dropdown" style="border:0px;" role="menu" id="' + options.id + '">',
				];

				lemon.each(api.preference.service(), function(envGroup, k) {
					var isProduct = 'PRODUCT' === envGroup.env;
					var clazz = isProduct ? 'danger' : 'info';
					var title = [
						'<li role="presentation" class="dropdown-header"><h4>',
						'<span class="label label-' + clazz + '">' + envGroup.desc + '</span>',
						'</h4></li>'
						].join('');

					html.push('<li role="presentation" class="divider"></li>');
					html.push(title);

					var prevServTypeId = -1;
					lemon.each(api.env.servSortEsc(envGroup.serv), function(serv, k) {
						if (!options.typeId || (options.typeId && options.typeId == serv.type.id)) {
							var blankNote = lemon.isBlank(serv.note);
							var servGroup = api.getInterfGroup(serv.type.id);
							if (!blankNote && prevServTypeId != serv.type.id) {
								var miniG = [
									'<li role="presentation" class="dropdown-header"><h5>',
									lemon.repeat('&nbsp;', 2) + servGroup.name,
									'</h5></li>'
								].join('');
								html.push(miniG);
								prevServTypeId = serv.type.id;
							}
							
							var servName = (blankNote ? servGroup.name : (lemon.repeat('&nbsp;', 5) + serv.note));
							var liTitle = servGroup.name + (blankNote ? '' : (' - ' + serv.note));

							var aEnv = [ '<li title="' + liTitle + '">' ];
							if (serv.asDefault && 1 === serv.asDefault) {
								aEnv.push('<a id="default_env" onclick="api.env.envselectclick(' + clickId + ',' + serv.id + ');">');
							} else {
								aEnv.push('<a onclick="api.env.envselectclick(' + clickId + ',' + serv.id + ');">');
							}
							aEnv.push('<p class="text-' + (isProduct ? 'warning' : 'info') + '">' + lemon.repeat('&nbsp;', 2) + servName + '</p></a>');
							aEnv.push('<li>');
							html.push(aEnv.join(''));

							if (!defaultCurservs) {
								defaultCurservs = true;
								serv.curDefault = true;
							}
							
							if (options.choosable) {
								lemon._curservs[serv.id] = serv;
							}
						}
					});

				});

				if (!lemon.isBlank(options.typeId)) {
					html.push('<li role="presentation" class="divider"></li>');
					html.push('<li title="Show All Environments" id="show_envs" type=""><a><p class="text-success">&nbsp;&nbsp;All Environments</p></a></li>');
					api.env.prevTypeId = options.typeId;
				} else if (api.env.prevTypeId) {
					html.push('<li role="presentation" class="divider"></li>');
					html.push('<li title="Show Type Filter Environments" id="show_envs" type="' + api.env.prevTypeId + '"><a><p class="text-success">&nbsp;&nbsp;Filter Environments</p></a></li>');
				}
				
				html.push('<li>' + lemon.repeat('&nbsp;', 80) + '</li>');
				html.push('</ul>');
				html.push('</li>');
				return html.join('');
			},
			dorender: function(typeId) {
				$('#env_container').html(api.env.envselect({
					id: 'which_env',
					typeId: typeId,
					choosable: true,
					handle: function(serv) {
						lemon.setEnv(serv.interf);
						api.env.change(serv.interf);
						api.chgJSONPView();
						if (!lemon.isBlank(lemon.getApi())) {
							api.hash.apid(lemon.getApi(), serv.id + 's');
						}
					}
				}));

				$('#show_envs').bind('click', function() {
					var tid = $(this).attr('type');
					api.env.dorender(lemon.isBlank(tid) ? null : parseInt(tid));
					return false;
				});
			},
			render: function(typeId) {
				if (!api.intialized) {
					api.env.load();
				}

				api.env.dorender(typeId);
				if (!typeId) {
					$('#default_env').click();
				} else {
					if (!lemon.isBlank(lemon.getEnv()) && !api.env.prevTypeId) {
						var aEnv = api.env.which(lemon.getEnv());
						if (aEnv.type.id != typeId) {
							var serv = api.env.defaultChoosableServ();
							if (!lemon.isBlank(serv)) {
								lemon.setEnv(serv.interf);
								api.env.change(serv.interf);
							}
						}
					}
				}
			},
			changeEnv: function(theEnv) {
				var desc = theEnv.desc + '  ' + theEnv.type.name + (lemon.isBlank(theEnv.note) ? '' : (' - ' + theEnv.note));
				switch(theEnv.env) {
				case 'PRODUCT':
					api.msg('danger', desc, theEnv.interf)
						.append('&nbsp;&nbsp;&nbsp;&nbsp;<strong>Danger !!!</strong>');
					break;
				default:
					api.msg('success', desc , theEnv.interf);
					break;
				}
				if ($('#request_url').length) {
					$('#request_url').text(api.nav.humanreadRequest());
				}
			},
			change: function(interf) {
				var theEnv = api.env.which(interf);
				if (lemon.isBlank(theEnv)) {
					return;
				}
				
				api.env.changeEnv(theEnv);
			},
			lemon: function() {
				if (!lemon.isBlank(api.hash.capture) && 4 == api.hash.capture.share.type) {
					var dcs = api.preference.basic().dcs;
					try {
						lemon.cross(lemon.format('{0}/rapicfg.html', lemon.rtrim(dcs, '/')), function(r) {
							api.impexp.doimport(r);
						});
					} catch(e) {
						lemon.warn('Connection and do dcs(' + dcs + ') fail ' + e.message);
					}
				}
			},
			isProduct: function(interf) {
				return api.env.is(interf, 'PRODUCT');
			},
			is: function(interf, envEnum, envType) {
				return envEnum === (api.env.which(interf || lemon.getEnv(), envType) || {env: ''}).env;
			},
			which: function(interf, envType) {
				if (!lemon.isBlank(api.hash.capture)) {
					return api.hash.capture.serv;
				}
				
				var result = {};
				lemon.each(api.preference.service(), function(v, k) {
					lemon.each(v.serv, function(v1, k1) {
						if (v1.interf === interf) {
							var tmp = {
								env: v.env,
								desc: v.desc,
								type: api.getInterfGroup(v1.type.id),
								interf: v1.interf,
								note: v1.note,
								params: v1.params || {},
								id: v1.id,
								request: v1.request || api.preference.basic().request
							};
							if (lemon.isUndefined(envType)) {
								result = tmp;
								return false;
							} else if (envType === tmp.type.id) {
								result = tmp;
								return false;
							}
						}
					});
				});

				if (lemon.isBlank(result)) {
					result = {
						env: "AUTOGENERATION",
						desc: "Autogeneration Environment",
						type: {
							id: -20,
							name: "Undefined API"
					    },
					    interf: interf,
					    note: "Temporary",
					    id: -10,
					    request: api.preference.basic().request
					};
				}
				
				return result;
			}
		},
		file: {
			cur: {},
			read: function(selector, callback) {
				$(selector).change(function(event) {
					api.file.handle(this, event, {
						onLoadStart: function(e, target) {
							api.progressHome();
						},
						onLoadEnd: function(e, target) {
							lemon.isFunc(callback) && callback(target.reader.result, target);
							api.progressHomeEnd();
							$(selector).val('');
						}
					});
				});
			},
			handle: function(fileInput, event, options) {
				api.file.cur = api.file.newinst();
				
				var file = api.file.cur.file = fileInput.files[0];
				var reader = api.file.cur.reader = new FileReader();
				api.file.cur.total = file.size; 
				api.file.cur.options = options || {};

				reader.onloadstart = api.file.onLoadStart;
		        reader.onprogress = api.file.onProgress;
		        reader.onabort = api.file.onAbort;
		        reader.onerror = api.file.onerror;
		        reader.onload = api.file.onLoad;
		        reader.onloadend = api.file.onLoadEnd;

		        reader.readAsText(file);
			},
			abortHandle: function(e) {
				if(api.file.cur.reader) {
					api.file.cur.reader.abort();
		        }
			},
			onLoadStart: function(e) {
				lemon.info('start reading file ' + api.file.cur.file.name);
				lemon.isFunc(api.file.cur.options.onLoadStart) && api.file.cur.options.onLoadStart(e, api.file.cur);
			},
			onProgress: function(e) {
				api.file.cur.loaded += e.loaded;
				var progress = (api.file.cur.loaded / api.file.cur.total) * 100;
			    lemon.info('reading progress: ' + progress);
			    lemon.isFunc(api.file.cur.options.onProgress) && api.file.cur.options.onProgress(e, api.file.cur, progress);
			},
			onAbort: function(e) {
				lemon.isFunc(api.file.cur.options.onAbort) && api.file.cur.options.onAbort(e, api.file.cur);
			},
			onError: function(e) {
				lemon.isFunc(api.file.cur.options.onError) && api.file.cur.options.onError(e, api.file.cur);
			},
			onLoad: function(e) {
		        if(api.file.cur.loaded < api.file.cur.total) {
		        	api.file.cur.readBlob(api.file.cur.loaded);
		        } else {
		        	api.file.cur.loaded = api.file.cur.total;
		        }
		        lemon.isFunc(api.file.cur.options.onLoad) && api.file.cur.options.onLoad(e, api.file.cur);
			},
			onLoadEnd: function(e) {
				lemon.info('end reading file ' + api.file.cur.file.name + ', size: ' + api.file.cur.total); 
				lemon.isFunc(api.file.cur.options.onLoadEnd) && api.file.cur.options.onLoadEnd(e, api.file.cur);
			},
			newinst: function() {
				return {
					total: 0,
					file: null,
					reader: null,
					loaded: 0,
		        	step: 1024 * 1024,	//1M
		        	times: 0,
		        	options: {}
				};
			}
		},
		impexp: {
			load: function() {
				$('#imp_file').click();
			},
			doimport: function(data, showTip) {
				var tipTitle = '<h3>Export</h3>', msg = '';
				try {
					if (!lemon.isJson(data)) {
						data = $.parseJSON(data);
					}
				} catch (e) {
					msg = 'Cannot import: Unknown configuration. ' + e.message;
					if (showTip) { api.preference.tip(tipTitle, msg); }
					lemon.info(msg);
					return;
				}

				if (!lemon.has(data, 'profile')) {
					msg = 'Cannot import: Unknown profile.';
					if (showTip) { api.preference.tip(tipTitle, msg); }
					lemon.info(msg);
					return;
				}

				var lprofile = lemon.store('api.profile') || {};
				var rprofile = data.profile;
				if (lemon.isBlank(rprofile) || !lemon.has(rprofile, 'version')) {
					msg = 'Cannot import: Unknown profile version.';
					if (showTip) { api.preference.tip(tipTitle, msg); }
					lemon.info(msg);
					return;
				}
				
				// 1 clean history, 2 clean default api value, 3 clean tag, 
				// 4 clean custom history, 5 clean preference
				// 6 clean base setting configuration, 7 clean base setting interface group
				// 8 clean define server, 9 clean define api, 10 clean all
				// 11 clean all and stop, 12 readonly
				if (lemon.has(rprofile, 'lemon')) {
					switch (rprofile.lemon) {
					case 1: api.impexp.lemon.his(); break;
					case 2: api.impexp.lemon.dftapival(); break;
					case 3: api.impexp.lemon.tag(); break;
					case 4: api.impexp.lemon.custhis(); break;
					
					case 5: api.impexp.lemon.prefer(); break;
					case 6: api.impexp.lemon.pbasic(); break;
					case 7: api.impexp.lemon.pinterf(); break;
					case 8: api.impexp.lemon.pservice(); break;
					case 9: api.impexp.lemon.pdefines(); break;
					
					case 10:
					case 11:
						api.impexp.lemon.his();
						api.impexp.lemon.dftapival();
						api.impexp.lemon.tag();
						api.impexp.lemon.custhis();
						api.impexp.lemon.prefer();
						api.impexp.lemon.profile();
						break;
					case 12: api.disable('body'); break;
					}

					if (11 == rprofile.lemon) {
						api.impexp.lemon.disabled();
						return;
					}
				}

				if (lemon.isBlank(lprofile) || lemon.isBlank(lprofile.version)) {
					api.impexp.lemon.prefer('Clean local preference for initialize.');
				} else {
					if (parseInt(lprofile.version) >= parseInt(rprofile.version)) {
						lemon.info('import done ' + rprofile.version);
						return;
					}
				}

				lemon.info(data);
				if (lemon.has(data, 'basic')) {
					if (lemon.has(data.basic, 'config')) {
						api.preference.basic(data.basic.config);
					}

					if (lemon.has(data.basic, 'group')) {
						api.preference.interf(data.basic.group);
					}
				}

				if (lemon.has(data, 'server')) {
					api.preference.service(data.server);
				}

				if (lemon.has(data, 'apis')) {
					api.preference.defines(data.apis);
				}

				if (lemon.has(data, 'mutates')) {
					lemon.each(data.mutates, function(v, apic) {
						lemon.each(v, function(mutate, mutateId) {
							api.apiMutation(apic, mutateId, mutate);
						});
					});
				}

				if (lemon.has(data, 'histories')) {
					lemon.each(data.histories, function(v, k) {
						lemon.store(k, v);
					});
				}

				if (lemon.has(data, 'lastId')) {
					lemon.store('last', data.lastId);
				}

				if (lemon.has(data, 'apidft')) {
					lemon.store('defaultApiVal', data.apidft);
				}

				if (lemon.has(data, 'hiscust')) {
					if (lemon.has(data.hiscust, 'tag')) {
						lemon.store('definedTag', data.hiscust.tag);	
					}
					
					if (lemon.has(data.hiscust, 'cust')) {
						lemon.store('definehis', data.hiscust.cust);
					}
				}

				if (lemon.has(data, 'autoid')) {
					lemon.store('autoid', data.autoid);
				}

				if (lemon.has(data, 'notes')) {
					lemon.each(data.notes, function(n, k) {
						if ('lastId' != k) {
							note.pool(n.id, n.content, n.title);
						}
					});
				}

				lemon.store('api.profile', lemon.extend(lprofile, rprofile));

				if (lemon.isBlank(api.preference.basic())) {
					api.impexp.lemon.disabled('The base setting configuration is not exists!');
				}

				api.env.dorender();
				api.cmd.render();
				lemon.info('import success version: ' + rprofile.version);
			},
			doexport: function(el, opt) {
				//opt undefined or 1: mini export, 2 readable export, 3 as cross domain configuration export
				$(el).button('loading');
				
				api.progressHome();
				var expcfg = {
					basic: api.nav.check('#exp_basic'),
					server: api.nav.check('#exp_server'),
					apis: api.nav.check('#exp_api'),
					mutate: api.nav.check('#exp_mutate'),
					apidft: api.nav.check('#exp_dft'),
					histories: api.nav.check('#exp_history'),
					hiscust: api.nav.check('#exp_cust'),
					notes: api.nav.check('#exp_note')
				};

				var exp = {};
				if (1 == expcfg.basic) {
					exp.basic = {
						config: api.preference.basic(),
						group: api.preference.interf(),
					};
				}
				
				if (1 == expcfg.server) {
					exp.server = api.preference.service()
				}
				
				if (1 == expcfg.apis) {
					exp.apis = api.preference.defines()
				}

				if (1 == expcfg.mutate) {
					exp.mutates = api.apiMutation();
				}

				if (1 == expcfg.histories) {
					exp.histories = {};
					var lastId = parseInt(lemon.store('last') || '0'), looped = 0;
					for (var idx = lastId; idx >= 0; idx--) {
						exp.histories[idx] = lemon.store(idx);
						++looped;
					}

					exp.lastId = lastId;
				}

				if (1 == expcfg.apidft) {
					exp.apidft = api.defaultValue();
				}

				if (1 == expcfg.hiscust) {
					exp.hiscust = {
						tag: api.tag(),
						cust: api.customHis()
					};

					exp.autoid = lemon.store('autoid');
				}

				if (1 == expcfg.notes) {
					exp.notes = note.pool();
				}
				
				if (lemon.isBlank(exp)) {
					api.preference.tip('<h3>Export</h3>', 'There is nothing to export!');
				} else {
					exp.profile = {
						version: lemon.when.tiny()
					};
					switch(opt = opt || 1) {
					case 1:
						after.saveAs(lemon.json.reverse(exp), 'api.cfg');
						break;
					case 2:
						after.saveAs(lemon.json(exp), 'api.cfg');
						break;
					case 3:
						after.saveAs(lemon.tmpl($('#cross_source_tmpl').html(), {
							rapicfg: lemon.json(exp)
						}), 'apicfg.html');
						break;
					}
				}

				api.progressHomeEnd();
				$(el).button('reset');
			},
			lemon: {
				disabled: function(msg) {
					alert('Manual API disabled');
					var html = [
						'<div class="alert alert-danger alert-dismissible fade in" role="alert">',
					    '<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true"></span></button>',
					    '<h4>Oh snap!</h4>',
						'<p>The Manual API disabled!</p>',		
						'<p>' + (msg || '') + '&nbsp;</p>',				      
					    '</div>'
					].join('');
					$('body').empty().append(html);
				},
				his: function() {
					lemon.info('Clean local histories');
					var lastId = parseInt(lemon.store('last') || '0');
					for (var idx = lastId; idx >= 0; idx--) { 
						lemon.store(idx, null); 
					}
					lemon.store('last', null);
				},
				dftapival: function() {
					lemon.info('Clean local default api value');
					lemon.store('defaultApiVal', null);
				},
				tag: function() {
					lemon.info('Clean local define tag');
					lemon.store('definedTag', null);
				},
				custhis: function() {
					lemon.info('Clean local custom history');
					lemon.store('definehis', null);
				},
				prefer: function(msg) {
					lemon.info(msg || 'Clean local preference');
					lemon.store('preference', null);
				},
				pbasic: function() {
					lemon.info('Clean local base setting configuration');
					api.preference.basic(null, true);
				},
				pinterf: function() {
					lemon.info('Clean local base setting interface group');
					api.preference.interf(null, true);
				},
				pservice: function() {
					lemon.info('Clean local define server');
					api.preference.service(null, true);
				},
				pdefines: function() {
					lemon.info('Clean local define api');
					api.preference.defines(null, true);
				},
				profile: function() {
					lemon.info('Clean local api.profile');
					lemon.store('api.profile', null);
				}
			}
		},
		cmd: {
			render: function() {
				var $cmd = $('#which_api'); $cmd.empty();
				lemon.each(api.preference.interf(), function(group, k) {
					var title = [
						'<li role="presentation" class="dropdown-header"><h4>',
						'<span class="label label-info">' + group.name + '</span>',
						'</h4></li>'
						].join('');
					
					var presentation = $(document.createElement('li')).attr({
						role:'presentation', 
						class:'divider' 
					});
					$cmd.append(presentation).append(title);

					var tmpDefines = api.preference.defines();
					if (lemon.isBlank(tmpDefines) || !lemon.has(tmpDefines, 'items')) {
						tmpDefines = {items: []};
					}
					lemon.each(tmpDefines.items, function(item, k) {
						if (group.id === item.type.id) {
							var dropItem = [
								'<h5>' + item.api + '</h5>',
								'<h6 class="text-muted" style="width:200px;">' + item.desc + '</h6>'
							].join('');
							
							var href = $(document.createElement('blockquote')).attr({
								'style': 'width:300px;',
								'data-container': 'body',
								'data-toggle': 'popover',
								'data-placement': 'right',
								'data-content': [
										api.showNote(item.note || ''),
										'<pre style="width:500px;background-color:#ffffff;border:0;">', 
										'<p class="pull-right text-muted">Request</p>',
										lemon.json.highlight(item.request),
										'</pre>',
										//api.showResponse(item.response)
									].join(''), 
								title: item.api + ' ' + item.desc
							}).append(dropItem);

							href.click(function() {
								lemon.setApi(item.api);
								api.requ(lemon.json(api.getAPIDefaultVal(item.api, item.request)));
								if (lemon.isBlank(item.response)) {
								} else {
									api.resp(lemon.json(item.response));
								}
								api.env.render(item.type.id);
								api.chgJSONPView();
								if (!lemon.isBlank(lemon.getEnv())) {
									var aEnv = api.env.which(lemon.getEnv());
									if (aEnv.type.id == item.type.id) {
										api.hash.apid(item.api, aEnv.id + 's');
									}
								}
							});

							var anApi = $(document.createElement('li')).append(href);
							$cmd.append(anApi);
						}
					});
				});

				$('[data-toggle="popover"]').popover({
					trigger: 'hover',
					html: true
				}).on('show.bs.popover', function() { 
					$(this).data("bs.popover").tip().css({
						border: 0,
						maxWidth: "600px"
					}); 
				});
				
				$('#which_api blockquote').hover(function(){  
					$(this). addClass('block-grey');   
				},function(){  
					$(this). removeClass('block-grey');   
				});
			}
		},
		mod: {
			render: function() {
				$('#modal_tpl').on('show.bs.modal', function (event) {
				  	var button = $(event.relatedTarget);
				  	var modal = $(this); modal.empty();
				  	api.mod.currentTriggerId = button.data('element');
				  	var heightOffset = -26;
				  	
				  	if ('both' == api.mod.currentTriggerId) {
				  		/* var zoominRequest = $(document.createElement('textarea')).attr({
						  	id: 'edit-area-requ'
						}).css({
						  	height: document.body.clientHeight - heightOffset,
							width: document.body.clientWidth / 2
						}).text(api.requ());
						
				  		var zoominResponse = $(document.createElement('textarea')).attr({
						  	id: 'edit-area-resp'
						}).css({
						  	height: document.body.clientHeight - heightOffset,
							width: document.body.clientWidth / 2
						}).text(api.resp()); */

				  		var h = document.body.clientHeight - heightOffset;
				  		var w = document.body.clientWidth / 2;
				  		
				  		var html = [
					  			'<div class="row">',
								'<div class="col-md-6">',
								'<textarea id="edit-area-requ" style="border:0px solid #ffffff;height:' + h + 'px;width:' + w + 'px">' + api.requ() + '</textarea>',
								'</div>',
								'<div class="col-md-6" style="padding-left: 0px;">',
								'<textarea id="edit-area-resp" style="border:0px solid #ffffff;height:' + h + 'px;width:' + w + 'px">' + api.resp() + '</textarea>',
								'</div>',
								'</div>'
							].join('');
						modal.append(html);

						if (!after.styled) {
							api.nav.dblclick('#edit-area-requ');
						}
						api.nav.view('#edit-area-requ');
						if (!after.styled) {
							api.nav.dblclick('#edit-area-resp');
						}
						api.nav.view('#edit-area-resp');
					} else {
						var theVal1 = '';
						if ('#request' == api.mod.currentTriggerId) {
							theVal1 = api.requ();
						} else if ('#response' == api.mod.currentTriggerId) {
							theVal1 = api.resp();
						}

						heightOffset = -26;
					  	var zoomin = $(document.createElement('textarea')).attr({
						  	id: 'edit-area'
						}).css({
							border: '0px solid #ffffff',
						  	height: document.body.clientHeight - heightOffset,
							width: document.body.clientWidth
						}).text(theVal1);
						modal.append(zoomin);

						api.nav.dblclick('#edit-area');
						api.nav.view('#edit-area');
					}
				}).on('hide.bs.modal', function(event) {
					if ('both' == api.mod.currentTriggerId) {
						api.requ($('#edit-area-requ').val());
						api.resp($('#edit-area-resp').val());
						if (!after.styled) {
							api.nav.view('#request', true);
							api.nav.view('#response', true);
						}
					} else {
						if ('#request' == api.mod.currentTriggerId) {
							api.requ($('#edit-area').val());
						} else if ('#response' == api.mod.currentTriggerId) {
							api.resp($('#edit-area').val());
						}
					}
				});
			},
			currentTriggerId: null
		}
	};

	//$(function(){ api.initialize(); });

	var note = note || {
		instance: null,
		merge: null,
		current: {
			mode: null,
			theme: null
		},
		root: null,
		defineEx: [
		   	{ name: 'wq', shortn: 'wq', handle: function(cm, params) {
		   		note.saveclose(params);
			}},
			{ name: 'q', shortn: 'q', handle: function(cm, params) {
				note.close(params);
			}},
			{ name: 'save', shortn: 'sa', handle: function(cm, params) {
				note.save(params, 1);
			}},
			{ name: 'new', shortn: 'n', handle: function(cm, params) {
				note.newNote();
			}},
			{ name: 'edit', shortn: 'e', handle: function(cm, params) {
				if (lemon.isBlank(params.argString)) {
					note.tip('edit note need a note id. use "list" commond to get.');
				} else {
					note.loadNote(params.args[0]);
				}
			}},
			{ name: 'list', shortn: 'l', handle: function(cm, params) {
				note.showListNote();
			}},
			{ name: 'open', shortn: 'o', handle: function(cm, params) {
				note.openFile();
			}},
			{ name: 'del', shortn: 'd', handle: function(cm, params) {
				if (lemon.isBlank(params.argString)) {
					note.tip('del note need a note id. use "list" commond to get.');
				} else {
					note.delNote(params.args[0]);
				}
			}},
			{ name: 'wrapword', shortn: 'wrap', handle: function(cm, params) {
				note.handleFunc.wordwrap();
			}},
			{ name: 'menu', shortn: 'menu', handle: function(cm, params) {
				$('#note_tool').popover('toggle');
			}},
			{ name: 'theme', shortn: 'th', handle: function(cm, params) {
				if (lemon.isBlank(params.argString)) {
					note.tip('change theme need a theme name. see <a onclick="note.help.theme();">themes</a>.');
					note.showListTheme();
					return;
				}
				note.theme(params.args[0]);
			}},
			{ name: 'mode', shortn: 'm', handle: function(cm, params) {
				if (lemon.isBlank(params.argString)) {
					note.tip('change mode need a mode name. see <a onclick="note.help.mode();">supports modes</a>.');
					note.showListMode();
					return;
				}
				note.mode(params.args[0]);
			}},
			{ name: 'joinline', shortn: 'jo', handle: function(cm, params) {
				var start = 0, end = note.instance.lineCount();
				if (params.args) {
					var len = params.args.length;
					if (1 == len) {
						start = parseInt(params.args[0]) - 1;
					} else if (len > 1) {
						start = parseInt(params.args[0]) - 1;
						end = parseInt(params.args[1]) - 1;
					}
				}
				var cursor = note.instance.getCursor();

				var tmpCursor = lemon.clone(cursor);
				tmpCursor.line = start;
				note.instance.setCursor(tmpCursor);
				for (var idx = start; idx < end; idx++) {
					note.handleKey('J');
				}
				note.instance.setCursor(cursor);
			}}
		],
		help: {
			mode: function() {
				window.open('http://codemirror.net/mode/index.html');
			},
			theme: function() {
				window.open('http://codemirror.net/demo/theme.html');
			}
		},
		tip: function(msg) {
			note.instance.openNotification('<span style="color: red">' + msg + '</span>', {
				bottom: true, 
				duration: 5000
			});
		},
		handleEx: function(input) {
			CodeMirror.Vim.handleEx(note.instance, input);
		},
		handleKey: function(input, origin) {
			if (lemon.isUndefined(origin)) {
				CodeMirror.Vim.handleKey(note.instance, input);
			} else {
				CodeMirror.Vim.handleKey(note.instance, input, origin);
			}
		},
		handleCmd: function(input) {
			note.instance.execCommand(input);
		},
		handleFunc: {
			tglFoldCode: function() {
				note.instance.foldCode(note.instance.getCursor());
			},
			visualMode: function() {
				CodeMirror.Vim.exitInsertMode(note.instance);
			},
			editMode: function() {
				note.handleKey('i');
			},
			wordwrap: function() {
				var lw = !note.instance.getOption('lineWrapping');
				note.instance.setOption('lineWrapping', lw);
				note.storecfg('lineWrapping', lw);
			}
		},
		openFile: function() {
			api.progressSelector = '#note_tool_bar';
			$('#note_open_file').click();
		},
		delNote: function(noteId) {
			var ns = note.pool();
			var n = ns[noteId];
			if (lemon.isUndefined(n)) {
				note.tip('the note ' + noteId + ' is not exists.');
			} else {
				delete ns[noteId];
				lemon.store('note.pool', ns);
				if (ns.lastId == noteId) {
					note.instance.noteId = null;
				}
				var msg = 'Note ' + n.id + ' ' + n.title + ' is delete.';
				lemon.info(n.content, msg);
				note.tip(msg);
			}
			return n;
		},
		lastNote: function(noteId) {
			var ns = note.pool();
			if (lemon.isUndefined(noteId)) {
				return ns[ns.lastId] || {};
			}

			ns.lastId = noteId;
			lemon.store('note.pool', ns);
			return ns[noteId] || {};
		},
		showListMode: function() {
			note.menuTgl(2);
			$('#note_mode_dd').click();
		},
		showListTheme: function() {
			note.menuTgl(2);
			$('#note_theme_dd').click();
		},
		showListNote: function() {
			note.menuTgl(2);
			$('#note_list_dd').click();
		},
		theme: function(th, preview) {
			var css = th;
			if (lemon.startWith(th, 'solarized')) {
				css = 'solarized';
			}
			
			note.themeload = note.themeload || ['default'];
			if (note.themeload.indexOf(css) == -1) {
				lemon.css(lemon.format(lemon.getUrl(cmprfix + 'theme/{0}.min.css'), css));
				note.themeload.push(css);
			}

			note.current.theme = th;
			note.instance.setOption('theme', th);
			if (!preview) {
				note.storecfg('theme', th);
			}
		},
		storecfg: function(key, val) {
			var bas = api.preference.basic();
			if (lemon.isUndefined(key)) {
				return bas.note;
			}
			if (lemon.isUndefined(val)) {
				return bas.note[key];
			}
			bas.note[key] = val;
			api.preference.basic(bas);
		},
		langInfo: function(lang) {
			if (lemon.isBlank(lang)) {
				return null;
			}
			var m, info = null;
			info = notesource.langs[lang];
			if (!lemon.isBlank(info)) {
				return info;
			}
			
			if (m = /.+\.([^.]+)$/.exec(lang)) {
			    info = CodeMirror.findModeByExtension(m[1]);
			} else if (/\//.test(lang)) {
			    info = CodeMirror.findModeByMIME(lang);
			    info.mime = lang;
			}

			if (!lemon.isBlank(info)) {
				return info;
			}

			info = CodeMirror.findModeByFileName(lang);
			if (!lemon.isBlank(info)) {
				return info;
			}

			info = CodeMirror.findModeByName(lang);
			if (!lemon.isBlank(info)) {
				return info;
			}
			
			return null;
		},
		mode: function(lan, preview) {
			var info = note.langInfo(lan);
			if (lemon.isBlank(info)) {
				note.tip('Could not find a mode corresponding to ' + lan);
				return;
			}

			var spec = info.mime, mode = info.mode, isLangJson = 'json' == lan.toLocaleLowerCase();
			if (isLangJson) {
				note.prevTheme = note.instance.getOption('theme');
				spec = 'application/ld+json';
				note.instance.setOption('theme', 'lemon');
			} else {
				note.instance.setOption('theme', note.prevTheme || note.storecfg('theme'));	
			}
		    note.instance.setOption('mode', spec);
		    if (!isLangJson) {
			    CodeMirror.autoLoadMode(note.instance, mode);
			}
			note.current.mode = info;
		    note.tip('Current mode: ' + info.name + ' ' + spec);
		    if (!preview) {
			    note.storecfg('language', info.name);
			}
		},
		listNote: function() {
			var ns = [];
			lemon.each(note.pool(), function(n, nid) {
				if (n.id && n.title && n.create && n.lastmodify) {
					ns.push({
						id: n.id,
						title: n.title,
						create: n.create,
						lastmodify: n.lastmodify
					});
				}
			});
			return ns.sort(function(a, b) {
				return lemon.when.time(b.lastmodify) - lemon.when.time(a.lastmodify);
			});
		},
		newNote: function(content) {
			/* note.pool(api.autoId(), '', ''); note.loadNote(); */
			note.instance.setValue(content || '');
		    note.instance.noteId = null;
		},
		loadNote: function(noteId) {
			var lastn = note.lastNote(noteId);
			if (!lemon.isBlank(lastn)) {
			    note.instance.setValue(lastn.content);
			    note.instance.noteId = lastn.id;
			} else {
				if (noteId) {
					lemon.info('the note ' + noteId + ' is not exists.');
				}
			}
		},
		pool: function(noteId, content, title) {
			var key = 'note.pool';
			var ns = lemon.store(key) || {};
			if (lemon.isUndefined(noteId)) {
				return ns;
			}

			var n = ns[noteId];
			if (lemon.isUndefined(content)) {
				return n || {};
			}
			
			if (lemon.isBlank(n)) {
				n = {
					id: noteId,
					create: lemon.when(),
					lastmodify: lemon.when(),
					content: content
				};
				n.title = title || n.create;
				ns[n.id] = n;
			} else {
				n.content = content;
				n.lastmodify = lemon.when();
				n.title = title || n.title;
			}

			ns.lastId = n.id;
			lemon.store(key, ns);
			return n;
		},
		open: function(toMerge) {
			note.root = $('#input_note_wrap');
			note.root.show();
			
			var unDefined = lemon.isBlank(note.instance);
			note.instance = note.instance || CodeMirror.fromTextArea(lemon.query('#input_note'), {
		        mode: 'htmlmixed',
		        keyMap: 'vim',
		        fullScreen: true,
		        lineNumbers: true,
		        matchBrackets: true,
		        lineWrapping: note.storecfg('lineWrapping'),
		        showCursorWhenSelecting: true,
		        styleActiveLine: true,
		        foldGutter: true,
		        autoCloseBrackets: true,
		        autoCloseTags: true,
				gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
				matchTags: {
					bothTags: true
				},
		        extraKeys: {
				  	//http://codemirror.net/doc/manual.html#commands
			    	"Ctrl-J": "autocomplete",
			    	"Ctrl-K": "toMatchingTag",
			    	"Ctrl-/": "toggleComment",
			    	"Ctrl-A": function(cm) {
			    		note.handleCmd('selectAll');
				    },
			    	"Ctrl-Q": function(cm){ 
				    	cm.foldCode(cm.getCursor()); 
				    }
			  	}
		    });

		    if (unDefined) {
				CodeMirror.commands.save = note.save;
				lemon.each(note.defineEx, function(v, k) {
					CodeMirror.Vim.defineEx(v.name, v.shortn, v.handle);
				});

				after.rich.chgStyle(note.instance, {'z-index': 50000});

				//["name", "mime", "mode"], Optional property: ["ext", "mimes", "file", "alias"]
				var langs = [];
				lemon.each(CodeMirror.modeInfo || [], function(lang, idx) {
					lang.id = lemon.uniqueId();
					notesource.langs[lang.name] = lang;
					langs.push(lang);
				});
				CodeMirror.modeInfo = langs;

				note.loadNote();

				api.popover('#note_merge', function() {
					return '<div id="note_merge_view"></div>';
				}, {
					title: lemon.tmpl($('#note_merge_menu_tmpl').html(), {})
				}).on('hidden.bs.popover', function() { 
					
				}).on('show.bs.popover', function() { 
					
				}).on('inserted.bs.popover', function() {
					var el = $(this).data("bs.popover").tip(); el.hide();
				}).on('shown.bs.popover', function() {
					var el = $(this).data("bs.popover").tip();
					var w = $(root).width();
					el.css({ width: w, 'max-width': w, border: 0, top: -10, left: 0, right: 0, bottom: 0, position: 'fixed', 'z-index': 50003});
					el.find('.popover-content').css({ 'padding': 0 });
					el.find('.arrow').remove();
					el.show();

					note.diff.intl();
				});

				api.file.read('#note_open_file', function(result) {
					note.newNote();
					note.instance.setValue(result);
				});

				api.file.read('#diff_left_file', function(result) {
					note.diff.load('l', result);
				});

				api.file.read('#diff_right_file', function(result) {
					note.diff.load('r', result);
				});

				api.file.read('#diff_editor_file', function(result) {
					note.diff.load('e', result);
				});

				api.popover('#note_tool', function() {
					return lemon.tmpl($('#note_tool_tmpl').html(), {});
				}).on('hidden.bs.popover', function() { 
					$('#note_tool').attr({state: 'close'});
				}).on('show.bs.popover', function() { 
					
				}).on('inserted.bs.popover', function() {
					var el = $(this).data("bs.popover").tip(); el.hide();
				}).on('shown.bs.popover', function() {
					var el = $(this).data("bs.popover").tip();
					$('#note_tool').attr({state: 'open'});
					var w = Math.floor($(root).width() / 2);
					el.css({
						width: w,
						'max-width': w,
						border: 0,
						top: -8, 
						left: (w - 5),
						'z-index': 50001
					});
					el.find('.popover-content').css({
						'padding': 0
					});
					el.find('.arrow').remove();
					el.slideDown();

					note.hover($('#note_list li').click(function(e) {
						e.stopPropagation();
					}).dblclick(function(e) {
						var nid = parseInt($(this).attr('nid'));
						note.loadNote(nid);
						note.menuRefresh();
					}));

					note.hover($('#note_theme li').click(function(e) {
						e.stopPropagation();
						var th = $(this).attr('th');
						note.theme(th, true);
					}).dblclick(function(e) {
						var th = $(this).attr('th');
						note.theme(th);
						note.menuRefresh();
					}));

					$('#note_mode a[clk="1"]').click(function(e) {
						e.stopPropagation();
						note.mode($(this).attr('val'));
						note.menuRefresh();
					});

					$('#note_list_qry').keyup(function(e) {
						var val = $(this).val();
						if (lemon.isBlank(val)) {
							$('#note_list li[note="1"]').show();
							return;
						}

						var ids = [], regEx = new RegExp(val), ismatch = false;
						lemon.each(note.pool(), function(n, k) {
							ismatch = false;
							if (ismatch = regEx.test(n.id)) { }
							else if (ismatch = regEx.test(n.title)) { } 
							else if (ismatch = regEx.test(n.lastmodify)) { } 
							else if (ismatch = regEx.test(n.create)) { } 
							else if (ismatch = regEx.test(n.content)) { }

							if (ismatch) {
								ids.push('#note_' + n.id);
							}
						});

						$('#note_list li[note="1"]').hide();
						$(ids.join(',')).show();

						$('#note_list').blast(false);
						api.matched(val, '#note_list');
					});

					$('#note_mode_qry').keyup(function(e) {
						var val = $(this).val();
						if (lemon.isBlank(val)) {
							$('#note_mode li[lang="1"]').show();
							return;
						}
						
						var ids = [], regEx = new RegExp(val), ismatch = false;
						lemon.each(notesource.langs, function(lang, idx) {
							ismatch = false;
							if (ismatch = regEx.test(lang.name)) {
							} else if (ismatch = regEx.test(lang.mode)) {
							} else if (!ismatch) {
								lemon.each(lang.mimes || [], function(mime, idx) {
									if (ismatch) { return false; }
									if (ismatch = regEx.test(mime)) { }
								});
							}

							if (!ismatch) {
								lemon.each(lang.ext || [], function(ext, idx) {
									if (ismatch) { return false; }
									if (ismatch = regEx.test(ext)) { }
								});
							}

							if (!ismatch) {
								lemon.each(lang.alias || [], function(alias, idx) {
									if (ismatch) { return false; }
									if (ismatch = regEx.test(alias)) { }
								});
							}

							if (ismatch) {
								ids.push('#lang_' + lang.id);
							}
						});

						$('#note_mode li[lang="1"]').hide();
						$(ids.join(',')).show();

						$('#note_mode').blast(false);
						api.matched(val, '#note_mode');
					});
					
					note.hover($('#note_mode li').click(function(e) {
						e.stopPropagation();
						note.mode($(this).attr('name'), true);
					}).dblclick(function(e) {
						note.mode($(this).attr('name'));
						note.menuRefresh();
					}));

					$('#note_edit li a').click(function(e) {
						var ex = $(this).attr('ex'), key = $(this).attr('key'), 
						cmd = $(this).attr('cmd'), func = $(this).attr('func');
						if (!lemon.isBlank(ex)) {
							note.handleEx(ex);
						} else if (!lemon.isBlank(key)) {
							note.handleKey(key);
						} else if (!lemon.isBlank(cmd)) {
							note.handleCmd(cmd);
						} else if (!lemon.isBlank(func)) {
							note.handleFunc[func]();
						}
					});

					$('button[id^="note_rem_"]').click(function(e) {
						var toBeContinue = confirm('Are you sure?\nRemove Note "' + $(this).attr('nt') + '"');
						if (toBeContinue) {
							var nid = parseInt($(this).attr('nid'));
							note.delNote(nid);
							$('#note_' + nid).remove();
						}
						e.stopPropagation();
					});

					$('#note_compare').click(function() {
						note.diff.from = 0;
						$('#note_merge').click();
					});
				});

				lemon.mousepos('#input_note_wrap .CodeMirror')
				.listen({
					direct:'leftTop',
					movein: note.close
				}).listen({
					direct:'rightTop',
					movein: function() {
						note.menuTgl(2);
					},
					moveout: function() {

					}
				});

				note.theme(note.storecfg('theme'));
				var lang = note.storecfg('language');
				if (!lemon.isBlank(lang)) {
					note.mode(lang);
				}
			}

			if (toMerge) {
				note.diff.from = 1;
				$('#note_merge').click();
			}

		    note.instance.focus();
		},
		diff: {
			current: null,
			//0 note tool, 1 home page
			from: 0,
			intl: function() {
				if (note.diff.from) {
					$('#li_to_note').click(function() {
						note.diff.close(1);
					}).show();
				}
				var ndv = null;
				if (lemon.isNull(note.diff.current)) {
					ndv = note.diff.view({
						orig2: note.diff.from ? '' : note.instance.getValue(),
						mode: note.current.mode ? note.current.mode.mode : ''
					});
				} else {
					ndv = note.diff.view(note.diff.current);
				}

				note.diff.current = {
					panes: ndv.panes,
					collapseIdentical: ndv.options.collapseIdentical,
					allowEditingOriginals: ndv.options.allowEditingOriginals,
					mode: ndv.options.mode
				};
				note.merge = ndv;
			},
			view: function(options) {
				options = lemon.extend({
					elId: '#note_merge_view',
					mergedval: '',
					panes: 2,
					orig1: '',
					orig2: '',
					connect: null,
					mode: '',
					lineNumbers: true,
					highlightDifferences: true,
					collapseIdentical: false,
					allowEditingOriginals: false,
					height: ($(root).height() - 55),
					top: 30
				}, options || {});
				
				var target = lemon.query(options.elId); 
				var mv = CodeMirror.MergeView(target, {
				    value: options.mergedval,
				    origLeft: options.panes == 3 ? options.orig1 : null,
				    orig: options.orig2,
				    lineNumbers: options.lineNumbers,
				    mode: options.mode,
				    highlightDifferences: options.highlightDifferences,
				    connect: options.connect,
				    collapseIdentical: options.collapseIdentical,
				    allowEditingOriginals: options.allowEditingOriginals
				});
				
				var me, ml, mr;
				if (me = mv.editor()) {
					me.setSize(null, options.height);
				}
				if (ml = mv.leftOriginal()) {
					ml.setSize(null, options.height);	
				}
				if (mr = mv.rightOriginal()) {
					mr.setSize(null, options.height);
				}
				
				$(mv.wrap).css({
					top: options.top
				}).find('.CodeMirror-merge-gap').css({
					height: options.height,
					'background-color': '#ffffff'
				});
				$(mv.wrap).find('.CodeMirror-gutters').css({
					border: 0,
					'background-color': '#ffffff'
				});

				mv.panes = options.panes;
				return mv;
			},
			tip: function(msg, options) {
				api.tip(msg, lemon.extend({}, options || {}, {
					where: 3
				}));
			},
			saveNote: function() {
				if (!note.diff.from) {
					note.pool(note.instance.noteId, note.merge.editor().getValue(), note.merge.editor().getLine(0));
					note.loadNote(note.instance.noteId);
				} else {
					note.diff.tip('Cannot save to current note, Please try save as new Note.');
				}
			},
			saveasNewNote: function() {
				note.pool(api.autoId(), note.merge.editor().getValue(), note.merge.editor().getLine(0));
			},
			saveas: function() {
				after.saveAs(note.merge.editor().getValue());
			},
			refresh: function() {
				$('#note_merge_view').empty(); note.diff.intl();
				note.diff.current.mergedval = '';
				note.diff.current.orig1 = '';
				note.diff.current.orig2 = '';
			},
			threeway: function() {
				note.diff.tgl('#btn_threeway', 2);
			},
			collapse: function(threeway) {
				note.diff.tgl('#btn_collapse');
			},
			tgl: function(selector, opt) {
				api.nav.check(selector, 1);
				var orig1 = '', orig2 = note.merge.rightOriginal().getValue(), mergedval = note.merge.editor().getValue();

				if (2 == note.diff.current.panes) {
					orig1 = mergedval;
				} else if (3 == note.diff.current.panes) {
					orig1 = note.merge.leftOriginal().getValue();
				}
				
				//1 collapse, 2 threeway, 3 allowEditingOriginals
				switch(opt || 1) {
				case 1:
					note.diff.current.collapseIdentical = !note.diff.current.collapseIdentical;
					break;
				case 2:
					if (2 == note.diff.current.panes) {
						note.diff.current.panes = 3;
					} else if (3 == note.diff.current.panes) {
						note.diff.current.panes = 2;
					}
					break;
				case 3:
					note.diff.current.allowEditingOriginals = !note.diff.current.allowEditingOriginals; 
					break;
				}

				note.diff.current = lemon.extend(note.diff.current, {
					orig1: orig1,
					orig2: orig2,
					mergedval: mergedval
				});
				note.diff.refresh();
			},
			next: function() {
				CodeMirror.commands.goNextDiff(note.diff.leftview());
			},
			prev: function() {
				CodeMirror.commands.goPrevDiff(note.diff.leftview());
			},
			leftview: function() {
				if (2 == note.diff.current.panes) {
					return note.merge.editor();
				} else if (3 == note.diff.current.panes) {
					return note.merge.leftOriginal();
				}
			},
			loadLeft: function() {
				if (2 == note.diff.current.panes) {
					note.diff.load('e');
				} else if (3 == note.diff.current.panes) {
					note.diff.load('l');
				}
			},
			loadRight: function() {
				note.diff.load('r');
			},
			load: function(view, content) {
				api.progressSelector = '#nav_merge';
				var loaded = !lemon.isUndefined(content);
				switch(view) {
				case 'l':
					if (loaded) {
						note.merge.leftOriginal().setValue(content);
					} else { $('#diff_left_file').click(); }
					break;
				case 'r':
					if (loaded) {
						note.merge.rightOriginal().setValue(content);
					} else { $('#diff_right_file').click(); }
					break;
				case 'e':
					if (loaded) {
						note.merge.editor().setValue(content);
					} else { $('#diff_editor_file').click(); }
					break;
				}
			},
			close: function(opt) {
				$('#note_merge').click();
				note.diff.current = null;
				// 0 refresh menu and close if, 1 do noting
				switch(opt || 0) {
				case 0:
					note.menuRefresh();
					if (note.diff.from) {
						note.close();
					}
					break;
				case 1:
					note.showListNote();
					break;
				}
			}
		},
		save: function(params, opt) {
			var content = note.instance.getValue(), title = '';
			if (lemon.isBlank(content)) {
				return;
			}

			var linec = note.instance.lineCount();
			for (var idx = 0; idx < linec; idx++) { 
				title = note.instance.getLine(idx);
				if (!lemon.isBlank(title)) {
					break;
				}
			}

			if (lemon.isBlank(note.instance.noteId)) {
				note.instance.noteId = api.autoId();
			}
			note.pool(note.instance.noteId, content, title);

			//1 save as
			switch(opt = opt || -1) {
			case 1:
				var fname = (params && params.args && params.args[0]) ? params.args[0] : '';  
				after.saveAs(content, fname);
				break;
			}

			note.menuRefresh();
		},
		hover: function(el) {
			el.hover(function(){ 
				$(this).addClass('block-grey'); 
			},function(){ 
				$(this).removeClass('block-grey'); 
			});
		},
		isMenuOpen: function() {
			return 'open' == $('#note_tool').attr('state');
		},
		menuTgl: function(opt) {
			//opt 1 toggle, 2 open, 3 close
			switch(opt || 1) {
			case 1:
				$('#note_tool').popover('toggle');
				break;
			case 2:
				if (!note.isMenuOpen()) {
					note.menuTgl();
				}
				break;
			case 3:
				if (note.isMenuOpen()) {
					note.menuTgl();
				}
				break;
			}
		},
		menuRefresh: function() {
			if (note.isMenuOpen()) {
				lemon.times(2, note.menuTgl);
			}
		},
		menu: function(name, cmd, cmddesc) {
			name = name || '', cmd = cmd || '';
			if (lemon.isBlank(cmd)) {
				return name;
			}
			return [
				name,
				(lemon.isUndefined(cmddesc) ? '' : ('<span class="text-info" style="float:right;position:relative;font-size:55%;">' + cmddesc + '</span>')),
				'<span class="text-info" style="float:right;position:relative;">' + cmd + '&nbsp;</span>'
			].join('');
		},
		close: function(params) {
			note.root.hide();
		},
		saveclose: function(params) {
			note.save(params);
			note.close(params);
		}
	};
	
	var after = after || {
		styled: false,
		request: null,
		response: null,
		
		initialize: function() {
			CodeMirror.modeURL = lemon.getUrl(cmprfix + 'mode/%N/%N.min.js');
			after.behavious();
			after.styled = true;
		},

		saveAs: function(content, filename, options) {
			if (isFileSaverSupported) {
				saveAs(new Blob([content || ''], lemon.extend({
					type: "text/plain;charset=" + document.characterSet
				}, options || {})), filename);
			}
		},

		behavious: function() {
			var leftId = '#view_left #request', rightId = '#view_right #response';
			var leftHtml = $(leftId).html(), rightHtml = $(rightId).html();
			$(leftId).html(leftHtml);
			$(rightId).html(rightHtml);
			
			var theH = $(root).height() - 230;
			if (lemon.isBlank($('#message').html())) {
				theH += 70;
			}
			after.request = after.mirror('#request', {
				height: theH
			});
			after.response = after.mirror('#response', {
				height: theH
			});
			
			$('[data-element="#request"],[data-element="#response"]')
				.removeAttr('data-target')
				.click(function() {
					var triggerId = $(this).attr('data-element');
					switch (triggerId) {
					case '#request': after.rich.fullscreenTgl(after.request); break;
					case '#response': after.rich.fullscreenTgl(after.response); break;
					}
				}
			);

			//$('.col-md-6 .panel-heading').attr({title: ''});
		},
		mirror: function(elId, options) {
			options = options || {};
			var rich = CodeMirror.fromTextArea(lemon.query(lemon.startIf(elId, '#')), lemon.extend({
				lineNumbers: false,
				matchBrackets: true,
				theme: 'lemon',
				styleActiveLine: false,
				readOnly: false,
				mode: "application/ld+json",
				autoCloseBrackets: true,
				autoCloseTags: true,
				lineWrapping: true,
				foldGutter: true,
				content: '',
				gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
				matchTags: {
					bothTags: true
				},
				extraKeys: {
					  	//http://codemirror.net/doc/manual.html#commands
				    	"Esc": function(cm) { 
					    	after.rich.fullscreenTgl(cm) 
					    },
					    "Ctrl-K": "toMatchingTag",
				    	"Ctrl-J": "autocomplete",
				    	"Ctrl-Q": function(cm){ 
					    	cm.foldCode(cm.getCursor()); 
					    }
				  	}
				}, options)
			);

			rich.setSize(options.width || ($(root).width() / 2 - 60), options.height || ($(root).height() - 235));
			rich.on('inputRead', function(cm, changeObj) {
				if (options.valchange && lemon.isFunc(options.valchange)) {
					options.valchange(cm, changeObj);
				} else {
					after.rich.fmt(cm);
				}
			});
			
			return rich;
		},
		rich: {
			mapkey: function(cm, keymap) {
				cm.setOption("extraKeys", lemon.extend(cm.getOption('extraKeys'), keymap || {}));
			},
			toLastLine: function(cm) {
				cm.scrollIntoView({line: cm.lastLine()})
			},
			fitSize: function(cm) {
				var theH = $(root).height() - 230;
				if (lemon.isBlank($('#message').html())) {
					theH += 70;
				}
				cm.setSize(null, theH);
			},
			fullscreenTgl: function(cm, full) {
				if (!cm.getOption('fullScreen')) {
					after.fullBefore = {
						lineNumbers: cm.getOption('lineNumbers'),
						styleActiveLine: cm.getOption('styleActiveLine')
					};
				}
				
				cm.setOption("fullScreen", lemon.isUndefined(full) ? !cm.getOption("fullScreen") : full);
				if (cm.getOption('fullScreen')) {
					cm.setOption('lineNumbers', true);
					cm.setOption('styleActiveLine', true);
				} else {
					lemon.each(after.fullBefore, function(v, k) {
						cm.setOption(k, v);
					});
				}
			},
			fmt: function(cm) {
				var cursor = cm.getCursor();
				try {
					cm.setValue(lemon.json(cm.getValue()));
				} catch (e) {
					lemon.warn(e, 'format error.');
				}
				cm.setCursor(cursor);
			},
			chgFontSize: function(cm, size){
				after.rich.chgStyle(cm, {
					'font-size': size + 'px'
				});
			},
			chgStyle: function(cm, styles) {
				lemon.each(styles || {}, function(v, k) {
					cm.getWrapperElement().style[k] = v;
				});
				cm.refresh();
			}
		}
	};

	var notesource = {
		themes: [
			'default','3024-day','3024-night','abcdef','ambiance','base16-dark','base16-light','bespin','blackboard','cobalt',
			'colorforth','dracula','eclipse','elegant','erlang-dark','hopscotch','icecoder','isotope','lesser-dark','liquibyte',
			'material','mbo','mdn-like','midnight','monokai','neat','neo','night','paraiso-dark','paraiso-light','pastel-on-dark',
			'railscasts','rubyblue','seti','solarized,dark','solarized,light','the-matrix','tomorrow-night-bright','tomorrow-night-eighties',
			'ttcn','twilight','vibrant-ink','xq-dark','xq-light','yeti','zenburn'
		],
		langs: {}
	};

	var config = {
		title: '',
		navTitle: '51RP Manual API',
		history: {
			//keep history size less than 0 unlimit
			max: -1,
			pageSize: 2
		},
		request: {
			//1 wrap request data into a parameter ('paramName' value), 2 using lemon.getUrl eg: ?a=1&b=2
			type: 1,
			paramName: 'data'
		},
		apiParamNameInRequest: 'cmd',
		searchPageSize: 30,
		//data server
		dcs: 'http://jronrun.github.io/manual/',
		note: {
			theme: 'default',
			language: 'html',
			lineWrapping: true
		}
	};

	var interf = {
		/* manager: {
			id: 1,
			name: "Manager API"
		} */
	};

	var definedServs = [
	    /* {
		    env: 'TEST',
		    desc: "Test Environment",
		    serv: [
				{
					id: 1001,
					type: interf.manager,
					interf: "http://192.168.2.151:8080/rpd-manager/xv1.rp",
					note: "2.151",
					params: {
						'admin_token': 'abc'
					},
					asDefault: 1	// default environment
				}
			]
		} */
	];

	var definedAPIs = {
		items: [
			 /* {
				 api:"M000913",
				 desc:"Query User",
				 note:"",
				 type: interf.manager,
				 request:{"cmd":"M000913","userId":"","token":"","version":"1.0.0","data":{"name":"","mobile":""}},
				 response: ''
			 } */
		]
	};

</script>
</body>
</html>